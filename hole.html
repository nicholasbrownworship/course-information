<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Per-Hole Tracker – Local Golf Scorebook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --green: #244f3c;
      --green-dark: #163023;
      --gold: #d1a14b;
      --cream: #f5f0e6;
      --bg: #fcfaf6;
      --text: #222;
      --radius: 14px;
      --shadow: 0 8px 20px rgba(0,0,0,0.08);
      --muted: #6b7280;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #fdf7eb 0, #f3efe7 40%, #e7e1d3 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Page header */
    header {
      padding: 12px 16px;
      background: linear-gradient(120deg, var(--green-dark), var(--green));
      color: #fefcf5;
      box-shadow: 0 4px 16px rgba(0,0,0,0.25);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
    }

    header h1 {
      margin: 0;
      font-size: 1.3rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    header p {
      margin: 2px 0 0;
      font-size: 0.85rem;
      opacity: 0.9;
    }

    .main-nav {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .main-nav a {
      color: #1b2620;
      background: #fefcf5;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.8rem;
      text-decoration: none;
      border: 1px solid rgba(0,0,0,0.15);
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }

    .main-nav a:hover {
      background: #fff1c2;
    }

    main {
      flex: 1;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 260px minmax(0,1fr);
      gap: 8px;
      padding: 8px 10px 16px;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: rgba(252,249,242,0.97);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.04);
      padding: 10px 12px;
      backdrop-filter: blur(6px);
    }

    .panel h2 {
      margin: 0 0 6px;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--green-dark);
    }

    .muted {
      color: var(--muted);
      font-size: 0.85rem;
    }

    .error {
      color: #b91c1c;
      font-size: 0.85rem;
      margin-top: 6px;
    }

    label {
      font-size: 0.8rem;
    }

    select,
    input[type="number"],
    textarea {
      font-family: inherit;
      font-size: 0.8rem;
    }

    /* Left panel: course + round settings */
    .control-group {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .control-row {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .control-row select,
    .control-row input {
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.18);
      background: #fffbf4;
    }

    .pill {
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.04);
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    /* Right panel layout */
    .hole-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 8px;
      border-bottom: 1px solid rgba(0,0,0,0.12);
      padding-bottom: 6px;
      margin-bottom: 6px;
    }

    .hole-title {
      font-weight: 600;
      font-size: 1rem;
    }

    .hole-meta {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .hole-nav-buttons {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.18);
      padding: 4px 10px;
      font-size: 0.78rem;
      background: #fdf7ea;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-primary {
      background: #244f3c;
      color: #fefcf5;
      border-color: #1a3a2b;
    }

    .btn:hover {
      filter: brightness(0.98);
    }

    .hole-layout {
      display: grid;
      grid-template-columns: minmax(0,1.3fr) minmax(0,1fr);
      gap: 8px;
    }

    @media (max-width: 900px) {
      .hole-layout {
        grid-template-columns: 1fr;
      }
    }

    /* GPS / image area */
    .gps-card {
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #fffdf6;
      padding: 6px 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
      margin-bottom: 6px;
    }

    .gps-card h3 {
      margin: 0 0 4px;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--green-dark);
    }

    .gps-image-wrapper {
      border-radius: 8px;
      overflow: hidden;
      height: 240px;
      background: #d1d5db;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .gps-image-wrapper img {
      max-width: 100%;
      max-height: 100%;
      object-fit: cover;
      display: block;
    }

    .gps-meta {
      margin-top: 4px;
      font-size: 0.75rem;
      display: flex;
      justify-content: space-between;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }

    /* Flyover */
    .flyover-card {
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #fffdf6;
      padding: 6px 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
      margin-bottom: 6px;
    }

    .flyover-card h3 {
      margin: 0 0 4px;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--green-dark);
    }

    .flyover-area {
      font-size: 0.8rem;
      color: var(--muted);
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .flyover-area video {
      max-width: 100%;
      max-height: 220px;
      border-radius: 8px;
      background: #000;
    }

    /* Yardage & notes */
    .yardage-card,
    .caddy-card {
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #fffdf6;
      padding: 6px 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
      margin-bottom: 6px;
    }

    .yardage-card h3,
    .caddy-card h3 {
      margin: 0 0 4px;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--green-dark);
    }

    .yardage-list {
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .yardage-line {
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .caddy-body {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .caddy-body ul {
      padding-left: 18px;
      margin: 4px 0;
    }

    /* Shot stats card */
    .stats-card {
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #fffdf6;
      padding: 6px 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    }

    .stats-card h3 {
      margin: 0 0 4px;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--green-dark);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 6px;
      font-size: 0.8rem;
    }

    @media (max-width: 600px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    .stats-field {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .stats-field select,
    .stats-field input {
      padding: 3px 6px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.18);
      background: #fffbf4;
    }

    .stats-notes {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .stats-notes textarea {
      min-height: 60px;
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.18);
      background: #fffbf4;
      resize: vertical;
    }

    .stats-footer {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      font-size: 0.75rem;
      color: var(--muted);
    }

    .tee-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.15);
      margin-right: 4px;
      flex-shrink: 0;
    }

    .tee-label-line {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <h1>Per-Hole Tracker</h1>
      <p>Track shots and stats one hole at a time using your local course data.</p>
      <nav id="header-nav" class="main-nav"></nav>
    </div>
  </header>

  <main>
    <!-- LEFT PANEL: course / tee / round settings -->
    <section class="panel">
      <h2>Round Setup</h2>
      <p class="muted">
        Choose a course and tee, then use the per-hole controls to track your round.
      </p>

      <div class="control-group">
        <div class="control-row">
          <label for="courseSelect">Course</label>
          <select id="courseSelect">
            <option value="">Loading courses…</option>
          </select>
          <div id="courseError" class="error" style="display:none;"></div>
        </div>

        <div class="control-row">
          <label for="teeSelect">Tee</label>
          <select id="teeSelect">
            <option value="">—</option>
          </select>
        </div>

        <div class="control-row">
          <label for="startHoleInput">Start Hole</label>
          <input type="number" id="startHoleInput" min="1" value="1" />
        </div>

        <div class="control-row">
          <button type="button" class="btn" id="btnJumpToHole">Go to Hole</button>
        </div>

        <div class="control-row">
          <span class="pill" id="holeCountPill" style="display:none;"></span>
        </div>
      </div>
    </section>

    <!-- RIGHT PANEL: current hole UI -->
    <section class="panel">
      <div class="hole-header">
        <div>
          <div class="hole-title" id="holeTitle">No course selected</div>
          <div class="hole-meta" id="holeMeta"></div>
        </div>
        <div class="hole-nav-buttons">
          <button type="button" class="btn" id="btnPrevHole">&laquo; Previous Hole</button>
          <button type="button" class="btn btn-primary" id="btnSaveNextHole">Save &amp; Next Hole &raquo;</button>
        </div>
      </div>

      <div id="holeContent">
        <p class="muted">
          Select a course on the left to load its holes and begin tracking.
        </p>
      </div>
    </section>
  </main>

  <script>
    // ===== HEADER NAV (shared header.html) =====
    fetch("header.html")
      .then(function(res) {
        if (!res.ok) throw new Error("HTTP " + res.status);
        return res.text();
      })
      .then(function(html) {
        var slot = document.getElementById("header-nav");
        if (slot) slot.innerHTML = html;
      })
      .catch(function(err) {
        console.error("Failed to load header.html:", err);
      });

    // ===== DATA LOADING SETUP =====
    var COURSES_INDEX_PATH = "data/courses.json";

    function fetchJSON(path) {
      return fetch(path).then(function(res) {
        if (!res.ok) throw new Error("HTTP " + res.status + " for " + path);
        return res.json();
      });
    }

    var courseSelect = document.getElementById("courseSelect");
    var teeSelect = document.getElementById("teeSelect");
    var startHoleInput = document.getElementById("startHoleInput");
    var btnJumpToHole = document.getElementById("btnJumpToHole");
    var courseErrorEl = document.getElementById("courseError");
    var holeCountPill = document.getElementById("holeCountPill");

    var holeTitleEl = document.getElementById("holeTitle");
    var holeMetaEl = document.getElementById("holeMeta");
    var holeContentEl = document.getElementById("holeContent");
    var btnPrevHole = document.getElementById("btnPrevHole");
    var btnSaveNextHole = document.getElementById("btnSaveNextHole");

    var currentCourse = null;
    var currentHoles = [];
    var currentHoleNum = 1;
    var currentTees = [];

    function loadCoursesIndex() {
      courseSelect.innerHTML = "<option value=\"\">Loading courses…</option>";
      courseErrorEl.style.display = "none";
      fetchJSON(COURSES_INDEX_PATH)
        .then(function(courses) {
          if (!Array.isArray(courses) || !courses.length) {
            courseSelect.innerHTML = "<option value=\"\">No courses found</option>";
            return;
          }
          var html = "<option value=\"\">Select a course…</option>";
          courses.forEach(function(c) {
            html += "<option value=\"" + c.id + "\">" +
              (c.name || "Unnamed Course") + "</option>";
          });
          courseSelect.innerHTML = html;

          // Optional: auto-select first course
          // courseSelect.value = courses[0].id;
          // loadCourseById(courses[0].id);
        })
        .catch(function(err) {
          console.error("[courses] Failed to load index:", err);
          courseErrorEl.textContent = "Could not load " + COURSES_INDEX_PATH +
            " – " + err.message;
          courseErrorEl.style.display = "block";
          courseSelect.innerHTML = "<option value=\"\">Error loading courses</option>";
        });
    }

    function loadCourseById(courseId) {
      if (!courseId) {
        currentCourse = null;
        currentHoles = [];
        currentTees = [];
        currentHoleNum = 1;
        holeTitleEl.textContent = "No course selected";
        holeMetaEl.textContent = "";
        holeContentEl.innerHTML = "<p class=\"muted\">Select a course on the left to begin.</p>";
        teeSelect.innerHTML = "<option value=\"\">—</option>";
        holeCountPill.style.display = "none";
        return;
      }

      var basePath = "data/courses/" + courseId;
      var coursePath = basePath + "/course.json";
      var holesPath = basePath + "/holes.json";

      holeTitleEl.textContent = "Loading course…";
      holeMetaEl.textContent = "";
      holeContentEl.innerHTML = "<p class=\"muted\">Loading course and hole data…</p>";

      Promise.all([fetchJSON(coursePath), fetchJSON(holesPath)])
        .then(function(results) {
          currentCourse = results[0] || {};
          currentHoles = Array.isArray(results[1]) ? results[1] : [];
          currentTees = Array.isArray(currentCourse.tees) ? currentCourse.tees : [];

          // Fill tee select
          var teeHtml = "<option value=\"\">Any / Not set</option>";
          currentTees.forEach(function(t) {
            teeHtml += "<option value=\"" + t.id + "\">" +
              (t.name || t.id) + "</option>";
          });
          teeSelect.innerHTML = teeHtml;

          // Hole count pill
          var maxHole = 0;
          currentHoles.forEach(function(h, idx) {
            var num = h.hole || (idx + 1);
            if (num > maxHole) maxHole = num;
          });
          if (maxHole > 0) {
            holeCountPill.textContent = maxHole + " hole(s) loaded";
            holeCountPill.style.display = "inline-flex";
          } else {
            holeCountPill.style.display = "none";
          }

          currentHoleNum = 1;
          startHoleInput.value = 1;
          renderCurrentHole();
        })
        .catch(function(err) {
          console.error("[course] Failed to load course:", courseId, err);
          currentCourse = null;
          currentHoles = [];
          currentTees = [];
          holeTitleEl.textContent = "Error loading course";
          holeMetaEl.textContent = "";
          holeContentEl.innerHTML =
            "<p class=\"error\">Could not load <code>" + courseId +
            "</code>. Check <code>course.json</code> and <code>holes.json</code>.</p>";
          teeSelect.innerHTML = "<option value=\"\">—</option>";
          holeCountPill.style.display = "none";
        });
    }

    function getMaxHoleNumber() {
      var maxHole = 0;
      currentHoles.forEach(function(h, idx) {
        var num = h.hole || (idx + 1);
        if (num > maxHole) maxHole = num;
      });
      return maxHole;
    }

    function findHoleData(holeNum) {
      if (!Array.isArray(currentHoles)) return null;
      var found = null;
      currentHoles.forEach(function(h, idx) {
        var num = h.hole || (idx + 1);
        if (num === holeNum) found = h;
      });
      return found;
    }

    // ===== STATS STORAGE =====
    function statsStorageKey() {
      var id = (currentCourse && currentCourse.id) || courseSelect.value || "unknown";
      return "holeStats_" + id;
    }

    function loadStatsForCourse() {
      try {
        var raw = localStorage.getItem(statsStorageKey());
        if (!raw) return {};
        var obj = JSON.parse(raw);
        if (!obj || typeof obj !== "object") return {};
        return obj;
      } catch (e) {
        console.warn("[stats] failed to load", e);
        return {};
      }
    }

    function saveStatsForCourse(statsObj) {
      try {
        localStorage.setItem(statsStorageKey(), JSON.stringify(statsObj));
      } catch (e) {
        console.warn("[stats] failed to save", e);
      }
    }

    function loadStatsForHole(holeNum) {
      var all = loadStatsForCourse();
      return all[holeNum] || {};
    }

    function saveStatsForHole(holeNum, data) {
      var all = loadStatsForCourse();
      all[holeNum] = data;
      saveStatsForCourse(all);
    }

    // ===== RENDER & UI =====
    function renderCurrentHole() {
      if (!currentCourse || !currentHoles.length) {
        holeTitleEl.textContent = "No course selected";
        holeMetaEl.textContent = "";
        holeContentEl.innerHTML =
          "<p class=\"muted\">Select a course on the left to load per-hole data.</p>";
        return;
      }

      var maxHole = getMaxHoleNumber();
      if (!maxHole) {
        holeTitleEl.textContent = currentCourse.name || "Course";
        holeMetaEl.textContent = "No holes.json data found for this course.";
        holeContentEl.innerHTML =
          "<p class=\"muted\">Add hole data in <code>holes.json</code> to use the per-hole tracker.</p>";
        return;
      }

      if (currentHoleNum < 1) currentHoleNum = 1;
      if (currentHoleNum > maxHole) currentHoleNum = maxHole;

      var h = findHoleData(currentHoleNum);
      if (!h) {
        holeTitleEl.textContent = (currentCourse.name || "Course") +
          " – Hole " + currentHoleNum;
        holeMetaEl.textContent = "Hole not defined in holes.json";
        holeContentEl.innerHTML =
          "<p class=\"muted\">Hole " + currentHoleNum +
          " is not defined in <code>holes.json</code>.</p>";
        return;
      }

      var par = h.par;
      var hdcp = h.handicap;
      var tees = currentTees;
      var yardages = h.yardages || {};
      var media = h.media || {};
      var notes = h.notes || h.tips || h.layout;

      // Header text
      holeTitleEl.textContent = (currentCourse.name || "Course") +
        " – Hole " + currentHoleNum;
      var metaParts = [];
      if (typeof par === "number") metaParts.push("Par " + par);
      if (hdcp === 0 || hdcp) metaParts.push("Hdcp " + hdcp);
      var loc = currentCourse.location || {};
      if (loc.city) metaParts.push(loc.city);
      holeMetaEl.textContent = metaParts.join(" · ");

      // Build hole content layout
      holeContentEl.innerHTML =
        "<div class=\"hole-layout\">" +
          "<div>" +
            "<div class=\"gps-card\">" +
              "<h3>GPS / Hole Image</h3>" +
              "<div class=\"gps-image-wrapper\" id=\"gpsImageWrapper\">Loading image…</div>" +
              "<div class=\"gps-meta\">" +
                "<span id=\"gpsMetaText\" class=\"muted\"></span>" +
              "</div>" +
            "</div>" +
            "<div class=\"flyover-card\">" +
              "<h3>Flyover</h3>" +
              "<div class=\"flyover-area\" id=\"flyoverArea\">No flyover set for this hole yet.</div>" +
            "</div>" +
          "</div>" +
          "<div>" +
            "<div class=\"yardage-card\">" +
              "<h3>Yardages</h3>" +
              "<div class=\"yardage-list\" id=\"yardageList\"></div>" +
            "</div>" +
            "<div class=\"caddy-card\">" +
              "<h3>Caddy Notes</h3>" +
              "<div class=\"caddy-body\" id=\"caddyBody\"></div>" +
            "</div>" +
            "<div class=\"stats-card\">" +
              "<h3>Shot Stats</h3>" +
              "<div class=\"stats-grid\">" +
                "<div class=\"stats-field\">" +
                  "<label for=\"statScore\">Score</label>" +
                  "<input type=\"number\" id=\"statScore\" min=\"1\" max=\"20\" />" +
                "</div>" +
                "<div class=\"stats-field\">" +
                  <label for=\"statFairway\">Fairway Hit?</label>" +
                  "<select id=\"statFairway\">" +
                    "<option value=\"\">—</option>" +
                    "<option value=\"Y\">Yes</option>" +
                    "<option value=\"N\">No</option>" +
                    "<option value=\"NA\">N/A (Par 3)</option>" +
                  "</select>" +
                "</div>" +
                "<div class=\"stats-field\">" +
                  "<label for=\"statGIR\">GIR?</label>" +
                  "<select id=\"statGIR\">" +
                    "<option value=\"\">—</option>" +
                    "<option value=\"Y\">Yes</option>" +
                    "<option value=\"N\">No</option>" +
                  "</select>" +
                "</div>" +
                "<div class=\"stats-field\">" +
                  "<label for=\"statShape\">Shot Shape</label>" +
                  "<select id=\"statShape\">" +
                    "<option value=\"\">—</option>" +
                    "<option value=\"straight\">Straight</option>" +
                    "<option value=\"draw\">Draw</option>" +
                    "<option value=\"fade\">Fade</option>" +
                    "<option value=\"hook\">Hook</option>" +
                    "<option value=\"slice\">Slice</option>" +
                    "<option value=\"other\">Other</option>" +
                  "</select>" +
                "</div>" +
                "<div class=\"stats-field\">" +
                  "<label for=\"statChips\"># of Chips</label>" +
                  "<input type=\"number\" id=\"statChips\" min=\"0\" max=\"10\" />" +
                "</div>" +
                "<div class=\"stats-field\">" +
                  "<label for=\"statPutts\"># of Putts</label>" +
                  "<input type=\"number\" id=\"statPutts\" min=\"0\" max=\"10\" />" +
                "</div>" +
                "<div class=\"stats-field\">" +
                  "<label for=\"statBunkers\">Bunker Shots</label>" +
                  "<input type=\"number\" id=\"statBunkers\" min=\"0\" max=\"10\" />" +
                "</div>" +
                "<div class=\"stats-field\">" +
                  "<label for=\"statPenalties\">Penalty Strokes</label>" +
                  "<input type=\"number\" id=\"statPenalties\" min=\"0\" max=\"10\" />" +
                "</div>" +
              "</div>" +
              "<div class=\"stats-notes\">" +
                "<label for=\"statNotes\">Hole Notes</label>" +
                "<textarea id=\"statNotes\" placeholder=\"Wind, club choice, targets, mistakes, etc.\"></textarea>" +
              "</div>" +
              "<div class=\"stats-footer\">" +
                "<span id=\"statsTeeLabel\" class=\"muted\"></span>" +
                "<span class=\"muted\">Stats auto-save when you hit “Save &amp; Next”.</span>" +
              "</div>" +
            "</div>" +
          "</div>" +
        "</div>";

      // Fill GPS image
      var gpsWrapper = document.getElementById("gpsImageWrapper");
      var gpsMetaText = document.getElementById("gpsMetaText");
      var imgSrc = media.imageTee || media.image || media.imageGreen || null;
      if (gpsWrapper) {
        if (imgSrc) {
          gpsWrapper.innerHTML =
            "<img src=\"" + imgSrc + "\" alt=\"Hole " + currentHoleNum + " image\" />";
          gpsMetaText.textContent = "Image from holes.json media field.";
        } else {
          gpsWrapper.textContent = "No image configured for this hole yet.";
          gpsMetaText.textContent = "";
        }
      }

      // Fill flyover
      var flyArea = document.getElementById("flyoverArea");
      if (flyArea) {
        if (media.flyover) {
          var lower = String(media.flyover).toLowerCase();
          if (lower.endsWith(".mp4") || lower.endsWith(".webm") || lower.endsWith(".mov")) {
            flyArea.innerHTML =
              "<video controls src=\"" + media.flyover + "\"></video>";
          } else {
            flyArea.innerHTML =
              "<button type=\"button\" class=\"btn\" onclick=\"window.open('" +
              media.flyover + "', '_blank')\">Open Flyover</button>";
          }
        } else {
          flyArea.textContent = "No flyover set for this hole yet.";
        }
      }

      // Yardages
      var yardageList = document.getElementById("yardageList");
      if (yardageList) {
        if (!tees || !tees.length) {
          yardageList.innerHTML =
            "<span class=\"muted\">No tees defined in course.json.</span>";
        } else {
          var yHtml = "";
          tees.forEach(function(t) {
            var teeId = t.id;
            var teeName = t.name || teeId;
            var color = t.color || "#e5e7eb";
            var y = (yardages && typeof yardages[teeId] === "number")
              ? yardages[teeId]
              : null;
            yHtml += "<div class=\"yardage-line\">" +
              "<span class=\"tee-label-line\">" +
                "<span class=\"tee-dot\" style=\"background:" + color + ";\"></span>" +
                teeName +
              "</span>" +
              "<span>" + (y !== null ? (y + " yds") : "—") + "</span>" +
            "</div>";
          });
          yardageList.innerHTML = yHtml;
        }
      }

      // Caddy notes
      var caddyBody = document.getElementById("caddyBody");
      if (caddyBody) {
        var text = "";
        if (Array.isArray(notes)) {
          text += "<ul>";
          notes.forEach(function(n) {
            text += "<li>" + n + "</li>";
          });
          text += "</ul>";
        } else if (typeof notes === "string" && notes.trim().length) {
          text += "<p>" + notes + "</p>";
        } else {
          text += "<p class=\"muted\">No written notes yet. Add a <code>notes</code> or <code>tips</code> field for this hole in <code>holes.json</code>.</p>";
        }
        caddyBody.innerHTML = text;
      }

      // Stats form: prefill from storage
      var s = loadStatsForHole(currentHoleNum);
      var statScore = document.getElementById("statScore");
      var statFairway = document.getElementById("statFairway");
      var statGIR = document.getElementById("statGIR");
      var statShape = document.getElementById("statShape");
      var statChips = document.getElementById("statChips");
      var statPutts = document.getElementById("statPutts");
      var statBunkers = document.getElementById("statBunkers");
      var statPenalties = document.getElementById("statPenalties");
      var statNotes = document.getElementById("statNotes");
      var statsTeeLabel = document.getElementById("statsTeeLabel");

      if (statScore) statScore.value = (s.score != null ? s.score : "");
      if (statFairway) statFairway.value = s.fairway || "";
      if (statGIR) statGIR.value = s.gir || "";
      if (statShape) statShape.value = s.shape || "";
      if (statChips) statChips.value = (s.chips != null ? s.chips : "");
      if (statPutts) statPutts.value = (s.putts != null ? s.putts : "");
      if (statBunkers) statBunkers.value = (s.bunkers != null ? s.bunkers : "");
      if (statPenalties) statPenalties.value = (s.penalties != null ? s.penalties : "");
      if (statNotes) statNotes.value = s.notes || "";

      // Tee label
      if (statsTeeLabel) {
        var teeId = teeSelect.value;
        var teeName = "";
        if (teeId) {
          var foundTee = tees.find(function(t) { return t.id === teeId; });
          teeName = foundTee ? (foundTee.name || foundTee.id) : teeId;
        }
        statsTeeLabel.textContent = teeName
          ? ("Tracking from tee: " + teeName)
          : "No tee selected (using course yardage only).";
      }

      // Update startHoleInput to current
      startHoleInput.value = currentHoleNum;
    }

    function saveCurrentHoleStats() {
      if (!currentCourse || !currentHoles.length) return;
      var maxHole = getMaxHoleNumber();
      if (!maxHole) return;

      var statScore = document.getElementById("statScore");
      var statFairway = document.getElementById("statFairway");
      var statGIR = document.getElementById("statGIR");
      var statShape = document.getElementById("statShape");
      var statChips = document.getElementById("statChips");
      var statPutts = document.getElementById("statPutts");
      var statBunkers = document.getElementById("statBunkers");
      var statPenalties = document.getElementById("statPenalties");
      var statNotes = document.getElementById("statNotes");

      var data = {
        score: statScore ? (statScore.value || "") : "",
        fairway: statFairway ? (statFairway.value || "") : "",
        gir: statGIR ? (statGIR.value || "") : "",
        shape: statShape ? (statShape.value || "") : "",
        chips: statChips && statChips.value !== "" ? Number(statChips.value) : "",
        putts: statPutts && statPutts.value !== "" ? Number(statPutts.value) : "",
        bunkers: statBunkers && statBunkers.value !== "" ? Number(statBunkers.value) : "",
        penalties: statPenalties && statPenalties.value !== "" ? Number(statPenalties.value) : "",
        notes: statNotes ? (statNotes.value || "") : "",
        teeId: teeSelect.value || ""
      };

      saveStatsForHole(currentHoleNum, data);
    }

    // ===== EVENTS =====
    courseSelect.addEventListener("change", function() {
      loadCourseById(courseSelect.value);
    });

    btnJumpToHole.addEventListener("click", function() {
      var v = parseInt(startHoleInput.value, 10);
      var maxHole = getMaxHoleNumber();
      if (!maxHole) return;
      if (isNaN(v) || v < 1) v = 1;
      if (v > maxHole) v = maxHole;
      currentHoleNum = v;
      renderCurrentHole();
    });

    btnPrevHole.addEventListener("click", function() {
      if (!currentCourse || !currentHoles.length) return;
      saveCurrentHoleStats();
      var maxHole = getMaxHoleNumber();
      if (!maxHole) return;
      currentHoleNum = currentHoleNum - 1;
      if (currentHoleNum < 1) currentHoleNum = 1;
      renderCurrentHole();
    });

    btnSaveNextHole.addEventListener("click", function() {
      if (!currentCourse || !currentHoles.length) return;
      saveCurrentHoleStats();
      var maxHole = getMaxHoleNumber();
      if (!maxHole) return;
      if (currentHoleNum < maxHole) {
        currentHoleNum += 1;
        renderCurrentHole();
      } else {
        // end-of-round: just re-render (stats saved)
        renderCurrentHole();
        alert("Stats saved for final hole.");
      }
    });

    teeSelect.addEventListener("change", function() {
      // Just refresh the tee label in stats card
      renderCurrentHole();
    });

    // Initial load
    loadCoursesIndex();
  </script>
</body>
</html>
