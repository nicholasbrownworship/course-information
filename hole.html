<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hole View – Local Golf Scorebook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --green: #244f3c;
      --green-dark: #163023;
      --gold: #d1a14b;
      --cream: #f5f0e6;
      --bg: #fcfaf6;
      --text: #222;
      --radius: 14px;
      --shadow: 0 8px 20px rgba(0,0,0,0.08);
      --muted: #6b7280;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #fdf7eb 0, #f3efe7 40%, #e7e1d3 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    main {
      flex: 1;
      width: 100%;
      max-width: 1100px;
      margin: 10px auto 16px;
      padding: 0 10px;
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 10px;
    }

    @media (max-width: 900px) {
      main { grid-template-columns: 1fr; }
    }

    .panel {
      background: rgba(252,249,242,0.97);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.04);
      padding: 10px 12px;
      backdrop-filter: blur(6px);
    }

    .panel h2 {
      margin: 0 0 6px;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--green-dark);
    }

    .muted { color: var(--muted); font-size: 0.85rem; }
    .detail-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      margin: 8px 0 4px;
    }

    .top-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 8px;
      border-bottom: 1px solid rgba(0,0,0,0.12);
      padding-bottom: 6px;
    }

    .course-meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      justify-content: space-between;
    }

    .course-meta-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .course-title { font-weight: 600; font-size: 1.05rem; }
    .course-location { font-size: 0.8rem; color: var(--muted); }

    .course-controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
    }

    .course-controls label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    select {
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.2);
      background: #fffbf4;
      font-size: 0.8rem;
    }

    .hole-nav-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .hole-info-label {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.18);
      padding: 4px 10px;
      font-size: 0.78rem;
      background: #fdf7ea;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-primary {
      background: #244f3c;
      color: #fefcf5;
      border-color: #1a3a2b;
    }

    .btn:disabled { opacity: 0.5; cursor: default; }
    .btn:hover:not(:disabled) { filter: brightness(0.98); }

    .yardage-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .yardage-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(0,0,0,0.08);
      font-size: 0.78rem;
      white-space: nowrap;
    }

    .tee-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.15);
      background: #e5e7eb;
      flex-shrink: 0;
    }

    .hole-image-card,
    .map-card,
    .media-card {
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #fffdf6;
      padding: 8px 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
      margin-top: 4px;
      font-size: 0.8rem;
    }

    .hole-image-wrapper {
      position: relative;
      border-radius: 10px;
      overflow: hidden;
      max-height: 260px;
      background: #e5e7eb;
    }

    #holeImage {
      width: 100%;
      display: block;
      object-fit: cover;
    }

    .hole-image-overlay {
      position: absolute;
      left: 8px;
      bottom: 8px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.7);
      color: #f9fafb;
      font-size: 0.75rem;
      display: none;
    }

    .hole-image-caption {
      margin-top: 4px;
      font-size: 0.75rem;
      color: var(--muted);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 6px;
      margin-top: 6px;
      font-size: 0.8rem;
    }

    .stats-grid .field {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .stats-grid label { font-size: 0.78rem; color: var(--muted); }

    .hole-notes {
      width: 100%;
      margin-top: 6px;
      font-size: 0.8rem;
      font-family: inherit;
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.16);
      background: #fffbf4;
      resize: vertical;
      min-height: 52px;
    }

    .map-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 4px;
    }

    #holeMap {
      height: 280px;
      border-radius: 10px;
      overflow: hidden;
      background: #d1d5db;
    }

    #gpsReadout {
      margin-top: 4px;
      font-size: 0.78rem;
      color: var(--muted);
      font-weight: 600;
    }

    .distance-label {
      background: rgba(0,0,0,0.78);
      color: #f9fafb;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      white-space: nowrap;
      border: 1px solid rgba(255,255,255,0.25);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      transform: translate(-50%, -50%);
    }

    .media-card h3 {
      margin: 0 0 4px;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--green-dark);
    }

    .media-note {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 3px;
    }

    .caddy-list {
      margin: 4px 0 0;
      padding-left: 18px;
      font-size: 0.8rem;
    }

    .caddy-list li { margin-bottom: 2px; }

    .round-headline {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--green-dark);
      margin-bottom: 4px;
    }

    .goals-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 4px 8px;
      margin-top: 4px;
    }

    .goals-grid label {
      display: flex;
      flex-direction: column;
      font-size: 0.78rem;
      color: var(--muted);
    }

    .goals-grid input {
      margin-top: 2px;
      padding: 3px 6px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.2);
      background: #fffbf4;
      font-size: 0.8rem;
    }

    .field-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: flex-end;
      margin-top: 4px;
      font-size: 0.8rem;
    }

    .field-row label {
      display: flex;
      flex-direction: column;
      font-size: 0.78rem;
      color: var(--muted);
    }

    .field-row input[type="text"] {
      margin-top: 2px;
      padding: 3px 6px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.2);
      background: #fffbf4;
      font-size: 0.8rem;
      width: 100%;
      min-width: 120px;
    }
  </style>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
</head>
<body>
  <!-- HEADER INJECTION -->
  <div id="header-placeholder"></div>
  <script>
    fetch("header.html")
      .then(r => r.text())
      .then(html => {
        const el = document.getElementById("header-placeholder");
        if (el) el.innerHTML = html;
      })
      .catch(err => console.error("header load error", err));
  </script>

  <main>
    <!-- LEFT COLUMN -->
    <section class="panel">
      <div class="top-row">
        <div class="course-meta-row">
          <div class="course-meta-left">
            <div id="courseName" class="course-title">Select a course</div>
            <div id="courseLocation" class="course-location"></div>
          </div>
          <div class="course-controls">
            <label>
              Course:
              <select id="courseSelect">
                <option value="">Loading…</option>
              </select>
            </label>
            <label>
              Hole:
              <select id="holeSelect">
                <option value="">–</option>
              </select>
            </label>
          </div>
        </div>

        <div class="course-meta-row">
          <div class="muted" style="font-size:0.8rem;">Round</div>
          <div style="display:flex;flex-wrap:wrap;gap:4px;align-items:center;">
            <select id="roundSelect"></select>
            <button type="button" class="btn" id="btnNewRound">New</button>
            <button type="button" class="btn" id="btnDeleteRound">Delete</button>
          </div>
        </div>

        <div class="hole-nav-row">
          <div id="holeLabel" class="hole-info-label">Hole –</div>
          <div style="display:flex;gap:4px;flex-wrap:wrap;">
            <button type="button" class="btn" id="btnPrevHole">◀ Prev</button>
            <button type="button" class="btn" id="btnNextHole">Next ▶</button>
          </div>
        </div>
      </div>

      <div class="detail-title">Yardages</div>
      <div id="yardageRow" class="yardage-row">
        <span class="muted">No course selected.</span>
      </div>

      <!-- Hole image -->
      <div class="detail-title">Hole Image</div>
      <div class="hole-image-card">
        <div class="hole-image-wrapper">
          <img id="holeImage" src="" alt="Hole layout" style="display:none;" />
          <div id="holeImageOverlay" class="hole-image-overlay">Waiting for GPS…</div>
        </div>
        <div id="holeImageCaption" class="hole-image-caption">
          No image set for this hole yet.
        </div>
      </div>

      <div class="detail-title">Shot Stats</div>
      <div class="stats-grid">
        <div class="field">
          <label for="fairwayResult">Fairway</label>
          <select id="fairwayResult">
            <option value="">—</option>
            <option value="hit">Hit</option>
            <option value="miss-left">Miss left</option>
            <option value="miss-right">Miss right</option>
            <option value="na">N/A</option>
          </select>
        </div>
        <div class="field">
          <label for="girResult">GIR</label>
          <select id="girResult">
            <option value="">—</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
            <option value="na">N/A</option>
          </select>
        </div>
        <div class="field">
          <label for="shotShape">Shot shape</label>
          <select id="shotShape">
            <option value="">—</option>
            <option value="straight">Straight</option>
            <option value="draw">Draw</option>
            <option value="fade">Fade</option>
            <option value="hook">Hook</option>
            <option value="slice">Slice</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="field">
          <label for="teeClub">Tee club</label>
          <select id="teeClub">
            <option value="">—</option>
            <option>Driver</option><option>3W</option><option>5W</option>
            <option>3H</option><option>4H</option><option>5H</option>
            <option>4i</option><option>5i</option><option>6i</option>
            <option>7i</option><option>8i</option><option>9i</option>
            <option>PW</option><option>GW</option><option>SW</option><option>LW</option>
            <option>Putter</option><option>Other</option>
          </select>
        </div>
        <div class="field">
          <label for="approachClub">Approach club</label>
          <select id="approachClub">
            <option value="">—</option>
            <option>Driver</option><option>3W</option><option>5W</option>
            <option>3H</option><option>4H</option><option>5H</option>
            <option>4i</option><option>5i</option><option>6i</option>
            <option>7i</option><option>8i</option><option>9i</option>
            <option>PW</option><option>GW</option><option>SW</option><option>LW</option>
            <option>Putter</option><option>Other</option>
          </select>
        </div>
        <div class="field">
          <label for="numPutts">Putts</label>
          <select id="numPutts">
            <option value="">—</option>
            <option>0</option><option>1</option><option>2</option>
            <option>3</option><option>4</option><option>5</option><option>6</option>
          </select>
        </div>
        <div class="field">
          <label for="numChips">Chips / pitches</label>
          <select id="numChips">
            <option value="">—</option>
            <option>0</option><option>1</option><option>2</option>
            <option>3</option><option>4</option>
          </select>
        </div>
        <div class="field">
          <label for="numBunkers">Bunker shots</label>
          <select id="numBunkers">
            <option value="">—</option>
            <option>0</option><option>1</option><option>2</option><option>3</option>
          </select>
        </div>
        <div class="field">
          <label for="holeScore">Score</label>
          <select id="holeScore">
            <option value="">—</option>
            <option>1</option><option>2</option><option>3</option><option>4</option>
            <option>5</option><option>6</option><option>7</option><option>8</option>
            <option>9</option><option>10</option><option>11</option><option>12</option>
          </select>
        </div>
      </div>

      <textarea
        id="holeNotes"
        class="hole-notes"
        placeholder="Notes specific to this hole today – wind, pin, club choice, etc."
      ></textarea>
    </section>

    <!-- RIGHT COLUMN -->
    <section class="panel">
      <h2>On-Course View</h2>
      <small class="muted">GPS, flyover, notes, round summary, and conditions.</small>

      <div class="map-card">
        <div class="map-header-row">
          <div class="detail-title" style="margin:0;">GPS Map</div>
          <button type="button" class="btn" id="btnRefreshGPS">Refresh GPS</button>
        </div>
        <div id="holeMap"></div>
        <div id="gpsReadout">
          Select a course and hole to see GPS info.
        </div>
      </div>

      <div class="media-card" id="flyoverCard">
        <h3>Flyover</h3>
        <div id="flyoverBody" class="media-note">
          No flyover set for this hole yet.
        </div>
      </div>

      <div class="media-card" id="caddyCard">
        <h3>Caddy Notes</h3>
        <div id="caddyBody" class="media-note">
          No notes for this hole yet. Add "notes" or "tips" for this hole in holes.json.
        </div>
      </div>

      <div class="media-card" id="roundSummaryCard">
        <h3>Round Summary</h3>
        <div id="roundHeadline" class="round-headline">No score yet for this round.</div>
        <div id="roundSummaryBody" class="media-note">
          Start saving stats to see a summary for this round.
        </div>

        <div class="detail-title" style="margin-top:8px;">Round Goals</div>
        <div class="goals-grid">
          <label>
            Max vs par (e.g. +6)
            <input type="number" id="goalScoreVsPar" step="1" />
          </label>
          <label>
            Fairways hit target
            <input type="number" id="goalFairways" step="1" />
          </label>
          <label>
            GIR target
            <input type="number" id="goalGIR" step="1" />
          </label>
          <label>
            Max putts / hole
            <input type="number" id="goalPutts" step="0.1" />
          </label>
        </div>
        <div id="goalsStatus" class="media-note" style="margin-top:4px;">
          Set goals for this round (optional).
        </div>

        <div class="detail-title" style="margin-top:8px;">Today’s Conditions</div>
        <div class="field-row">
          <label style="flex:1;min-width:0;">
            Summary
            <input type="text" id="conditionsSummary" placeholder="Warm, light breeze, firm greens…" />
          </label>
          <button type="button" class="btn" id="btnFetchWeather">Use local weather</button>
        </div>
        <div id="conditionsNote" class="media-note">
          Optional: describe wind, temperature, etc., or auto-fill from course GPS.
        </div>

        <button type="button" class="btn btn-primary" id="btnExportRound" style="margin-top:8px;">
          Export this round (CSV)
        </button>
      </div>

      <div class="media-card" id="holeHistoryCard">
        <h3>Hole History</h3>
        <div id="holeHistoryBody" class="media-note">
          Play and save a few rounds to see trends on this hole.
        </div>
      </div>
    </section>
  </main>

  <script>
    const COURSES_INDEX_PATH = "data/courses.json";
    const STORAGE_KEY = "localGolfScorebook_rounds_v1";

    function fetchJSON(path) {
      return fetch(path).then(r => {
        if (!r.ok) throw new Error("HTTP " + r.status + " for " + path);
        return r.json();
      });
    }

    function distanceInYards(lat1, lng1, lat2, lng2) {
      const R = 6371000, toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a =
        Math.sin(dLat/2)**2 +
        Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return Math.round(R * c * 1.09361);
    }

    // Weather helpers
    const WEATHER_CODES = {
      0:"Clear",1:"Mainly clear",2:"Partly cloudy",3:"Overcast",
      45:"Fog",48:"Freezing fog",51:"Light drizzle",53:"Drizzle",55:"Heavy drizzle",
      61:"Light rain",63:"Rain",65:"Heavy rain",71:"Light snow",73:"Snow",75:"Heavy snow",
      80:"Rain showers",81:"Heavy rain showers",95:"Thunderstorm"
    };
    function degToCompass(deg) {
      if (typeof deg !== "number") return "";
      const dirs = ["N","NE","E","SE","S","SW","W","NW"];
      return dirs[Math.round(deg/45)%8];
    }

    function csvEscape(v) {
      if (v == null) return "";
      const s = String(v);
      return /[",\n\r]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
    }

    // ===== Map state =====
    let map, playerMarker, targetMarker, teeMarker;
    let teeToGreenLine, teeDistLabelMarker;
    let clickMarker, clickToGreenLine, clickDistLabelMarker;
    let teeToClickLine, teeToClickLabelMarker;
    let currentGpsTarget = null;   // green center
    let currentTeePoint = null;    // tee
    let gpsWatchId = null;

    const lastDistances = {
      teeToGreen:null,
      playerToGreen:null,
      clickToGreen:null,
      teeToClick:null
    };

    function updateGpsReadout() {
      const el = document.getElementById("gpsReadout");
      if (!el) return;
      if (!currentGpsTarget) {
        el.textContent = "No GPS data set for this hole yet.";
        return;
      }
      const parts = [];
      if (lastDistances.teeToGreen != null) parts.push("Tee→Green: " + lastDistances.teeToGreen + " yds");
      if (lastDistances.playerToGreen != null) parts.push("You→Green: " + lastDistances.playerToGreen + " yds");
      if (lastDistances.clickToGreen != null) parts.push("Selected→Green: " + lastDistances.clickToGreen + " yds");
      if (lastDistances.teeToClick != null) parts.push("Tee→Selected: " + lastDistances.teeToClick + " yds");
      el.textContent = parts.length
        ? parts.join("  |  ")
        : "Tap Refresh GPS or click the map to measure distances.";
    }

    function onMapClick(e) {
      if (!map || !currentGpsTarget) return;
      const latlng = e.latlng;

      // Clear old click layers
      [clickMarker, clickToGreenLine, clickDistLabelMarker,
       teeToClickLine, teeToClickLabelMarker].forEach(layer => {
        if (layer && map.hasLayer(layer)) map.removeLayer(layer);
      });

      clickMarker = L.marker(latlng).addTo(map).bindPopup("Selected point");

      clickToGreenLine = L.polyline(
        [[latlng.lat,latlng.lng],[currentGpsTarget.lat,currentGpsTarget.lng]],
        {color:"#d97706",weight:4,dashArray:"4 4"}
      ).addTo(map);

      const yards = distanceInYards(
        latlng.lat,latlng.lng,currentGpsTarget.lat,currentGpsTarget.lng
      );
      lastDistances.clickToGreen = yards;

      const midLat = (latlng.lat + currentGpsTarget.lat)/2;
      const midLng = (latlng.lng + currentGpsTarget.lng)/2;
      clickDistLabelMarker = L.marker([midLat,midLng],{
        interactive:false,
        icon:L.divIcon({className:"distance-label",html:yards+" yds",iconSize:[0,0]})
      }).addTo(map);

      if (currentTeePoint) {
        const yardsTC = distanceInYards(
          currentTeePoint.lat,currentTeePoint.lng,latlng.lat,latlng.lng
        );
        lastDistances.teeToClick = yardsTC;

        teeToClickLine = L.polyline(
          [[currentTeePoint.lat,currentTeePoint.lng],[latlng.lat,latlng.lng]],
          {color:"#059669",weight:3,dashArray:"2 4"}
        ).addTo(map);

        const midLatTC = (currentTeePoint.lat + latlng.lat)/2;
        const midLngTC = (currentTeePoint.lng + latlng.lng)/2;
        teeToClickLabelMarker = L.marker([midLatTC,midLngTC],{
          interactive:false,
          icon:L.divIcon({className:"distance-label",html:yardsTC+" yds",iconSize:[0,0]})
        }).addTo(map);
      } else {
        lastDistances.teeToClick = null;
      }

      updateGpsReadout();
    }

    function initHoleMap(gps) {
      const mapEl = document.getElementById("holeMap");
      if (!mapEl) return;

      // reset distance cache
      lastDistances.teeToGreen = lastDistances.clickToGreen = lastDistances.teeToClick = null;

      // clear tee/click layers
      [teeMarker, teeToGreenLine, teeDistLabelMarker,
       clickMarker, clickToGreenLine, clickDistLabelMarker,
       teeToClickLine, teeToClickLabelMarker].forEach(layer => {
        if (map && layer && map.hasLayer(layer)) map.removeLayer(layer);
      });
      teeMarker = teeToGreenLine = teeDistLabelMarker =
        clickMarker = clickToGreenLine = clickDistLabelMarker =
        teeToClickLine = teeToClickLabelMarker = null;

      if (!gps || !gps.greenCenter ||
          typeof gps.greenCenter.lat !== "number" ||
          typeof gps.greenCenter.lng !== "number") {
        currentGpsTarget = null;
        currentTeePoint = null;
        updateGpsReadout();
        return;
      }

      const green = gps.greenCenter;
      const tee = gps.tee &&
        typeof gps.tee.lat === "number" &&
        typeof gps.tee.lng === "number" ? gps.tee : null;

      currentGpsTarget = green;
      currentTeePoint = tee;

      if (!map) {
        map = L.map("holeMap");
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap"
        }).addTo(map);
        map.on("click", onMapClick);
      }

      if (tee) {
        const bounds = L.latLngBounds([tee.lat,tee.lng],[green.lat,green.lng]);
        map.fitBounds(bounds,{padding:[20,20]});

        teeMarker = L.marker([tee.lat,tee.lng]).addTo(map).bindPopup("Tee");

        teeToGreenLine = L.polyline(
          [[tee.lat,tee.lng],[green.lat,green.lng]],
          {color:"#111827",weight:4,dashArray:"6 4"}
        ).addTo(map);

        const yards = distanceInYards(tee.lat,tee.lng,green.lat,green.lng);
        lastDistances.teeToGreen = yards;

        const midLat = (tee.lat + green.lat)/2;
        const midLng = (tee.lng + green.lng)/2;
        teeDistLabelMarker = L.marker([midLat,midLng],{
          interactive:false,
          icon:L.divIcon({className:"distance-label",html:yards+" yds",iconSize:[0,0]})
        }).addTo(map);
      } else {
        map.setView([green.lat,green.lng],17);
      }

      if (targetMarker && map.hasLayer(targetMarker)) map.removeLayer(targetMarker);
      targetMarker = L.marker([green.lat,green.lng]).addTo(map).bindPopup("Green center");

      updateGpsReadout();
    }

    function startGpsWatch() {
      if (!navigator.geolocation) return;
      if (gpsWatchId !== null) return;

      gpsWatchId = navigator.geolocation.watchPosition(
        pos => {
          if (!currentGpsTarget || !map) return;
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          if (playerMarker && map.hasLayer(playerMarker)) map.removeLayer(playerMarker);
          playerMarker = L.marker([lat,lng]).addTo(map).bindPopup("You");

          const yards = distanceInYards(lat,lng,currentGpsTarget.lat,currentGpsTarget.lng);
          lastDistances.playerToGreen = yards;
          updateGpsReadout();

          const overlay = document.getElementById("holeImageOverlay");
          if (overlay) {
            overlay.style.display = "inline-flex";
            overlay.textContent = "You→Green: " + yards + " yds";
          }
        },
        err => console.warn("GPS watch error", err),
        { enableHighAccuracy:true }
      );
    }

    function refreshGpsOnce() {
      if (!currentGpsTarget || !navigator.geolocation) {
        updateGpsReadout();
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          if (!map) return;
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          if (playerMarker && map.hasLayer(playerMarker)) map.removeLayer(playerMarker);
          playerMarker = L.marker([lat,lng]).addTo(map).bindPopup("You");

          const yards = distanceInYards(lat,lng,currentGpsTarget.lat,currentGpsTarget.lng);
          lastDistances.playerToGreen = yards;
          updateGpsReadout();

          const overlay = document.getElementById("holeImageOverlay");
          if (overlay) {
            overlay.style.display = "inline-flex";
            overlay.textContent = "You→Green: " + yards + " yds";
          }
        },
        err => console.warn("GPS error", err),
        { enableHighAccuracy:true }
      );
    }

    // ===== Round storage =====
    let roundsState = { rounds: [], activeRoundId: null };

    function loadRoundsState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== "object" || !Array.isArray(parsed.rounds)) return;
        roundsState = parsed;
      } catch (e) {
        console.warn("[rounds] load error", e);
      }
    }

    function saveRoundsState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(roundsState));
      } catch (e) {
        console.warn("[rounds] save error", e);
      }
    }

    function findActiveRound() {
      if (!roundsState.activeRoundId) return null;
      return roundsState.rounds.find(r => r.id === roundsState.activeRoundId) || null;
    }

    function rebuildRoundSelect() {
      const select = document.getElementById("roundSelect");
      if (!select) return;
      const rounds = roundsState.rounds;
      if (!rounds.length) {
        select.innerHTML = "<option value=''>No rounds yet</option>";
        return;
      }
      let html = "";
      rounds.forEach(r => {
        html += "<option value='" + r.id + "'>" + (r.name || "Unnamed round") + "</option>";
      });
      select.innerHTML = html;
      if (roundsState.activeRoundId) {
        select.value = roundsState.activeRoundId;
      } else {
        roundsState.activeRoundId = rounds[0].id;
        select.value = rounds[0].id;
        saveRoundsState();
      }
    }

    function ensureRoundExists() {
      if (!roundsState.rounds.length) {
        const id = "r_" + Date.now();
        const r = {
          id,
          name: "Practice – " + new Date().toISOString().slice(0,10),
          createdAt: new Date().toISOString(),
          courseId: null,
          holes: {},
          goals: {},
          conditions: {}
        };
        roundsState.rounds.push(r);
        roundsState.activeRoundId = id;
        saveRoundsState();
      } else if (!roundsState.activeRoundId) {
        roundsState.activeRoundId = roundsState.rounds[0].id;
        saveRoundsState();
      }
      rebuildRoundSelect();
    }

    function makeHoleKey(courseId, holeNum) {
      const cid = courseId || "unknown";
      return cid + ":H" + holeNum;
    }

    // ===== Main init =====
    (function initPage() {
      const courseSelect = document.getElementById("courseSelect");
      const holeSelect = document.getElementById("holeSelect");
      const courseNameEl = document.getElementById("courseName");
      const courseLocEl = document.getElementById("courseLocation");
      const holeLabelEl = document.getElementById("holeLabel");
      const yardageRowEl = document.getElementById("yardageRow");
      const flyoverBody = document.getElementById("flyoverBody");
      const caddyBody = document.getElementById("caddyBody");
      const prevBtn = document.getElementById("btnPrevHole");
      const nextBtn = document.getElementById("btnNextHole");
      const refreshGpsBtn = document.getElementById("btnRefreshGPS");
      const holeImageEl = document.getElementById("holeImage");
      const holeImageOverlay = document.getElementById("holeImageOverlay");
      const holeImageCaption = document.getElementById("holeImageCaption");

      const roundSelect = document.getElementById("roundSelect");
      const newRoundBtn = document.getElementById("btnNewRound");
      const deleteRoundBtn = document.getElementById("btnDeleteRound");

      const fairwayResultEl = document.getElementById("fairwayResult");
      const girResultEl = document.getElementById("girResult");
      const shotShapeEl = document.getElementById("shotShape");
      const teeClubEl = document.getElementById("teeClub");
      const approachClubEl = document.getElementById("approachClub");
      const numPuttsEl = document.getElementById("numPutts");
      const numChipsEl = document.getElementById("numChips");
      const numBunkersEl = document.getElementById("numBunkers");
      const holeScoreEl = document.getElementById("holeScore");
      const holeNotesEl = document.getElementById("holeNotes");

      const roundHeadlineEl = document.getElementById("roundHeadline");
      const roundSummaryBody = document.getElementById("roundSummaryBody");
      const holeHistoryBody = document.getElementById("holeHistoryBody");

      const goalScoreVsParEl = document.getElementById("goalScoreVsPar");
      const goalFairwaysEl = document.getElementById("goalFairways");
      const goalGIREl = document.getElementById("goalGIR");
      const goalPuttsEl = document.getElementById("goalPutts");
      const goalsStatusEl = document.getElementById("goalsStatus");

      const conditionsSummaryEl = document.getElementById("conditionsSummary");
      const conditionsNoteEl = document.getElementById("conditionsNote");
      const btnFetchWeather = document.getElementById("btnFetchWeather");
      const btnExportRound = document.getElementById("btnExportRound");

      let loadedCourse = null;
      let loadedHoles = [];
      let currentHoleNum = 1;
      let maxHole = 0;

      const params = new URLSearchParams(window.location.search);
      const urlCourse = params.get("course") || "";
      const urlHole = parseInt(params.get("hole") || "1", 10);
      if (Number.isFinite(urlHole) && urlHole > 0) currentHoleNum = urlHole;

      loadRoundsState();
      ensureRoundExists();
      applyRoundMetaFromActive();
      renderRoundSummary();
      renderHoleHistory();

      function getHoleNumber(h, idx) {
        if (!h) return null;
        if (typeof h.hole === "number") return h.hole;
        return idx + 1;
      }

      function clearHoleControls() {
        [fairwayResultEl,girResultEl,shotShapeEl,teeClubEl,approachClubEl,
         numPuttsEl,numChipsEl,numBunkersEl,holeScoreEl].forEach(el => {
          if (el) el.value = "";
        });
        if (holeNotesEl) holeNotesEl.value = "";
      }

      function applyHoleState(courseId, holeNum) {
        const round = findActiveRound();
        if (!round || !round.holes) {
          clearHoleControls();
          return;
        }
        const key = makeHoleKey(courseId, holeNum);
        const data = round.holes[key];
        if (!data) {
          clearHoleControls();
          return;
        }
        if (fairwayResultEl) fairwayResultEl.value = data.fairwayResult || "";
        if (girResultEl) girResultEl.value = data.girResult || "";
        if (shotShapeEl) shotShapeEl.value = data.shotShape || "";
        if (teeClubEl) teeClubEl.value = data.teeClub || "";
        if (approachClubEl) approachClubEl.value = data.approachClub || "";
        if (numPuttsEl) numPuttsEl.value = data.numPutts || "";
        if (numChipsEl) numChipsEl.value = data.numChips || "";
        if (numBunkersEl) numBunkersEl.value = data.numBunkers || "";
        if (holeScoreEl) holeScoreEl.value = data.score || "";
        if (holeNotesEl) holeNotesEl.value = data.notes || "";
      }

      function saveCurrentHoleState(forceCourseId) {
        const round = findActiveRound();
        if (!round) return;
        const courseId =
          forceCourseId ||
          (courseSelect && courseSelect.value) ||
          (loadedCourse && loadedCourse.id) ||
          "unknown";

        const key = makeHoleKey(courseId, currentHoleNum || 1);
        if (!round.holes) round.holes = {};

        round.holes[key] = {
          fairwayResult: fairwayResultEl ? fairwayResultEl.value || "" : "",
          girResult: girResultEl ? girResultEl.value || "" : "",
          shotShape: shotShapeEl ? shotShapeEl.value || "" : "",
          teeClub: teeClubEl ? teeClubEl.value || "" : "",
          approachClub: approachClubEl ? approachClubEl.value || "" : "",
          numPutts: numPuttsEl ? numPuttsEl.value || "" : "",
          numChips: numChipsEl ? numChipsEl.value || "" : "",
          numBunkers: numBunkersEl ? numBunkersEl.value || "" : "",
          score: holeScoreEl ? holeScoreEl.value || "" : "",
          notes: holeNotesEl ? holeNotesEl.value || "" : ""
        };

        if (!round.courseId && courseId && courseId !== "unknown") {
          round.courseId = courseId;
        }

        saveRoundsState();
      }

      function applyRoundMetaFromActive() {
        const round = findActiveRound();
        const goals = (round && round.goals) || {};
        if (goalScoreVsParEl) goalScoreVsParEl.value =
          goals.maxScoreVsPar != null ? goals.maxScoreVsPar : "";
        if (goalFairwaysEl) goalFairwaysEl.value =
          goals.minFairways != null ? goals.minFairways : "";
        if (goalGIREl) goalGIREl.value =
          goals.minGIR != null ? goals.minGIR : "";
        if (goalPuttsEl) goalPuttsEl.value =
          goals.maxPuttsPerHole != null ? goals.maxPuttsPerHole : "";

        const cond = (round && round.conditions) || {};
        if (conditionsSummaryEl) conditionsSummaryEl.value = cond.summary || "";
        if (conditionsNoteEl) {
          conditionsNoteEl.textContent = cond.lastUpdated
            ? "Last updated " + cond.lastUpdated.slice(0,10) + "."
            : "Optional: describe wind, temperature, etc., or auto-fill from course GPS.";
        }
      }

      function readNumberOrNull(input, isFloat) {
        if (!input) return null;
        const raw = (input.value || "").trim();
        if (!raw) return null;
        const v = isFloat ? parseFloat(raw) : parseInt(raw,10);
        return Number.isNaN(v) ? null : v;
      }

      function saveRoundMeta() {
        const round = findActiveRound();
        if (!round) return;
        round.goals = {
          maxScoreVsPar: readNumberOrNull(goalScoreVsParEl,false),
          minFairways: readNumberOrNull(goalFairwaysEl,false),
          minGIR: readNumberOrNull(goalGIREl,false),
          maxPuttsPerHole: readNumberOrNull(goalPuttsEl,true)
        };
        round.conditions = {
          summary: conditionsSummaryEl ? conditionsSummaryEl.value.trim() : "",
          lastUpdated: new Date().toISOString()
        };
        saveRoundsState();
      }

      function renderGoalsStatus(stats) {
        if (!goalsStatusEl) return;
        const round = findActiveRound();
        if (!round) {
          goalsStatusEl.textContent = "No round selected.";
          return;
        }
        const goals = round.goals || {};
        const hasGoal =
          goals.maxScoreVsPar != null ||
          goals.minFairways != null ||
          goals.minGIR != null ||
          goals.maxPuttsPerHole != null;

        if (!hasGoal) {
          goalsStatusEl.textContent = "Set goals for this round (optional).";
          return;
        }

        let html = "<ul class='caddy-list'>";

        if (goals.maxScoreVsPar != null && stats.parTotal && stats.holesWithScore) {
          const diff = stats.scoreTotal - stats.parTotal;
          const goal = goals.maxScoreVsPar;
          const onTrack = diff <= goal;
          const diffText = diff === 0 ? "E" : (diff > 0 ? "+"+diff : String(diff));
          const goalText = goal === 0 ? "E" : (goal > 0 ? "+"+goal : String(goal));
          html += "<li><strong>Score goal:</strong> " +
            diffText + " vs goal " + goalText + " – " +
            (onTrack ? "on track" : "behind") + "</li>";
        }

        if (goals.minFairways != null && stats.fairwayOpp) {
          const onTrack = stats.fairwayHit >= goals.minFairways;
          html += "<li><strong>Fairways goal:</strong> " +
            stats.fairwayHit + " / " + goals.minFairways +
            " so far – " + (onTrack ? "on track" : "needs work") + "</li>";
        }

        if (goals.minGIR != null && stats.girOpp) {
          const onTrack = stats.girHit >= goals.minGIR;
          html += "<li><strong>GIR goal:</strong> " +
            stats.girHit + " / " + goals.minGIR +
            " so far – " + (onTrack ? "on track" : "needs work") + "</li>";
        }

        if (goals.maxPuttsPerHole != null && stats.puttEntries) {
          const avgPutts = stats.totalPutts / stats.puttEntries;
          const onTrack = avgPutts <= goals.maxPuttsPerHole;
          html += "<li><strong>Putts goal:</strong> " +
            avgPutts.toFixed(2) + " vs goal " + goals.maxPuttsPerHole +
            " – " + (onTrack ? "on track" : "needs work") + "</li>";
        }

        html += "</ul>";
        goalsStatusEl.innerHTML = html;
      }

      function renderRoundSummary() {
        if (!roundSummaryBody) return;
        const round = findActiveRound();
        if (!round || !round.holes) {
          roundSummaryBody.textContent = "Start saving stats to see a summary for this round.";
          if (roundHeadlineEl) roundHeadlineEl.textContent = "No score yet for this round.";
          if (goalsStatusEl) goalsStatusEl.textContent = "Set goals for this round (optional).";
          return;
        }

        const courseId =
          (courseSelect && courseSelect.value) ||
          round.courseId ||
          (loadedCourse && loadedCourse.id) ||
          "unknown";

        let scoreTotal = 0, holesWithScore = 0, parTotal = 0;
        let fairwayHit = 0, fairwayOpp = 0;
        let girHit = 0, girOpp = 0;
        let totalPutts = 0, puttEntries = 0, threePlusPutts = 0;

        const prefix = courseId + ":H";
        Object.keys(round.holes).forEach(key => {
          if (!key.startsWith(prefix)) return;
          const data = round.holes[key];
          if (!data) return;

          const numStr = key.slice(prefix.length);
          const holeNum = parseInt(numStr,10);
          if (!Number.isFinite(holeNum)) return;

          const holeDef = loadedHoles.find((h,idx) => getHoleNumber(h,idx) === holeNum);
          const par = holeDef && typeof holeDef.par === "number" ? holeDef.par : null;

          if (data.score) {
            const s = parseInt(data.score,10);
            if (!Number.isNaN(s)) {
              scoreTotal += s;
              holesWithScore++;
              if (par != null) parTotal += par;
            }
          }

          if (data.fairwayResult && data.fairwayResult !== "" && data.fairwayResult !== "na") {
            fairwayOpp++;
            if (data.fairwayResult === "hit") fairwayHit++;
          }

          if (data.girResult && data.girResult !== "" && data.girResult !== "na") {
            girOpp++;
            if (data.girResult === "yes") girHit++;
          }

          if (data.numPutts) {
            const p = parseInt(data.numPutts,10);
            if (!Number.isNaN(p)) {
              totalPutts += p;
              puttEntries++;
              if (p >= 3) threePlusPutts++;
            }
          }
        });

        if (!holesWithScore && !fairwayOpp && !girOpp && !puttEntries) {
          roundSummaryBody.textContent = "No stats saved yet for this round on this course.";
          if (roundHeadlineEl) roundHeadlineEl.textContent = "No score yet for this round.";
          if (goalsStatusEl) goalsStatusEl.textContent = "Set goals for this round (optional).";
          return;
        }

        if (roundHeadlineEl) {
          if (holesWithScore && parTotal) {
            const diff = scoreTotal - parTotal;
            const diffText = diff === 0 ? "E" : (diff > 0 ? "+"+diff : String(diff));
            roundHeadlineEl.textContent =
              "Round: " + diffText + " thru " + holesWithScore + " holes";
          } else {
            roundHeadlineEl.textContent = "Partial stats saved for this round.";
          }
        }

        let html = "<ul class='caddy-list'>";
        if (holesWithScore) {
          const avgScore = (scoreTotal / holesWithScore).toFixed(1);
          let vsParText = "";
          if (parTotal) {
            const diff = scoreTotal - parTotal;
            if (diff > 0) vsParText = " (+"+diff+" vs par)";
            else if (diff < 0) vsParText = " ("+diff+" vs par)";
            else vsParText = " (even par)";
          }
          html += "<li><strong>Total score:</strong> " +
            scoreTotal + " over " + holesWithScore + " holes" + vsParText + "</li>";
          html += "<li><strong>Avg score per hole:</strong> " + avgScore + "</li>";
        }
        if (fairwayOpp) {
          const pct = Math.round(fairwayHit/fairwayOpp*100);
          html += "<li><strong>Fairways hit:</strong> " +
            fairwayHit + " / " + fairwayOpp + " ("+pct+"%)</li>";
        }
        if (girOpp) {
          const pct = Math.round(girHit/girOpp*100);
          html += "<li><strong>GIR:</strong> " +
            girHit + " / " + girOpp + " ("+pct+"%)</li>";
        }
        if (puttEntries) {
          const avgPutts = (totalPutts/puttEntries).toFixed(2);
          html += "<li><strong>Putts per hole:</strong> " +
            avgPutts + " (3+ putts on " + threePlusPutts + " holes)</li>";
        }
        html += "</ul>";
        roundSummaryBody.innerHTML = html;

        const stats = {
          scoreTotal, holesWithScore, parTotal,
          fairwayHit,fairwayOpp,girHit,girOpp,
          totalPutts,puttEntries
        };
        renderGoalsStatus(stats);
      }

      function renderHoleHistory() {
        if (!holeHistoryBody) return;
        if (!loadedCourse || !loadedHoles.length) {
          holeHistoryBody.textContent = "Select a course and hole to see history.";
          return;
        }
        const courseId =
          (courseSelect && courseSelect.value) ||
          loadedCourse.id ||
          "unknown";
        const holeNum = currentHoleNum || 1;

        let entries = 0, scoreTotal = 0;
        let fairwayHit = 0, fairwayOpp = 0;
        let girHit = 0, girOpp = 0;
        let totalPutts = 0, puttEntries = 0;

        roundsState.rounds.forEach(round => {
          if (!round.holes) return;
          if (round.courseId && round.courseId !== courseId) return;
          const key = makeHoleKey(courseId,holeNum);
          const data = round.holes[key];
          if (!data) return;
          entries++;

          if (data.score) {
            const s = parseInt(data.score,10);
            if (!Number.isNaN(s)) scoreTotal += s;
          }
          if (data.fairwayResult && data.fairwayResult !== "" && data.fairwayResult !== "na") {
            fairwayOpp++;
            if (data.fairwayResult === "hit") fairwayHit++;
          }
          if (data.girResult && data.girResult !== "" && data.girResult !== "na") {
            girOpp++;
            if (data.girResult === "yes") girHit++;
          }
          if (data.numPutts) {
            const p = parseInt(data.numPutts,10);
            if (!Number.isNaN(p)) {
              totalPutts += p;
              puttEntries++;
            }
          }
        });

        if (!entries) {
          holeHistoryBody.textContent =
            "No saved history yet for this hole. Play and save a few rounds to see trends here.";
          return;
        }

        let html = "<ul class='caddy-list'>";
        if (scoreTotal) {
          const avgScore = (scoreTotal/entries).toFixed(2);
          html += "<li><strong>Avg score on this hole:</strong> " +
            avgScore + " over " + entries + " recorded rounds</li>";
        } else {
          html += "<li><strong>Avg score on this hole:</strong> not enough data yet</li>";
        }
        if (fairwayOpp) {
          const pct = Math.round(fairwayHit/fairwayOpp*100);
          html += "<li><strong>Fairway hit:</strong> " + pct + "% of recorded tee shots</li>";
        }
        if (girOpp) {
          const pct = Math.round(girHit/girOpp*100);
          html += "<li><strong>GIR:</strong> " + pct + "% of recorded approaches</li>";
        }
        if (puttEntries) {
          const avgPutts = (totalPutts/puttEntries).toFixed(2);
          html += "<li><strong>Avg putts on this hole:</strong> " + avgPutts + "</li>";
        }
        html += "</ul>";
        holeHistoryBody.innerHTML = html;
      }

      function fetchWeatherForCurrentHole() {
        if (!conditionsNoteEl) return;

        let lat = null, lng = null;
        if (currentGpsTarget) {
          lat = currentGpsTarget.lat;
          lng = currentGpsTarget.lng;
        }
        if (lat == null || lng == null) {
          conditionsNoteEl.textContent =
            "No GPS set for this hole. Add gps.greenCenter in holes.json.";
          return;
        }

        conditionsNoteEl.textContent = "Fetching weather for this course…";

        const url = "https://api.open-meteo.com/v1/forecast" +
          "?latitude=" + encodeURIComponent(lat) +
          "&longitude=" + encodeURIComponent(lng) +
          "&current=temperature_2m,wind_speed_10m,wind_direction_10m,weather_code";

        fetch(url)
          .then(r => r.json())
          .then(data => {
            const cur = data && data.current;
            if (!cur) {
              conditionsNoteEl.textContent = "Weather data unavailable.";
              return;
            }
            const temp = Math.round(cur.temperature_2m);
            const wind = Math.round(cur.wind_speed_10m || 0);
            const dir = cur.wind_direction_10m;
            const code = cur.weather_code;
            const desc = WEATHER_CODES[code] || "Conditions unknown";
            const compass = degToCompass(dir);
            const summary =
              temp + "° – " + desc.toLowerCase() +
              (wind ? ", " + wind + " mph " + compass + " wind" : "");

            if (conditionsSummaryEl) conditionsSummaryEl.value = summary;
            if (conditionsNoteEl) conditionsNoteEl.textContent =
              "Auto-filled from weather near this course.";
            saveRoundMeta();
          })
          .catch(err => {
            console.error("[weather] error", err);
            conditionsNoteEl.textContent =
              "Could not fetch weather. You can enter a summary manually.";
          });
      }

      function exportActiveRoundToCsv() {
        const round = findActiveRound();
        if (!round) {
          alert("No active round to export.");
          return;
        }
        const courseId =
          (courseSelect && courseSelect.value) ||
          round.courseId ||
          (loadedCourse && loadedCourse.id) ||
          "unknown";

        const courseName =
          (loadedCourse && loadedCourse.name) ||
          courseId ||
          "";

        const header = [
          "RoundName","CreatedAt","CourseId","CourseName",
          "Hole","Par","Handicap","Score","ScoreVsPar",
          "Fairway","GIR","TeeClub","ApproachClub",
          "Putts","Chips","Bunkers","Notes"
        ];
        const rows = [header];
        const prefix = courseId + ":H";

        let holeNumbers = [];
        if (loadedHoles && loadedHoles.length) {
          holeNumbers = loadedHoles
            .map((h,idx) => getHoleNumber(h,idx))
            .filter(n => Number.isFinite(n))
            .sort((a,b)=>a-b);
        } else if (round.holes) {
          holeNumbers = Object.keys(round.holes)
            .filter(k => k.startsWith(prefix))
            .map(k => parseInt(k.slice(prefix.length),10))
            .filter(n => Number.isFinite(n))
            .sort((a,b)=>a-b);
        }

        function findHoleDef(n) {
          if (!loadedHoles) return null;
          return loadedHoles.find((h,idx)=>getHoleNumber(h,idx)===n) || null;
        }

        holeNumbers.forEach(n => {
          const key = prefix + n;
          const data = (round.holes && round.holes[key]) || {};
          const holeDef = findHoleDef(n);
          const par = holeDef && typeof holeDef.par === "number" ? holeDef.par : null;
          const hdcpVal = (holeDef && (holeDef.handicap === 0 || typeof holeDef.handicap === "number"))
            ? holeDef.handicap : "";

          let score = null;
          if (data.score) {
            const s = parseInt(data.score,10);
            if (!Number.isNaN(s)) score = s;
          }
          let vsPar = "";
          if (score != null && par != null) {
            const diff = score - par;
            vsPar = diff === 0 ? "E" : (diff > 0 ? "+"+diff : String(diff));
          }

          rows.push([
            round.name || "",
            round.createdAt || "",
            courseId,
            courseName,
            n,
            par != null ? par : "",
            hdcpVal,
            score != null ? score : "",
            vsPar,
            data.fairwayResult || "",
            data.girResult || "",
            data.teeClub || "",
            data.approachClub || "",
            data.numPutts || "",
            data.numChips || "",
            data.numBunkers || "",
            data.notes || ""
          ]);
        });

        const csvContent = rows.map(r => r.map(csvEscape).join(",")).join("\r\n");
        const blob = new Blob([csvContent], {type:"text/csv;charset=utf-8;"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const dateSlug = (round.createdAt || "").slice(0,10) || "round";
        const safeName = (round.name || "round").replace(/[^\w\-]+/g,"_");
        a.href = url;
        a.download = safeName + "_" + dateSlug + ".csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // wire round select / new / delete
      if (roundSelect) {
        roundSelect.addEventListener("change", () => {
          saveCurrentHoleState();
          roundsState.activeRoundId = roundSelect.value || null;
          saveRoundsState();
          applyRoundMetaFromActive();
          const courseId =
            (courseSelect && courseSelect.value) ||
            (loadedCourse && loadedCourse.id) ||
            "unknown";
          applyHoleState(courseId, currentHoleNum);
          renderRoundSummary();
          renderHoleHistory();
        });
      }

      if (newRoundBtn) {
        newRoundBtn.addEventListener("click", () => {
          saveCurrentHoleState();
          const id = "r_" + Date.now();
          const nameBase =
            (loadedCourse && loadedCourse.name) ||
            (courseSelect && courseSelect.options[courseSelect.selectedIndex] &&
             courseSelect.options[courseSelect.selectedIndex].text) ||
            "Practice";
          const round = {
            id,
            name: nameBase + " – " + new Date().toISOString().slice(0,10),
            createdAt: new Date().toISOString(),
            courseId: (loadedCourse && loadedCourse.id) || (courseSelect && courseSelect.value) || null,
            holes: {},
            goals: {},
            conditions: {}
          };
          roundsState.rounds.push(round);
          roundsState.activeRoundId = id;
          saveRoundsState();
          rebuildRoundSelect();
          applyRoundMetaFromActive();
          clearHoleControls();
          renderRoundSummary();
          renderHoleHistory();
        });
      }

      if (deleteRoundBtn) {
        deleteRoundBtn.addEventListener("click", () => {
          const active = findActiveRound();
          if (!active) return;
          if (!confirm("Delete this round and all its saved data?")) return;
          roundsState.rounds = roundsState.rounds.filter(r => r.id !== active.id);
          roundsState.activeRoundId = roundsState.rounds.length ? roundsState.rounds[0].id : null;
          saveRoundsState();
          rebuildRoundSelect();
          applyRoundMetaFromActive();
          clearHoleControls();
          renderRoundSummary();
          renderHoleHistory();
        });
      }

      // auto-save when stats/notes change
      const statFields = [
        fairwayResultEl,girResultEl,shotShapeEl,teeClubEl,approachClubEl,
        numPuttsEl,numChipsEl,numBunkersEl,holeScoreEl
      ];
      statFields.forEach(el => {
        if (!el) return;
        el.addEventListener("change", () => {
          saveCurrentHoleState();
          renderRoundSummary();
          renderHoleHistory();
        });
      });
      if (holeNotesEl) {
        holeNotesEl.addEventListener("input", () => {
          saveCurrentHoleState();
          renderRoundSummary();
          renderHoleHistory();
        });
      }

      [goalScoreVsParEl,goalFairwaysEl,goalGIREl,goalPuttsEl].forEach(el => {
        if (!el) return;
        el.addEventListener("change", () => {
          saveRoundMeta();
          renderRoundSummary();
        });
      });
      if (conditionsSummaryEl) {
        conditionsSummaryEl.addEventListener("change", saveRoundMeta);
      }
      if (btnFetchWeather) {
        btnFetchWeather.addEventListener("click", fetchWeatherForCurrentHole);
      }
      if (btnExportRound) {
        btnExportRound.addEventListener("click", exportActiveRoundToCsv);
      }

      // ==== course / holes ====
      function loadCoursesIndex() {
        courseSelect.innerHTML = "<option value=''>Loading…</option>";
        fetchJSON(COURSES_INDEX_PATH)
          .then(courses => {
            if (!Array.isArray(courses) || !courses.length) {
              courseSelect.innerHTML = "<option value=''>No courses found</option>";
              return;
            }
            let html = "<option value=''>Select course…</option>";
            courses.forEach(c => {
              html += "<option value='" + c.id + "'>" + (c.name || c.id) + "</option>";
            });
            courseSelect.innerHTML = html;

            if (urlCourse) courseSelect.value = urlCourse;
            if (!courseSelect.value) courseSelect.value = courses[0].id;
            if (courseSelect.value) loadCourse(courseSelect.value);
          })
          .catch(err => {
            console.error("[courses] index error", err);
            courseSelect.innerHTML = "<option value=''>Error loading courses</option>";
          });
      }

      function loadCourse(courseId) {
        const base = "data/courses/" + courseId;
        const coursePath = base + "/course.json";
        const holesPath = base + "/holes.json";

        yardageRowEl.innerHTML = "<span class='muted'>Loading hole data…</span>";
        if (holeImageEl) { holeImageEl.style.display="none"; holeImageEl.removeAttribute("src"); }
        if (holeImageOverlay) holeImageOverlay.style.display="none";
        if (holeImageCaption) holeImageCaption.textContent = "No image set for this hole yet.";

        fetchJSON(coursePath)
          .then(course => {
            loadedCourse = course;
            return fetchJSON(holesPath);
          })
          .then(holes => {
            loadedHoles = Array.isArray(holes) ? holes : [];
            maxHole = 0;
            loadedHoles.forEach((h,idx) => {
              const n = getHoleNumber(h,idx);
              if (n && n > maxHole) maxHole = n;
            });
            if (!maxHole) maxHole = loadedHoles.length || 1;
            if (!Number.isFinite(currentHoleNum) || currentHoleNum < 1) currentHoleNum = 1;
            if (currentHoleNum > maxHole) currentHoleNum = maxHole;
            renderHoleOptions();
            renderHoleView();
          })
          .catch(err => {
            console.error("[course] load error", courseId, err);
            loadedCourse = null;
            loadedHoles = [];
            maxHole = 0;
            courseNameEl.textContent = "Error loading course";
            courseLocEl.textContent = "";
            holeLabelEl.textContent = "Hole –";
            yardageRowEl.innerHTML =
              "<span class='muted'>Could not load course data. Check JSON paths.</span>";
          });
      }

      function renderHoleOptions() {
        if (!loadedHoles.length) {
          holeSelect.innerHTML = "<option value=''>No holes</option>";
          return;
        }
        let html = "";
        loadedHoles.forEach((h,idx) => {
          const n = getHoleNumber(h,idx);
          html += "<option value='" + n + "'>Hole " + n + "</option>";
        });
        holeSelect.innerHTML = html;
        if (currentHoleNum < 1) currentHoleNum = 1;
        if (currentHoleNum > maxHole) currentHoleNum = maxHole;
        holeSelect.value = String(currentHoleNum);
      }

      function renderHoleView() {
        if (!loadedCourse || !loadedHoles.length) return;
        if (!Number.isFinite(currentHoleNum) || currentHoleNum < 1) currentHoleNum = 1;
        if (currentHoleNum > maxHole) currentHoleNum = maxHole;
        holeSelect.value = String(currentHoleNum);

        const hole = loadedHoles.find((h,idx)=>getHoleNumber(h,idx)===currentHoleNum) || loadedHoles[0];
        const resolvedNum = getHoleNumber(hole,loadedHoles.indexOf(hole)) || currentHoleNum;
        currentHoleNum = resolvedNum;

        const loc = loadedCourse.location || {};
        let locLine = "";
        if (loc.city) locLine += loc.city;
        if (loc.city && loc.state) locLine += ", ";
        if (loc.state) locLine += loc.state;
        courseNameEl.textContent = loadedCourse.name || "Unnamed Course";
        courseLocEl.textContent = locLine || "";

        const par = typeof hole.par === "number" ? hole.par : "–";
        const hdcp = (hole.handicap === 0 || typeof hole.handicap === "number") ? hole.handicap : "–";
        holeLabelEl.textContent = "Hole " + resolvedNum + " · Par " + par + " · Hdcp " + hdcp;

        if (prevBtn) prevBtn.disabled = resolvedNum <= 1;
        if (nextBtn) nextBtn.disabled = resolvedNum >= maxHole;

        const tees = Array.isArray(loadedCourse.tees) ? loadedCourse.tees : [];
        if (!tees.length || !hole.yardages) {
          yardageRowEl.innerHTML = "<span class='muted'>No yardage data yet.</span>";
        } else {
          let html = "";
          tees.forEach(t => {
            const teeId = t.id;
            const name = t.name || teeId;
            const color = t.color || "#e5e7eb";
            const y = hole.yardages[teeId];
            const txt = typeof y === "number" ? y + " yds" : "–";
            html += "<span class='yardage-chip'>" +
              "<span class='tee-dot' style='background:"+color+";'></span>" +
              "<span>" + name + " · " + txt + "</span>" +
              "</span>";
          });
          yardageRowEl.innerHTML = html || "<span class='muted'>No yardage data yet.</span>";
        }

        const media = hole.media || {};
        if (holeImageEl && holeImageCaption && holeImageOverlay) {
          const src = media.image || hole.image || null;
          if (src) {
            holeImageEl.src = src;
            holeImageEl.style.display = "block";
            holeImageCaption.textContent = media.caption || ("Layout for hole " + resolvedNum);
            holeImageOverlay.style.display = "none";
          } else {
            holeImageEl.removeAttribute("src");
            holeImageEl.style.display = "none";
            holeImageCaption.textContent = "No image set for this hole yet.";
            holeImageOverlay.style.display = "none";
          }
        }

        if (flyoverBody) {
          if (media.flyover) {
            const lower = media.flyover.toLowerCase();
            if (/\.(mp4|webm|mov)$/.test(lower)) {
              flyoverBody.innerHTML =
                "<video controls style='max-width:100%;border-radius:8px;display:block;background:#000;'>" +
                "<source src='" + media.flyover + "'>" +
                "Your browser does not support the video tag.</video>";
            } else {
              flyoverBody.innerHTML =
                "<a href='" + media.flyover + "' target='_blank' rel='noopener'>" +
                "Open flyover for hole " + resolvedNum + "</a>";
            }
          } else {
            flyoverBody.textContent = "No flyover set for this hole yet.";
          }
        }

        if (caddyBody) {
          const tips = hole.notes || hole.tips || null;
          let html = "<div>Par " + par + " · Hdcp " + hdcp + "</div>";
          if (tips) {
            if (Array.isArray(tips)) {
              html += "<ul class='caddy-list'>";
              tips.forEach(t => html += "<li>" + t + "</li>");
              html += "</ul>";
            } else if (typeof tips === "string") {
              html += "<ul class='caddy-list'><li>" + tips + "</li></ul>";
            }
          } else {
            html += "<div class='media-note'>No written notes yet. Add \"notes\" or \"tips\" for this hole in holes.json.</div>";
          }
          caddyBody.innerHTML = html;
        }

        const courseId =
          (courseSelect && courseSelect.value) ||
          (loadedCourse && loadedCourse.id) ||
          "unknown";
        applyHoleState(courseId, currentHoleNum);

        initHoleMap(hole.gps || null);
        startGpsWatch();
        renderRoundSummary();
        renderHoleHistory();
      }

      if (courseSelect) {
        courseSelect.addEventListener("change", () => {
          if (loadedCourse && loadedCourse.id) {
            saveCurrentHoleState(loadedCourse.id);
          } else {
            saveCurrentHoleState();
          }
          currentHoleNum = 1;
          loadCourse(courseSelect.value);
        });
      }

      if (holeSelect) {
        holeSelect.addEventListener("change", () => {
          saveCurrentHoleState();
          const val = parseInt(holeSelect.value || "1",10);
          if (!Number.isFinite(val)) return;
          currentHoleNum = val;
          renderHoleView();
        });
      }

      if (prevBtn) {
        prevBtn.addEventListener("click", () => {
          if (currentHoleNum > 1) {
            saveCurrentHoleState();
            currentHoleNum--;
            renderHoleView();
          }
        });
      }

      if (nextBtn) {
        nextBtn.addEventListener("click", () => {
          if (currentHoleNum < maxHole) {
            saveCurrentHoleState();
            currentHoleNum++;
            renderHoleView();
          }
        });
      }

      if (refreshGpsBtn) {
        refreshGpsBtn.addEventListener("click", () => {
          startGpsWatch();
          refreshGpsOnce();
        });
      }

      // Goals / conditions wiring already set above
      loadCoursesIndex();
    })();
  </script>
</body>
</html>
