<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hole View – Local Golf Scorebook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --green: #244f3c;
      --green-dark: #163023;
      --gold: #d1a14b;
      --cream: #f5f0e6;
      --bg: #fcfaf6;
      --text: #222;
      --radius: 14px;
      --shadow: 0 8px 20px rgba(0,0,0,0.08);
      --muted: #6b7280;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #fdf7eb 0, #f3efe7 40%, #e7e1d3 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    main {
      flex: 1;
      width: 100%;
      max-width: 1100px;
      margin: 10px auto 16px;
      padding: 0 10px;
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 10px;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: rgba(252,249,242,0.97);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.04);
      padding: 10px 12px;
      backdrop-filter: blur(6px);
    }

    .panel h2 {
      margin: 0 0 6px;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--green-dark);
    }

    .panel small {
      color: var(--muted);
      font-size: 0.78rem;
    }

    .muted {
      color: var(--muted);
      font-size: 0.85rem;
    }

    .error {
      color: #b91c1c;
      font-size: 0.85rem;
      margin-top: 6px;
    }

    .detail-section-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      margin: 8px 0 4px;
    }

    /* HEADER AREA INSIDE PANEL */
    .top-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 8px;
      border-bottom: 1px solid rgba(0,0,0,0.12);
      padding-bottom: 6px;
    }

    .course-meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      justify-content: space-between;
    }

    .course-meta-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .course-title {
      font-weight: 600;
      font-size: 1.05rem;
    }

    .course-location {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .course-controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
    }

    .course-controls label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .course-controls select {
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.2);
      background: #fffbf4;
      font-size: 0.8rem;
    }

    .hole-nav-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .hole-info-label {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .nav-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      align-items: center;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.18);
      padding: 4px 10px;
      font-size: 0.78rem;
      background: #fdf7ea;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-primary {
      background: #244f3c;
      color: #fefcf5;
      border-color: #1a3a2b;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .btn:hover:not(:disabled) {
      filter: brightness(0.98);
    }

    /* ROUND CONTROLS */
    .round-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .round-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--green-dark);
    }

    .round-controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 4px;
      font-size: 0.8rem;
    }

    #roundSelect {
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.2);
      background: #fffbf4;
      font-size: 0.8rem;
      min-width: 140px;
    }

    /* YARDAGES */
    .yardage-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .yardage-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(0,0,0,0.08);
      font-size: 0.78rem;
      white-space: nowrap;
    }

    .tee-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.15);
      background: #e5e7eb;
      flex-shrink: 0;
    }

    /* HOLE IMAGE + GPS OVERLAY */
    .hole-image-card {
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #fffdf6;
      padding: 8px 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
      margin-top: 4px;
      font-size: 0.8rem;
    }

    .hole-image-wrapper {
      position: relative;
      border-radius: 10px;
      overflow: hidden;
      max-height: 260px;
      background: #e5e7eb;
    }

    #holeImage {
      width: 100%;
      display: block;
      object-fit: cover;
    }

    .hole-image-overlay {
      position: absolute;
      left: 8px;
      bottom: 8px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.7);
      color: #f9fafb;
      font-size: 0.75rem;
      display: none;
    }

    .hole-image-caption {
      margin-top: 4px;
      font-size: 0.75rem;
      color: var(--muted);
    }

    /* SHOT STATS – ALL DROPDOWNS */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 6px;
      margin-top: 6px;
      font-size: 0.8rem;
    }

    .stats-grid .field {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .stats-grid label {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .stats-grid select {
      padding: 3px 6px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.2);
      background: #fffbf4;
      font-size: 0.8rem;
    }

    .hole-notes {
      width: 100%;
      margin-top: 6px;
      font-size: 0.8rem;
      font-family: inherit;
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.16);
      background: #fffbf4;
      resize: vertical;
      min-height: 52px;
    }

    /* MAP / GPS */
    .map-card {
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #fffdf6;
      padding: 8px 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
      margin-top: 4px;
    }

    .map-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 4px;
    }

    #holeMap {
      height: 300px;
      border-radius: 10px;
      overflow: hidden;
      background: #d1d5db;
    }

    #gpsReadout {
      margin-top: 4px;
      font-size: 0.78rem;
      color: var(--muted);
      font-weight: 600;
    }

    /* DISTANCE LABELS ON LINES */
    .distance-label {
      background: rgba(0,0,0,0.78);
      color: #f9fafb;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      white-space: nowrap;
      border: 1px solid rgba(255,255,255,0.25);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      transform: translate(-50%, -50%);
    }

    /* FLYOVER / CADDY / SUMMARY / HISTORY / CLUBS / GOALS */
    .media-card {
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #fffdf6;
      padding: 8px 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
      margin-top: 8px;
      font-size: 0.8rem;
    }

    .media-card h3 {
      margin: 0 0 4px;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--green-dark);
    }

    .media-note {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 3px;
    }

    .caddy-list {
      margin: 4px 0 0;
      padding-left: 18px;
      font-size: 0.8rem;
    }

    .caddy-list li {
      margin-bottom: 2px;
    }

    /* Club recommender / bag */
    .field-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: flex-end;
      margin-bottom: 4px;
      font-size: 0.8rem;
    }

    .field-row label {
      display: flex;
      flex-direction: column;
      font-size: 0.78rem;
      color: var(--muted);
    }

    .field-row input[type="number"] {
      margin-top: 2px;
      padding: 3px 6px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.2);
      background: #fffbf4;
      font-size: 0.8rem;
      width: 90px;
    }

    .bag-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 4px 10px;
      margin-top: 4px;
      font-size: 0.78rem;
    }

    .bag-grid-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
    }

    .bag-grid-row span {
      white-space: nowrap;
    }

    .bag-grid-row input {
      width: 64px;
      text-align: right;
      padding: 3px 4px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.2);
      background: #fffbf4;
      font-size: 0.78rem;
    }

    /* SCORE STRIP – ALL HOLES */
    .score-bubbles {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .score-bubble {
      min-width: 70px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #111827;
      color: #f9fafb;
      font-size: 0.72rem;
      display: inline-flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
      border: 1px solid rgba(255,255,255,0.08);
      cursor: pointer;
    }

    .score-bubble-label {
      opacity: 0.7;
      font-size: 0.7rem;
    }

    .score-bubble-value {
      font-weight: 600;
      line-height: 1.2;
    }

    .score-bubble-active {
      background: var(--gold);
      color: #111827;
      border-color: rgba(0,0,0,0.3);
    }

    .score-bubble-total {
      background: var(--green-dark);
      color: #f9fafb;
      border-color: rgba(0,0,0,0.4);
    }

    /* GOALS PROGRESS */
    .goal-row {
      margin-top: 4px;
    }

    .goal-row-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.78rem;
    }

    .goal-label {
      font-weight: 600;
    }

    .goal-value {
      font-variant-numeric: tabular-nums;
      color: var(--muted);
    }

    .goal-bar-outer {
      margin-top: 3px;
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
    }

    .goal-bar-inner {
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: var(--green);
      transition: width 0.25s ease, background-color 0.2s ease;
    }

    .goal-bar-inner.goal-met {
      background: var(--gold);
    }

    .goal-bar-inner.goal-behind {
      background: #b91c1c;
    }

    .goal-edit {
      margin-top: 6px;
      padding-top: 4px;
      border-top: 1px dashed rgba(0,0,0,0.08);
      font-size: 0.75rem;
    }

    .goal-edit summary {
      cursor: pointer;
      font-weight: 500;
      color: var(--green-dark);
    }

    .goal-edit-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .goal-edit label {
      display: flex;
      flex-direction: column;
    }

    .goal-edit input[type="number"] {
      margin-top: 2px;
      padding: 3px 6px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.2);
      background: #fffbf4;
      font-size: 0.78rem;
      width: 90px;
    }

    .goal-edit .btn {
      margin-top: 6px;
    }
  </style>

  <!-- Leaflet (for GPS map) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
</head>
<body>
  <!-- HEADER INJECTION -->
  <div id="header-placeholder"></div>
  <script>
    fetch("header.html")
      .then(res => res.text())
      .then(html => {
        const slot = document.getElementById("header-placeholder");
        if (slot) slot.innerHTML = html;
      })
      .catch(err => console.error("Failed to load header.html:", err));
  </script>

  <main>
    <!-- LEFT: course + hole + shot stats -->
    <section class="panel">
      <div class="top-row">
        <div class="course-meta-row">
          <div class="course-meta-left">
            <div id="courseName" class="course-title">Select a course</div>
            <div id="courseLocation" class="course-location"></div>
          </div>
          <div class="course-controls">
            <label>
              Course:
              <select id="courseSelect">
                <option value="">Loading…</option>
              </select>
            </label>
            <label>
              Hole:
              <select id="holeSelect">
                <option value="">–</option>
              </select>
            </label>
          </div>
        </div>

        <!-- ROUND CONTROLS -->
        <div class="round-row">
          <div class="round-label">Round</div>
          <div class="round-controls">
            <select id="roundSelect"></select>
            <button type="button" class="btn" id="btnNewRound">New</button>
            <button type="button" class="btn" id="btnDeleteRound">Delete</button>
          </div>
        </div>

        <div class="hole-nav-row">
          <div class="hole-info-label" id="holeLabel">Hole –</div>
          <div class="nav-buttons">
            <button type="button" class="btn" id="btnPrevHole">◀ Prev</button>
            <button type="button" class="btn" id="btnNextHole">Next ▶</button>
          </div>
        </div>
      </div>

      <div class="detail-section-title">Yardages</div>
      <div id="yardageRow" class="yardage-row">
        <span class="muted">No course selected.</span>
      </div>

      <!-- ROUND SCORE STRIP -->
      <div class="detail-section-title">Round Scorecard</div>
      <div id="scoreBubbles" class="score-bubbles">
        <span class="muted">Select a course to show the scorecard.</span>
      </div>

      <!-- HOLE IMAGE + GPS OVERLAY -->
      <div class="detail-section-title">Hole Image & GPS</div>
      <div class="hole-image-card">
        <div class="hole-image-wrapper">
          <img id="holeImage" src="" alt="Hole layout" style="display:none;" />
          <div id="holeImageOverlay" class="hole-image-overlay">
            Waiting for GPS…
          </div>
        </div>
        <div id="holeImageCaption" class="hole-image-caption">
          No image set for this hole yet.
        </div>
      </div>

      <div class="detail-section-title">Shot Stats</div>

      <div class="stats-grid">
        <div class="field">
          <label for="fairwayResult">Fairway</label>
          <select id="fairwayResult">
            <option value="">—</option>
            <option value="hit">Hit</option>
            <option value="miss-left">Miss left</option>
            <option value="miss-right">Miss right</option>
            <option value="na">N/A</option>
          </select>
        </div>

        <div class="field">
          <label for="girResult">GIR</label>
          <select id="girResult">
            <option value="">—</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
            <option value="na">N/A</option>
          </select>
        </div>

        <div class="field">
          <label for="shotShape">Shot shape</label>
          <select id="shotShape">
            <option value="">—</option>
            <option value="straight">Straight</option>
            <option value="draw">Draw</option>
            <option value="fade">Fade</option>
            <option value="hook">Hook</option>
            <option value="slice">Slice</option>
            <option value="other">Other</option>
          </select>
        </div>

        <!-- Tee club -->
        <div class="field">
          <label for="teeClub">Tee club</label>
          <select id="teeClub">
            <option value="">—</option>
            <option value="Driver">Driver</option>
            <option value="3W">3-wood</option>
            <option value="5W">5-wood</option>
            <option value="7W">7-wood</option>
            <option value="3H">3-hybrid</option>
            <option value="4H">4-hybrid</option>
            <option value="5H">5-hybrid</option>
            <option value="4i">4-iron</option>
            <option value="5i">5-iron</option>
            <option value="6i">6-iron</option>
            <option value="7i">7-iron</option>
            <option value="8i">8-iron</option>
            <option value="9i">9-iron</option>
            <option value="PW">Pitching wedge</option>
            <option value="GW">Gap wedge</option>
            <option value="SW">Sand wedge</option>
            <option value="LW">Lob wedge</option>
            <option value="Putter">Putter</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <!-- Approach club -->
        <div class="field">
          <label for="approachClub">Approach club</label>
          <select id="approachClub">
            <option value="">—</option>
            <option value="Driver">Driver</option>
            <option value="3W">3-wood</option>
            <option value="5W">5-wood</option>
            <option value="7W">7-wood</option>
            <option value="3H">3-hybrid</option>
            <option value="4H">4-hybrid</option>
            <option value="5H">5-hybrid</option>
            <option value="4i">4-iron</option>
            <option value="5i">5-iron</option>
            <option value="6i">6-iron</option>
            <option value="7i">7-iron</option>
            <option value="8i">8-iron</option>
            <option value="9i">9-iron</option>
            <option value="PW">Pitching wedge</option>
            <option value="GW">Gap wedge</option>
            <option value="SW">Sand wedge</option>
            <option value="LW">Lob wedge</option>
            <option value="Putter">Putter</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="field">
          <label for="numPutts">Putts</label>
          <select id="numPutts">
            <option value="">—</option>
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6+</option>
          </select>
        </div>

        <div class="field">
          <label for="numChips">Chips / pitches</label>
          <select id="numChips">
            <option value="">—</option>
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4+</option>
          </select>
        </div>

        <div class="field">
          <label for="numBunkers">Bunker shots</label>
          <select id="numBunkers">
            <option value="">—</option>
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3+</option>
          </select>
        </div>

        <!-- SCORE FIELD -->
        <div class="field">
          <label for="holeScore">Score</label>
          <select id="holeScore">
            <option value="">—</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12+</option>
          </select>
        </div>
      </div>

      <textarea
        id="holeNotes"
        class="hole-notes"
        placeholder="Notes specific to this hole today – wind, pin, club choice, etc."
      ></textarea>
    </section>

    <!-- RIGHT: GPS map + weather + flyover + caddy notes + summaries + goals + club recommender -->
    <section class="panel">
      <h2>On-Course View</h2>
      <small id="onCourseSubtitle">Per-hole GPS, flyover, and notes.</small>

      <div class="map-card">
        <div class="map-header-row">
          <div class="detail-section-title" style="margin:0;">GPS Map</div>
          <button type="button" class="btn" id="btnRefreshGPS">Refresh GPS</button>
        </div>
        <div id="holeMap"></div>
        <div id="gpsReadout">
          Select a course and hole to see GPS info.
        </div>
      </div>

      <!-- WEATHER CARD -->
      <div class="media-card" id="weatherCard">
        <h3>Today's Conditions</h3>
        <div id="weatherContent" class="media-note">
          Loading weather for this hole…
        </div>
      </div>

      <div class="media-card" id="flyoverCard">
        <h3>Flyover</h3>
        <div id="flyoverBody" class="media-note">
          No flyover set for this hole yet.
        </div>
      </div>

      <div class="media-card" id="caddyCard">
        <h3>Caddy Notes</h3>
        <div id="caddyBody" class="media-note">
          No notes for this hole yet. Add a <code>"notes"</code> or <code>"tips"</code> field for this hole in <code>holes.json</code>.
        </div>
      </div>

      <div class="media-card" id="roundSummaryCard">
        <h3>Round Summary</h3>
        <div id="roundSummaryBody" class="media-note">
          Start saving stats to see a summary for this round.
        </div>
      </div>

      <!-- GOALS CARD -->
      <div class="media-card" id="goalsCard">
        <h3>Today's Goals</h3>
        <div id="goalsIntro" class="media-note">
          Track your fairways, GIR, and putting against your goals for the day.
        </div>

        <div class="goal-row">
          <div class="goal-row-top">
            <span class="goal-label">Fairways hit</span>
            <span class="goal-value" id="goalFairwayText">-- / --</span>
          </div>
          <div class="goal-bar-outer">
            <div class="goal-bar-inner" id="goalFairwayBar"></div>
          </div>
        </div>

        <div class="goal-row">
          <div class="goal-row-top">
            <span class="goal-label">GIR</span>
            <span class="goal-value" id="goalGirText">-- / --</span>
          </div>
          <div class="goal-bar-outer">
            <div class="goal-bar-inner" id="goalGirBar"></div>
          </div>
        </div>

        <div class="goal-row">
          <div class="goal-row-top">
            <span class="goal-label">Putts per hole</span>
            <span class="goal-value" id="goalPuttsText">-- / --</span>
          </div>
          <div class="goal-bar-outer">
            <div class="goal-bar-inner" id="goalPuttsBar"></div>
          </div>
        </div>

        <details class="goal-edit">
          <summary>Edit goals</summary>
          <div class="goal-edit-row">
            <label>
              Fairways goal (%)
              <input type="number" id="goalFairwayInput" min="0" max="100" step="1" />
            </label>
            <label>
              GIR goal (%)
              <input type="number" id="goalGirInput" min="0" max="100" step="1" />
            </label>
            <label>
              Putts / hole
              <input type="number" id="goalPuttsInput" min="1" max="5" step="0.1" />
            </label>
          </div>
          <button type="button" class="btn" id="btnSaveGoals">Save goals</button>
          <div class="media-note">
            Goals are saved on this device and applied to all rounds.
          </div>
        </details>
      </div>

      <div class="media-card" id="holeHistoryCard">
        <h3>Hole History</h3>
        <div id="holeHistoryBody" class="media-note">
          Play and save a few rounds to see trends on this hole.
        </div>
      </div>

      <!-- Club recommendation + bag distances -->
      <div class="media-card" id="clubRecommenderCard">
        <h3>Club Recommendation</h3>
        <div class="club-rec-section">
          <div class="field-row">
            <label for="targetDistance">
              Target distance (yds)
              <input type="number" id="targetDistance" inputmode="numeric" min="1" step="1" />
            </label>
            <button type="button" class="btn" id="btnUseGpsDistance">Use GPS</button>
          </div>
          <button type="button" class="btn btn-primary" id="btnRecommendClub">Recommend club</button>
          <div id="clubRecResult" class="media-note" style="margin-top:4px;">
            Enter or pull a distance to get a suggestion.
          </div>
        </div>

        <div class="detail-section-title" style="margin-top:8px;">My Bag Distances</div>
        <div class="media-note">
          Approximate carry distances (yards). Saved locally on this device.
        </div>
        <div class="bag-grid" id="bagGrid">
          <div class="bag-grid-row">
            <span>Driver</span>
            <input type="number" class="club-distance-input" data-club-id="Driver" min="1" step="1" placeholder="yds" />
          </div>
          <div class="bag-grid-row">
            <span>3-wood</span>
            <input type="number" class="club-distance-input" data-club-id="3W" min="1" step="1" placeholder="yds" />
          </div>
          <div class="bag-grid-row">
            <span>5-wood</span>
            <input type="number" class="club-distance-input" data-club-id="5W" min="1" step="1" placeholder="yds" />
          </div>
          <div class="bag-grid-row">
            <span>7-wood</span>
            <input type="number" class="club-distance-input" data-club-id="7W" min="1" step="1" placeholder="yds" />
          </div>

          <div class="bag-grid-row">
            <span>3-hybrid</span>
            <input type="number" class="club-distance-input" data-club-id="3H" min="1" step="1" placeholder="yds" />
          </div>
          <div class="bag-grid-row">
            <span>4-hybrid</span>
            <input type="number" class="club-distance-input" data-club-id="4H" min="1" step="1" placeholder="yds" />
          </div>
          <div class="bag-grid-row">
            <span>5-hybrid</span>
            <input type="number" class="club-distance-input" data-club-id="5H" min="1" step="1" placeholder="yds" />
          </div>

          <div class="bag-grid-row">
            <span>4-iron</span>
            <input type="number" class="club-distance-input" data-club-id="4i" min="1" step="1" placeholder="yds" />
          </div>
          <div class="bag-grid-row">
            <span>5-iron</span>
            <input type="number" class="club-distance-input" data-club-id="5i" min="1" step="1" placeholder="yds" />
          </div>
          <div class="bag-grid-row">
            <span>6-iron</span>
            <input type="number" class="club-distance-input" data-club-id="6i" min="1" step="1" placeholder="yds" />
          </div>
          <div class="bag-grid-row">
            <span>7-iron</span>
            <input type="number" class="club-distance-input" data-club-id="7i" min="1" step="1" placeholder="yds" />
          </div>
          <div class="bag-grid-row">
            <span>8-iron</span>
            <input type="number" class="club-distance-input" data-club-id="8i" min="1" step="1" placeholder="yds" />
          </div>
          <div class="bag-grid-row">
            <span>9-iron</span>
            <input type="number" class="club-distance-input" data-club-id="9i" min="1" step="1" placeholder="yds" />
          </div>

          <div class="bag-grid-row">
            <span>PW</span>
            <input type="number" class="club-distance-input" data-club-id="PW" min="1" step="1" placeholder="yds" />
          </div>
          <div class="bag-grid-row">
            <span>GW</span>
            <input type="number" class="club-distance-input" data-club-id="GW" min="1" step="1" placeholder="yds" />
          </div>
          <div class="bag-grid-row">
            <span>SW</span>
            <input type="number" class="club-distance-input" data-club-id="SW" min="1" step="1" placeholder="yds" />
          </div>
          <div class="bag-grid-row">
            <span>LW</span>
            <input type="number" class="club-distance-input" data-club-id="LW" min="1" step="1" placeholder="yds" />
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const COURSES_INDEX_PATH = "data/courses.json";

    function fetchJSON(path) {
      return fetch(path).then(function(res) {
        if (!res.ok) throw new Error("HTTP " + res.status + " for " + path);
        return res.json();
      });
    }

    function distanceInYards(lat1, lng1, lat2, lng2) {
      const R = 6371000; // meters
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLng / 2) * Math.sin(dLng / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      const meters = R * c;
      return Math.round(meters * 1.09361); // yards
    }

    // ===== BAG DISTANCES / CLUB RECOMMENDER =====
    const BAG_STORAGE_KEY = "localGolfScorebook_bag_v1";
    const CLUB_LABELS = {
      "Driver": "Driver",
      "3W": "3-wood",
      "5W": "5-wood",
      "7W": "7-wood",
      "3H": "3-hybrid",
      "4H": "4-hybrid",
      "5H": "5-hybrid",
      "4i": "4-iron",
      "5i": "5-iron",
      "6i": "6-iron",
      "7i": "7-iron",
      "8i": "8-iron",
      "9i": "9-iron",
      "PW": "Pitching wedge",
      "GW": "Gap wedge",
      "SW": "Sand wedge",
      "LW": "Lob wedge",
      "Putter": "Putter"
    };

    let bagDistances = {};

    function loadBagDistances() {
      try {
        const raw = localStorage.getItem(BAG_STORAGE_KEY);
        if (!raw) {
          bagDistances = {};
          return;
        }
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === "object") {
          bagDistances = parsed;
        } else {
          bagDistances = {};
        }
      } catch (e) {
        console.warn("[bag] Failed to load bag distances", e);
        bagDistances = {};
      }
    }

    function saveBagDistances() {
      try {
        localStorage.setItem(BAG_STORAGE_KEY, JSON.stringify(bagDistances));
      } catch (e) {
        console.warn("[bag] Failed to save bag distances", e);
      }
    }

    function applyBagDistancesToInputs() {
      const inputs = document.querySelectorAll(".club-distance-input");
      inputs.forEach(function(input) {
        const id = input.getAttribute("data-club-id");
        if (!id) return;
        const stored = bagDistances[id];
        if (typeof stored === "number" && !Number.isNaN(stored)) {
          input.value = String(stored);
        }
      });
    }

    function syncSingleBagInput(input) {
      if (!input) return;
      const id = input.getAttribute("data-club-id");
      if (!id) return;
      const v = parseInt(input.value || "", 10);
      if (!Number.isNaN(v) && v > 0) {
        bagDistances[id] = v;
      } else {
        delete bagDistances[id];
      }
      saveBagDistances();
    }

    function recommendClubForDistance(targetYards) {
      const entries = Object.entries(bagDistances)
        .filter(function(pair) {
          const v = pair[1];
          return typeof v === "number" && !Number.isNaN(v) && v > 0;
        })
        .sort(function(a, b) {
          return a[1] - b[1];
        });

      if (!entries.length) return null;

      // Default to longest club
      let best = entries[entries.length - 1];

      // First club that carries at least target
      for (let i = 0; i < entries.length; i++) {
        const [id, dist] = entries[i];
        if (dist >= targetYards) {
          best = entries[i];
          break;
        }
      }

      // Nearest shorter and longer options for context
      let shorter = null;
      let longer = null;

      for (let i = entries.length - 1; i >= 0; i--) {
        if (entries[i][1] < targetYards) {
          shorter = entries[i];
          break;
        }
      }

      for (let i = 0; i < entries.length; i++) {
        if (entries[i][1] > best[1]) {
          longer = entries[i];
          break;
        }
      }

      return { best, shorter, longer };
    }

    // ===== GOALS STORAGE =====
    const GOALS_STORAGE_KEY = "localGolfScorebook_goals_v1";
    let goals = {
      fairwayPct: 60,
      girPct: 40,
      puttsPerHole: 2.0
    };
    let lastSummaryMetrics = null;

    function loadGoals() {
      try {
        const raw = localStorage.getItem(GOALS_STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== "object") return;
        if (typeof parsed.fairwayPct === "number") goals.fairwayPct = parsed.fairwayPct;
        if (typeof parsed.girPct === "number") goals.girPct = parsed.girPct;
        if (typeof parsed.puttsPerHole === "number") goals.puttsPerHole = parsed.puttsPerHole;
      } catch (e) {
        console.warn("[goals] Failed to load goals", e);
      }
    }

    function saveGoals() {
      try {
        localStorage.setItem(GOALS_STORAGE_KEY, JSON.stringify(goals));
      } catch (e) {
        console.warn("[goals] Failed to save goals", e);
      }
    }

    function applyGoalsToInputs() {
      const fairwayInput = document.getElementById("goalFairwayInput");
      const girInput = document.getElementById("goalGirInput");
      const puttsInput = document.getElementById("goalPuttsInput");

      if (fairwayInput) fairwayInput.value = goals.fairwayPct;
      if (girInput) girInput.value = goals.girPct;
      if (puttsInput) puttsInput.value = goals.puttsPerHole.toFixed(1);
    }

    function setPercentGoal(actualPct, goalPct, barEl, textEl) {
      if (!barEl || !textEl) return;

      if (!goalPct || goalPct <= 0) {
        barEl.style.width = "0%";
        barEl.classList.remove("goal-met", "goal-behind");
        textEl.textContent = "-- / --";
        return;
      }

      if (actualPct == null) {
        barEl.style.width = "0%";
        barEl.classList.remove("goal-met", "goal-behind");
        textEl.textContent = "-- / " + goalPct + "%";
        return;
      }

      const displayActual = Math.round(actualPct);
      textEl.textContent = displayActual + "% / " + goalPct + "%";

      let progress = (actualPct / goalPct) * 100;
      progress = Math.max(0, Math.min(130, progress));
      barEl.style.width = progress + "%";

      barEl.classList.remove("goal-met", "goal-behind");
      if (actualPct >= goalPct) {
        barEl.classList.add("goal-met");
      } else {
        barEl.classList.add("goal-behind");
      }
    }

    function setPuttsGoal(actualPutts, goalPutts, barEl, textEl) {
      if (!barEl || !textEl) return;

      if (!goalPutts || goalPutts <= 0) {
        barEl.style.width = "0%";
        barEl.classList.remove("goal-met", "goal-behind");
        textEl.textContent = "-- / --";
        return;
      }

      if (actualPutts == null) {
        barEl.style.width = "0%";
        barEl.classList.remove("goal-met", "goal-behind");
        textEl.textContent = "-- / " + goalPutts.toFixed(1);
        return;
      }

      textEl.textContent = actualPutts.toFixed(2) + " / " + goalPutts.toFixed(1);

      // lower is better -> if actual <= goal, we consider goal met
      let progress = (goalPutts / actualPutts) * 100;
      progress = Math.max(0, Math.min(130, progress));
      barEl.style.width = progress + "%";

      barEl.classList.remove("goal-met", "goal-behind");
      if (actualPutts <= goalPutts) {
        barEl.classList.add("goal-met");
      } else {
        barEl.classList.add("goal-behind");
      }
    }

    function updateGoalsProgress(metrics) {
      const fairwayBar = document.getElementById("goalFairwayBar");
      const fairwayText = document.getElementById("goalFairwayText");
      const girBar = document.getElementById("goalGirBar");
      const girText = document.getElementById("goalGirText");
      const puttsBar = document.getElementById("goalPuttsBar");
      const puttsText = document.getElementById("goalPuttsText");

      if (!metrics) {
        setPercentGoal(null, goals.fairwayPct, fairwayBar, fairwayText);
        setPercentGoal(null, goals.girPct, girBar, girText);
        setPuttsGoal(null, goals.puttsPerHole, puttsBar, puttsText);
        return;
      }

      const fairwayPctActual = metrics.fairwayOpp
        ? (metrics.fairwayHit / metrics.fairwayOpp) * 100
        : null;

      const girPctActual = metrics.girOpp
        ? (metrics.girHit / metrics.girOpp) * 100
        : null;

      const puttsPerHoleActual = metrics.puttEntries
        ? metrics.totalPutts / metrics.puttEntries
        : null;

      setPercentGoal(fairwayPctActual, goals.fairwayPct, fairwayBar, fairwayText);
      setPercentGoal(girPctActual, goals.girPct, girBar, girText);
      setPuttsGoal(puttsPerHoleActual, goals.puttsPerHole, puttsBar, puttsText);
    }

    // ===== Leaflet map state =====
    let leafMap = null;
    let playerMarker = null;
    let targetMarker = null;
    let teeMarker = null;
    let teeToGreenLine = null;
    let teeDistLabelMarker = null;

    let clickMarker = null;
    let clickToGreenLine = null;
    let clickDistLabelMarker = null;

    // tee → selected point
    let teeToClickLine = null;
    let teeToClickLabelMarker = null;

    let currentGpsTarget = null; // green center
    let currentTeePoint = null;  // tee coordinate (if present)
    let gpsWatchId = null;

    // distance cache for combined readout
    const lastDistances = {
      teeToGreen: null,
      playerToGreen: null,
      clickToGreen: null,
      teeToClick: null
    };

    function updateDistanceReadout() {
      const readout = document.getElementById("gpsReadout");
      if (!readout) return;

      if (!currentGpsTarget) {
        readout.textContent = "No GPS data set for this hole yet.";
        return;
      }

      const parts = [];
      if (lastDistances.teeToGreen != null) {
        parts.push("Tee→Green: " + lastDistances.teeToGreen + " yds");
      }
      if (lastDistances.playerToGreen != null) {
        parts.push("You→Green: " + lastDistances.playerToGreen + " yds");
      }
      if (lastDistances.clickToGreen != null) {
        parts.push("Selected→Green: " + lastDistances.clickToGreen + " yds");
      }
      if (lastDistances.teeToClick != null) {
        parts.push("Tee→Selected: " + lastDistances.teeToClick + " yds");
      }

      if (parts.length) {
        readout.textContent = parts.join("  |  ");
      } else {
        readout.textContent =
          "Tap Refresh GPS or click the map to measure distances.";
      }
    }

    function onMapClick(e) {
      if (!leafMap || !currentGpsTarget) return;

      const latlng = e.latlng;

      // Clear previous selected marker / line / label
      if (clickMarker) {
        leafMap.removeLayer(clickMarker);
        clickMarker = null;
      }
      if (clickToGreenLine) {
        leafMap.removeLayer(clickToGreenLine);
        clickToGreenLine = null;
      }
      if (clickDistLabelMarker) {
        leafMap.removeLayer(clickDistLabelMarker);
        clickDistLabelMarker = null;
      }
      if (teeToClickLine) {
        leafMap.removeLayer(teeToClickLine);
        teeToClickLine = null;
      }
      if (teeToClickLabelMarker) {
        leafMap.removeLayer(teeToClickLabelMarker);
        teeToClickLabelMarker = null;
      }

      // Marker at clicked point
      clickMarker = L.marker(latlng)
        .addTo(leafMap)
        .bindPopup("Selected point");

      // Line from clicked point to green
      clickToGreenLine = L.polyline(
        [
          [latlng.lat, latlng.lng],
          [currentGpsTarget.lat, currentGpsTarget.lng]
        ],
        {
          color: "#d97706",
          weight: 4,
          dashArray: "4 4"
        }
      ).addTo(leafMap);

      // Distance + midpoint label (selected → green)
      const yards = distanceInYards(
        latlng.lat,
        latlng.lng,
        currentGpsTarget.lat,
        currentGpsTarget.lng
      );

      const midLat = (latlng.lat + currentGpsTarget.lat) / 2;
      const midLng = (latlng.lng + currentGpsTarget.lng) / 2;

      clickDistLabelMarker = L.marker([midLat, midLng], {
        interactive: false,
        icon: L.divIcon({
          className: "distance-label",
          html: yards + " yds",
          iconSize: [0, 0]
        })
      }).addTo(leafMap);

      lastDistances.clickToGreen = yards;

      // tee → selected point
      if (currentTeePoint) {
        teeToClickLine = L.polyline(
          [
            [currentTeePoint.lat, currentTeePoint.lng],
            [latlng.lat, latlng.lng]
          ],
          {
            color: "#059669",
            weight: 3,
            dashArray: "2 4"
          }
        ).addTo(leafMap);

        const yardsTC = distanceInYards(
          currentTeePoint.lat,
          currentTeePoint.lng,
          latlng.lat,
          latlng.lng
        );
        lastDistances.teeToClick = yardsTC;

        const midLatTC = (currentTeePoint.lat + latlng.lat) / 2;
        const midLngTC = (currentTeePoint.lng + latlng.lng) / 2;

        teeToClickLabelMarker = L.marker([midLatTC, midLngTC], {
          interactive: false,
          icon: L.divIcon({
            className: "distance-label",
            html: yardsTC + " yds",
            iconSize: [0, 0]
          })
        }).addTo(leafMap);
      } else {
        lastDistances.teeToClick = null;
      }

      updateDistanceReadout();
    }

    function initHoleMap(gps) {
      const mapEl = document.getElementById("holeMap");
      if (!mapEl) return;

      // reset distance cache specific to this hole
      lastDistances.teeToGreen = null;
      lastDistances.clickToGreen = null;
      lastDistances.teeToClick = null;

      // Clear previous tee / lines / selected point / labels
      if (leafMap) {
        if (teeMarker) {
          leafMap.removeLayer(teeMarker);
          teeMarker = null;
        }
        if (teeToGreenLine) {
          leafMap.removeLayer(teeToGreenLine);
          teeToGreenLine = null;
        }
        if (teeDistLabelMarker) {
          leafMap.removeLayer(teeDistLabelMarker);
          teeDistLabelMarker = null;
        }
        if (clickMarker) {
          leafMap.removeLayer(clickMarker);
          clickMarker = null;
        }
        if (clickToGreenLine) {
          leafMap.removeLayer(clickToGreenLine);
          clickToGreenLine = null;
        }
        if (clickDistLabelMarker) {
          leafMap.removeLayer(clickDistLabelMarker);
          clickDistLabelMarker = null;
        }
        if (teeToClickLine) {
          leafMap.removeLayer(teeToClickLine);
          teeToClickLine = null;
        }
        if (teeToClickLabelMarker) {
          leafMap.removeLayer(teeToClickLabelMarker);
          teeToClickLabelMarker = null;
        }
      }

      if (
        !gps ||
        !gps.greenCenter ||
        typeof gps.greenCenter.lat !== "number" ||
        typeof gps.greenCenter.lng !== "number"
      ) {
        currentGpsTarget = null;
        currentTeePoint = null;
        updateDistanceReadout();
        return;
      }

      const green = gps.greenCenter;
      const tee =
        gps.tee &&
        typeof gps.tee.lat === "number" &&
        typeof gps.tee.lng === "number"
          ? gps.tee
          : null;

      currentGpsTarget = green;
      currentTeePoint = tee;

      if (!leafMap) {
        leafMap = L.map("holeMap");
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap"
        }).addTo(leafMap);
        leafMap.on("click", onMapClick);
      }

      // Fit map to show tee + green if both exist, otherwise center on green
      if (tee) {
        const bounds = L.latLngBounds(
          [tee.lat, tee.lng],
          [green.lat, green.lng]
        );
        leafMap.fitBounds(bounds, { padding: [20, 20] });

        // tee marker
        teeMarker = L.marker([tee.lat, tee.lng])
          .addTo(leafMap)
          .bindPopup("Tee");

        // dashed line tee -> green
        teeToGreenLine = L.polyline(
          [
            [tee.lat, tee.lng],
            [green.lat, green.lng]
          ],
          {
            color: "#111827",
            weight: 4,
            dashArray: "6 4"
          }
        ).addTo(leafMap);

        // Distance + midpoint label
        const yards = distanceInYards(tee.lat, tee.lng, green.lat, green.lng);
        lastDistances.teeToGreen = yards;

        const midLat = (tee.lat + green.lat) / 2;
        const midLng = (tee.lng + green.lng) / 2;

        teeDistLabelMarker = L.marker([midLat, midLng], {
          interactive: false,
          icon: L.divIcon({
            className: "distance-label",
            html: yards + " yds",
            iconSize: [0, 0]
          })
        }).addTo(leafMap);
      } else {
        leafMap.setView([green.lat, green.lng], 17);
      }

      // green marker
      if (targetMarker) {
        leafMap.removeLayer(targetMarker);
      }
      targetMarker = L.marker([green.lat, green.lng])
        .addTo(leafMap)
        .bindPopup("Green center");

      updateDistanceReadout();
    }

    function startGpsWatch() {
      if (!navigator.geolocation) return;
      if (gpsWatchId !== null) return; // already running

      gpsWatchId = navigator.geolocation.watchPosition(
        function(pos) {
          if (!currentGpsTarget) return;

          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          if (leafMap) {
            if (playerMarker) leafMap.removeLayer(playerMarker);
            playerMarker = L.marker([lat, lng])
              .addTo(leafMap)
              .bindPopup("You");
          }

          const yards = distanceInYards(
            lat,
            lng,
            currentGpsTarget.lat,
            currentGpsTarget.lng
          );
          lastDistances.playerToGreen = yards;
          updateDistanceReadout();

          const overlay = document.getElementById("holeImageOverlay");
          if (overlay) {
            overlay.style.display = "inline-flex";
            overlay.textContent = "You→Green: " + yards + " yds";
          }
        },
        function(err) {
          console.warn("GPS watch error", err);
        },
        { enableHighAccuracy: true }
      );
    }

    // One-shot update (used by Refresh button)
    function updateGpsDistance() {
      if (!currentGpsTarget) {
        updateDistanceReadout();
        return;
      }
      if (!navigator.geolocation) {
        updateDistanceReadout();
        return;
      }

      navigator.geolocation.getCurrentPosition(
        function(pos) {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          if (leafMap) {
            if (playerMarker) leafMap.removeLayer(playerMarker);
            playerMarker = L.marker([lat, lng])
              .addTo(leafMap)
              .bindPopup("You");
          }

          const yards = distanceInYards(
            lat,
            lng,
            currentGpsTarget.lat,
            currentGpsTarget.lng
          );
          lastDistances.playerToGreen = yards;
          updateDistanceReadout();

          const overlay = document.getElementById("holeImageOverlay");
          if (overlay) {
            overlay.style.display = "inline-flex";
            overlay.textContent = "You→Green: " + yards + " yds";
          }
        },
        function(err) {
          console.warn("GPS error", err);
        },
        { enableHighAccuracy: true }
      );
    }

    (function initPage() {
      const params = new URLSearchParams(window.location.search);
      const urlCourse = params.get("course") || "";
      const urlHole = parseInt(params.get("hole") || "1", 10);

      const courseSelect = document.getElementById("courseSelect");
      const holeSelect = document.getElementById("holeSelect");
      const courseNameEl = document.getElementById("courseName");
      const courseLocEl = document.getElementById("courseLocation");
      const holeLabelEl = document.getElementById("holeLabel");
      const yardageRowEl = document.getElementById("yardageRow");
      const scoreBubblesEl = document.getElementById("scoreBubbles");
      const flyoverBody = document.getElementById("flyoverBody");
      const caddyBody = document.getElementById("caddyBody");
      const prevBtn = document.getElementById("btnPrevHole");
      const nextBtn = document.getElementById("btnNextHole");
      const refreshGpsBtn = document.getElementById("btnRefreshGPS");

      const holeImageEl = document.getElementById("holeImage");
      const holeImageOverlay = document.getElementById("holeImageOverlay");
      const holeImageCaption = document.getElementById("holeImageCaption");

      // Round + stats field refs
      const roundSelect = document.getElementById("roundSelect");
      const newRoundBtn = document.getElementById("btnNewRound");
      const deleteRoundBtn = document.getElementById("btnDeleteRound");

      const fairwayResultEl = document.getElementById("fairwayResult");
      const girResultEl = document.getElementById("girResult");
      const shotShapeEl = document.getElementById("shotShape");
      const teeClubEl = document.getElementById("teeClub");
      const approachClubEl = document.getElementById("approachClub");
      const numPuttsEl = document.getElementById("numPutts");
      const numChipsEl = document.getElementById("numChips");
      const numBunkersEl = document.getElementById("numBunkers");
      const holeScoreEl = document.getElementById("holeScore");
      const holeNotesEl = document.getElementById("holeNotes");

      // Summary / history elements
      const roundSummaryBody = document.getElementById("roundSummaryBody");
      const holeHistoryBody = document.getElementById("holeHistoryBody");

      // Goals elements
      const btnSaveGoals = document.getElementById("btnSaveGoals");

      // Weather element
      const weatherContentEl = document.getElementById("weatherContent");

      // Club recommender elements
      const targetDistanceEl = document.getElementById("targetDistance");
      const btnUseGpsDistance = document.getElementById("btnUseGpsDistance");
      const btnRecommendClub = document.getElementById("btnRecommendClub");
      const clubRecResultEl = document.getElementById("clubRecResult");
      const bagInputs = document.querySelectorAll(".club-distance-input");

      let loadedCourse = null;
      let loadedHoles = [];
      let currentHoleNum = Number.isFinite(urlHole) && urlHole > 0 ? urlHole : 1;
      let maxHole = 0;

      // ===== ROUND STORAGE (localStorage) =====
      const STORAGE_KEY = "localGolfScorebook_rounds_v1";

      let roundsState = {
        rounds: [],
        activeRoundId: null
      };

      function loadRoundsState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return;
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== "object") return;
          if (!Array.isArray(parsed.rounds)) return;
          roundsState.rounds = parsed.rounds;
          roundsState.activeRoundId = parsed.activeRoundId || null;
        } catch (e) {
          console.warn("[rounds] Failed to load state", e);
        }
      }

      function saveRoundsState() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(roundsState));
        } catch (e) {
          console.warn("[rounds] Failed to save state", e);
        }
      }

      function findActiveRound() {
        if (!roundsState.activeRoundId) return null;
        return roundsState.rounds.find(r => r.id === roundsState.activeRoundId) || null;
      }

      function rebuildRoundSelect() {
        if (!roundSelect) return;

        const rounds = roundsState.rounds;
        if (!rounds.length) {
          roundSelect.innerHTML = "<option value=''>No rounds yet</option>";
          return;
        }

        let html = "";
        rounds.forEach(function(r) {
          html += "<option value='" + r.id + "'>" + (r.name || "Unnamed round") + "</option>";
        });
        roundSelect.innerHTML = html;

        if (roundsState.activeRoundId) {
          roundSelect.value = roundsState.activeRoundId;
        } else {
          roundsState.activeRoundId = rounds[0].id;
          roundSelect.value = rounds[0].id;
          saveRoundsState();
        }
      }

      function createNewRoundName(courseObj) {
        const today = new Date().toISOString().slice(0, 10);
        const courseName =
          (courseObj && courseObj.name) ||
          (courseSelect &&
            courseSelect.options[courseSelect.selectedIndex] &&
            courseSelect.options[courseSelect.selectedIndex].text) ||
          "Practice";
        return courseName + " – " + today;
      }

      function createNewRound(courseObj) {
        const id = "r_" + Date.now();
        const name = createNewRoundName(courseObj);
        const courseId =
          (courseObj && courseObj.id) ||
          (courseSelect && courseSelect.value) ||
          "";

        const round = {
          id: id,
          name: name,
          createdAt: new Date().toISOString(),
          courseId: courseId || null,
          holes: {} // key: courseId + ":H" + holeNum
        };

        roundsState.rounds.push(round);
        roundsState.activeRoundId = id;
        saveRoundsState();
        rebuildRoundSelect();
        return round;
      }

      function ensureAtLeastOneRound() {
        if (!roundsState.rounds.length) {
          createNewRound(null);
        } else if (!roundsState.activeRoundId) {
          roundsState.activeRoundId = roundsState.rounds[0].id;
          saveRoundsState();
        }
        rebuildRoundSelect();
      }

      function makeHoleKey(courseId, holeNum) {
        const cid = courseId || (loadedCourse && loadedCourse.id) || "unknown";
        return cid + ":H" + holeNum;
      }

      function clearHoleControls() {
        if (fairwayResultEl) fairwayResultEl.value = "";
        if (girResultEl) girResultEl.value = "";
        if (shotShapeEl) shotShapeEl.value = "";
        if (teeClubEl) teeClubEl.value = "";
        if (approachClubEl) approachClubEl.value = "";
        if (numPuttsEl) numPuttsEl.value = "";
        if (numChipsEl) numChipsEl.value = "";
        if (numBunkersEl) numBunkersEl.value = "";
        if (holeScoreEl) holeScoreEl.value = "";
        if (holeNotesEl) holeNotesEl.value = "";
      }

      function applyHoleStateFromRound(courseId, holeNum) {
        const round = findActiveRound();
        if (!round) {
          clearHoleControls();
          return;
        }
        const key = makeHoleKey(courseId, holeNum);
        const data = round.holes && round.holes[key];

        if (!data) {
          clearHoleControls();
          return;
        }

        if (fairwayResultEl) fairwayResultEl.value = data.fairwayResult || "";
        if (girResultEl) girResultEl.value = data.girResult || "";
        if (shotShapeEl) shotShapeEl.value = data.shotShape || "";
        if (teeClubEl) teeClubEl.value = data.teeClub || "";
        if (approachClubEl) approachClubEl.value = data.approachClub || "";
        if (numPuttsEl) numPuttsEl.value = data.numPutts || "";
        if (numChipsEl) numChipsEl.value = data.numChips || "";
        if (numBunkersEl) numBunkersEl.value = data.numBunkers || "";
        if (holeScoreEl) holeScoreEl.value = data.score || "";
        if (holeNotesEl) holeNotesEl.value = data.notes || "";
      }

      function saveCurrentHoleState(forceCourseId) {
        const round = findActiveRound();
        if (!round) return;

        const courseId =
          forceCourseId ||
          (courseSelect && courseSelect.value) ||
          (loadedCourse && loadedCourse.id) ||
          "unknown";

        const holeNum = currentHoleNum || 1;
        const key = makeHoleKey(courseId, holeNum);

        if (!round.holes) round.holes = {};

        round.holes[key] = {
          fairwayResult: fairwayResultEl ? (fairwayResultEl.value || "") : "",
          girResult: girResultEl ? (girResultEl.value || "") : "",
          shotShape: shotShapeEl ? (shotShapeEl.value || "") : "",
          teeClub: teeClubEl ? (teeClubEl.value || "") : "",
          approachClub: approachClubEl ? (approachClubEl.value || "") : "",
          numPutts: numPuttsEl ? (numPuttsEl.value || "") : "",
          numChips: numChipsEl ? (numChipsEl.value || "") : "",
          numBunkers: numBunkersEl ? (numBunkersEl.value || "") : "",
          score: holeScoreEl ? (holeScoreEl.value || "") : "",
          notes: holeNotesEl ? (holeNotesEl.value || "") : ""
        };

        // also record courseId on the round if empty
        if (!round.courseId && courseId && courseId !== "unknown") {
          round.courseId = courseId;
        }

        saveRoundsState();
      }

      function applyHoleStateForCurrentHole() {
        const courseId =
          (courseSelect && courseSelect.value) ||
          (loadedCourse && loadedCourse.id) ||
          "unknown";
        applyHoleStateFromRound(courseId, currentHoleNum || 1);
      }

      function getHoleNumber(holeObj) {
        if (!holeObj) return null;
        if (typeof holeObj.hole === "number") return holeObj.hole;
        const idx = loadedHoles.indexOf(holeObj);
        return idx >= 0 ? (idx + 1) : null;
      }

      // ===== WEATHER (per hole, using gps) =====
      function cToF(c) {
        return Math.round((c * 9) / 5 + 32);
      }

      function windDirectionFromDeg(deg) {
        if (typeof deg !== "number" || Number.isNaN(deg)) return "";
        const dirs = ["N","NE","E","SE","S","SW","W","NW"];
        const idx = Math.round(deg / 45) % 8;
        return dirs[idx];
      }

      function describeWeatherCode(code) {
        if (code == null) return "";
        if (code === 0) return "Clear";
        if (code === 1 || code === 2) return "Partly cloudy";
        if (code === 3) return "Overcast";
        if (code === 45 || code === 48) return "Foggy";
        if (code === 51 || code === 53 || code === 55) return "Drizzle";
        if (code === 56 || code === 57) return "Freezing drizzle";
        if (code === 61 || code === 63 || code === 65) return "Rain";
        if (code === 66 || code === 67) return "Freezing rain";
        if (code === 71 || code === 73 || code === 75) return "Snow";
        if (code === 77) return "Snow grains";
        if (code === 80 || code === 81 || code === 82) return "Rain showers";
        if (code === 85 || code === 86) return "Snow showers";
        if (code === 95) return "Thunderstorm";
        if (code === 96 || code === 99) return "Thunderstorm with hail";
        return "Conditions unknown";
      }

      function setWeatherMessage(msg) {
        if (!weatherContentEl) return;
        weatherContentEl.textContent = msg;
      }

      function updateWeatherForHole(hole) {
        if (!weatherContentEl) return;

        if (!hole || !hole.gps) {
          setWeatherMessage("No GPS data for this hole – weather unavailable.");
          return;
        }

        const gps = hole.gps;
        const target =
          (gps.greenCenter && typeof gps.greenCenter.lat === "number" && typeof gps.greenCenter.lng === "number")
            ? gps.greenCenter
            : (gps.tee && typeof gps.tee.lat === "number" && typeof gps.tee.lng === "number"
                ? gps.tee
                : null);

        if (!target) {
          setWeatherMessage("No usable GPS point for this hole – weather unavailable.");
          return;
        }

        setWeatherMessage("Loading weather for this hole…");

        const lat = target.lat;
        const lng = target.lng;

        const url =
          "https://api.open-meteo.com/v1/forecast" +
          "?latitude=" + encodeURIComponent(lat) +
          "&longitude=" + encodeURIComponent(lng) +
          "&current=temperature_2m,apparent_temperature,precipitation,weather_code,wind_speed_10m,wind_direction_10m";

        fetch(url)
          .then(function(res) {
            if (!res.ok) throw new Error("HTTP " + res.status);
            return res.json();
          })
          .then(function(data) {
            if (!data || !data.current) {
              setWeatherMessage("Weather data unavailable for this location.");
              return;
            }

            const cur = data.current;
            const tempF = cToF(cur.temperature_2m);
            const feelsF = cToF(cur.apparent_temperature);
            const desc = describeWeatherCode(cur.weather_code);
            const windSpeed = Math.round(cur.wind_speed_10m || 0);
            const windDir = windDirectionFromDeg(cur.wind_direction_10m);

            let html = "";

            html += "<div><strong>" + tempF + "°F</strong>";
            if (Math.abs(tempF - feelsF) >= 2) {
              html += " (feels " + feelsF + "°F)";
            }
            html += " · " + desc + "</div>";

            html += "<div>Wind: " + windSpeed + " mph";
            if (windDir) {
              html += " " + windDir;
            }
            html += "</div>";

            const precip = typeof cur.precipitation === "number" ? cur.precipitation : null;
            if (precip != null && precip > 0) {
              html += "<div>Precip: " + precip.toFixed(2) + " mm/hr currently</div>";
            }

            weatherContentEl.innerHTML = html;
          })
          .catch(function(err) {
            console.warn("[weather] error", err);
            setWeatherMessage("Could not load weather for this hole.");
          });
      }

      // ==== SUMMARY + HISTORY ====
      function renderRoundSummary() {
        if (!roundSummaryBody) return;

        const round = findActiveRound();
        if (!round || !round.holes) {
          roundSummaryBody.textContent =
            "Start saving stats to see a summary for this round.";
          lastSummaryMetrics = null;
          updateGoalsProgress(null);
          return;
        }

        const courseId =
          (courseSelect && courseSelect.value) ||
          round.courseId ||
          (loadedCourse && loadedCourse.id) ||
          "unknown";

        let scoreTotal = 0;
        let holesWithScore = 0;
        let parTotal = 0;

        let fairwayHit = 0;
        let fairwayOpp = 0;

        let girHit = 0;
        let girOpp = 0;

        let totalPutts = 0;
        let puttEntries = 0;
        let threePlusPutts = 0;

        const keys = Object.keys(round.holes);
        keys.forEach(function(key) {
          const prefix = courseId + ":H";
          if (!key.startsWith(prefix)) return;

          const data = round.holes[key];
          if (!data) return;

          const numStr = key.substring(prefix.length);
          const holeNum = parseInt(numStr, 10);
          if (!Number.isFinite(holeNum)) return;

          const holeDef = loadedHoles.find(function(h) {
            const n = getHoleNumber(h);
            return n === holeNum;
          });
          const par = holeDef && typeof holeDef.par === "number" ? holeDef.par : null;

          // Score
          if (data.score) {
            const s = parseInt(data.score, 10);
            if (!Number.isNaN(s)) {
              scoreTotal += s;
              holesWithScore++;
              if (par != null) parTotal += par;
            }
          }

          // Fairway
          if (data.fairwayResult && data.fairwayResult !== "" && data.fairwayResult !== "na") {
            fairwayOpp++;
            if (data.fairwayResult === "hit") fairwayHit++;
          }

          // GIR
          if (data.girResult && data.girResult !== "" && data.girResult !== "na") {
            girOpp++;
            if (data.girResult === "yes") girHit++;
          }

          // Putts
          if (data.numPutts) {
            const p = parseInt(data.numPutts, 10);
            if (!Number.isNaN(p)) {
              totalPutts += p;
              puttEntries++;
              if (p >= 3) threePlusPutts++;
            }
          }
        });

        if (!holesWithScore && !fairwayOpp && !girOpp && !puttEntries) {
          roundSummaryBody.textContent =
            "No stats saved yet for this round on this course.";
          lastSummaryMetrics = null;
          updateGoalsProgress(null);
          return;
        }

        let html = "<ul class='caddy-list'>";

        if (holesWithScore) {
          const avgScore = (scoreTotal / holesWithScore).toFixed(1);
          let vsParText = "";
          if (parTotal) {
            const diff = scoreTotal - parTotal;
            if (diff > 0) vsParText = " (+" + diff + " vs par)";
            else if (diff < 0) vsParText = " (" + diff + " vs par)";
            else vsParText = " (even par)";
          }
          html +=
            "<li><strong>Total score:</strong> " +
            scoreTotal +
            " over " +
            holesWithScore +
            " holes" +
            vsParText +
            "</li>";
          html +=
            "<li><strong>Avg score per hole:</strong> " + avgScore + "</li>";
        }

        if (fairwayOpp) {
          const pct = Math.round((fairwayHit / fairwayOpp) * 100);
          html +=
            "<li><strong>Fairways hit:</strong> " +
            fairwayHit +
            " / " +
            fairwayOpp +
            " (" +
            pct +
            "%)</li>";
        }

        if (girOpp) {
          const pct = Math.round((girHit / girOpp) * 100);
          html +=
            "<li><strong>GIR:</strong> " +
            girHit +
            " / " +
            girOpp +
            " (" +
            pct +
            "%)</li>";
        }

        if (puttEntries) {
          const avgPutts = (totalPutts / puttEntries).toFixed(2);
          html +=
            "<li><strong>Putts per hole:</strong> " +
            avgPutts +
            " (3+ putts on " +
            threePlusPutts +
            " holes)</li>";
        }

        html += "</ul>";

        roundSummaryBody.innerHTML = html;

        // Store metrics for goals and update progress bars
        lastSummaryMetrics = {
          fairwayHit,
          fairwayOpp,
          girHit,
          girOpp,
          totalPutts,
          puttEntries
        };
        updateGoalsProgress(lastSummaryMetrics);
      }

      function renderHoleHistory() {
        if (!holeHistoryBody) return;
        if (!loadedCourse || !loadedHoles.length) {
          holeHistoryBody.textContent =
            "Select a course and hole to see history.";
          return;
        }

        const courseId =
          (courseSelect && courseSelect.value) ||
          loadedCourse.id ||
          "unknown";
        const holeNum = currentHoleNum || 1;

        let entries = 0;
        let scoreTotal = 0;
        let fairwayHit = 0;
        let fairwayOpp = 0;
        let girHit = 0;
        let girOpp = 0;
        let totalPutts = 0;
        let puttEntries = 0;

        roundsState.rounds.forEach(function(round) {
          if (!round.holes) return;
          if (round.courseId && round.courseId !== courseId) return;

          const key = makeHoleKey(courseId, holeNum);
          const data = round.holes[key];
          if (!data) return;

          entries++;

          // Score
          if (data.score) {
            const s = parseInt(data.score, 10);
            if (!Number.isNaN(s)) {
              scoreTotal += s;
            }
          }

          // Fairway
          if (data.fairwayResult && data.fairwayResult !== "" && data.fairwayResult !== "na") {
            fairwayOpp++;
            if (data.fairwayResult === "hit") fairwayHit++;
          }

          // GIR
          if (data.girResult && data.girResult !== "" && data.girResult !== "na") {
            girOpp++;
            if (data.girResult === "yes") girHit++;
          }

          // Putts
          if (data.numPutts) {
            const p = parseInt(data.numPutts, 10);
            if (!Number.isNaN(p)) {
              totalPutts += p;
              puttEntries++;
            }
          }
        });

        if (!entries) {
          holeHistoryBody.textContent =
            "No saved history yet for this hole. Play and save a few rounds to see trends here.";
          return;
        }

        let html = "<ul class='caddy-list'>";

        if (scoreTotal) {
          const avgScore = (scoreTotal / entries).toFixed(2);
          html +=
            "<li><strong>Avg score on this hole:</strong> " +
            avgScore +
            " over " +
            entries +
            " recorded rounds</li>";
        } else {
          html +=
            "<li><strong>Avg score on this hole:</strong> not enough data yet</li>";
        }

        if (fairwayOpp) {
          const pct = Math.round((fairwayHit / fairwayOpp) * 100);
          html +=
            "<li><strong>Fairway hit:</strong> " +
            pct +
            "% of recorded tee shots</li>";
        }

        if (girOpp) {
          const pct = Math.round((girHit / girOpp) * 100);
          html +=
            "<li><strong>GIR:</strong> " +
            pct +
            "% of recorded approaches</li>";
        }

        if (puttEntries) {
          const avgPutts = (totalPutts / puttEntries).toFixed(2);
          html +=
            "<li><strong>Avg putts on this hole:</strong> " +
            avgPutts +
            "</li>";
        }

        html += "</ul>";

        holeHistoryBody.innerHTML = html;
      }

      // === SCORE STRIP (ALL HOLES) ===
      function renderScoreBubbles() {
        if (!scoreBubblesEl) return;

        if (!loadedCourse || !loadedHoles.length) {
          scoreBubblesEl.innerHTML =
            "<span class='muted'>Select a course to see the scorecard.</span>";
          return;
        }

        const round = findActiveRound();
        const courseId =
          (courseSelect && courseSelect.value) ||
          (loadedCourse && loadedCourse.id) ||
          "unknown";

        const holesCount = maxHole || loadedHoles.length || 18;

        let html = "";
        let totalPar = 0;
        let totalScore = 0;
        let haveAnyScores = false;

        for (let n = 1; n <= holesCount; n++) {
          const holeDef = loadedHoles.find(function(h, idx) {
            const num = (typeof h.hole === "number") ? h.hole : (idx + 1);
            return num === n;
          });

          const par = (holeDef && typeof holeDef.par === "number")
            ? holeDef.par
            : null;

          if (par != null) totalPar += par;

          let score = null;
          if (round && round.holes) {
            const key = makeHoleKey(courseId, n);
            const data = round.holes[key];
            if (data && data.score) {
              const s = parseInt(data.score, 10);
              if (!Number.isNaN(s)) {
                score = s;
                totalScore += s;
                haveAnyScores = true;
              }
            }
          }

          let valueText = "—";
          if (score != null && par != null) {
            const diff = score - par;
            let diffText = "E";
            if (diff > 0) diffText = "+" + diff;
            else if (diff < 0) diffText = String(diff);
            valueText = score + " (" + diffText + ")";
          } else if (score != null) {
            valueText = String(score);
          } else if (par != null) {
            valueText = "Par " + par;
          }

          const isActive = (n === currentHoleNum);
          html +=
            "<div class='score-bubble" +
            (isActive ? " score-bubble-active" : "") +
            "' data-hole-num='" + n + "'>" +
              "<div class='score-bubble-label'>H" + n + "</div>" +
              "<div class='score-bubble-value'>" + valueText + "</div>" +
            "</div>";
        }

        // Total bubble
        if (holesCount > 0) {
          let totalText = "—";
          if (haveAnyScores && totalPar > 0) {
            const diff = totalScore - totalPar;
            let diffText = "E";
            if (diff > 0) diffText = "+" + diff;
            else if (diff < 0) diffText = String(diff);
            totalText = totalScore + " (" + diffText + ")";
          } else if (haveAnyScores) {
            totalText = String(totalScore);
          } else if (totalPar > 0) {
            totalText = "Par " + totalPar;
          }

          html +=
            "<div class='score-bubble score-bubble-total' data-hole-num='total'>" +
              "<div class='score-bubble-label'>Total</div>" +
              "<div class='score-bubble-value'>" + totalText + "</div>" +
            "</div>";
        }

        scoreBubblesEl.innerHTML = html;
      }

      // Load rounds from storage and set up UI BEFORE loading courses
      loadRoundsState();
      ensureAtLeastOneRound();

      // Load goals and apply to inputs
      loadGoals();
      applyGoalsToInputs();
      updateGoalsProgress(null);

      // Load bag distances + apply to UI
      loadBagDistances();
      applyBagDistancesToInputs();

      // Wire bag inputs
      bagInputs.forEach(function(input) {
        input.addEventListener("change", function() {
          syncSingleBagInput(input);
        });
      });

      // Wire club recommender buttons
      if (btnUseGpsDistance) {
        btnUseGpsDistance.addEventListener("click", function() {
          let d = null;
          if (lastDistances.playerToGreen != null) {
            d = lastDistances.playerToGreen;
          } else if (lastDistances.clickToGreen != null) {
            d = lastDistances.clickToGreen;
          } else if (lastDistances.teeToGreen != null) {
            d = lastDistances.teeToGreen;
          }

          if (d != null && targetDistanceEl) {
            targetDistanceEl.value = d;
            if (clubRecResultEl) {
              clubRecResultEl.textContent = "Using " + d + " yds as target distance.";
            }
          } else if (clubRecResultEl) {
            clubRecResultEl.textContent =
              "No GPS distance available yet. Refresh GPS or click the map first.";
          }
        });
      }

      if (btnRecommendClub) {
        btnRecommendClub.addEventListener("click", function() {
          if (!targetDistanceEl || !clubRecResultEl) return;
          const t = parseInt(targetDistanceEl.value || "", 10);
          if (Number.isNaN(t) || t <= 0) {
            clubRecResultEl.textContent =
              "Enter a target distance in yards first.";
            return;
          }

          const rec = recommendClubForDistance(t);
          if (!rec) {
            clubRecResultEl.textContent =
              "Set at least one carry distance in your bag to get a recommendation.";
            return;
          }

          const [bestId, bestDist] = rec.best;
          const bestLabel = CLUB_LABELS[bestId] || bestId;

          let text =
            "Suggested: " +
            bestLabel +
            " (" +
            bestDist +
            " yds carry) for a " +
            t +
            " yd shot.";

          if (rec.shorter) {
            const [sid, sd] = rec.shorter;
            const sLabel = CLUB_LABELS[sid] || sid;
            text +=
              " Shorter option: " + sLabel + " (" + sd + " yds).";
          }

          if (rec.longer) {
            const [lid, ld] = rec.longer;
            const lLabel = CLUB_LABELS[lid] || lid;
            text +=
              " Longer option: " + lLabel + " (" + ld + " yds).";
          }

          clubRecResultEl.textContent = text;
        });
      }

      // Wire goals save button
      if (btnSaveGoals) {
        btnSaveGoals.addEventListener("click", function() {
          const fairwayInput = document.getElementById("goalFairwayInput");
          const girInput = document.getElementById("goalGirInput");
          const puttsInput = document.getElementById("goalPuttsInput");

          if (fairwayInput) {
            const v = parseFloat(fairwayInput.value || "");
            if (!Number.isNaN(v) && v > 0) goals.fairwayPct = v;
          }
          if (girInput) {
            const v = parseFloat(girInput.value || "");
            if (!Number.isNaN(v) && v > 0) goals.girPct = v;
          }
          if (puttsInput) {
            const v = parseFloat(puttsInput.value || "");
            if (!Number.isNaN(v) && v > 0) goals.puttsPerHole = v;
          }

          saveGoals();
          updateGoalsProgress(lastSummaryMetrics);
        });
      }

      // Wire round UI
      if (roundSelect) {
        roundSelect.addEventListener("change", function() {
          // Save current hole on current round before switching
          saveCurrentHoleState();
          const newId = roundSelect.value || "";
          roundsState.activeRoundId = newId || null;
          saveRoundsState();
          applyHoleStateForCurrentHole();
          renderRoundSummary();
          renderHoleHistory();
          renderScoreBubbles();
        });
      }

      if (newRoundBtn) {
        newRoundBtn.addEventListener("click", function() {
          // Save current hole into current round first
          saveCurrentHoleState();
          const round = createNewRound(loadedCourse);
          if (roundSelect) {
            rebuildRoundSelect();
            roundSelect.value = round.id;
          }
          clearHoleControls();
          renderRoundSummary();
          renderHoleHistory();
          renderScoreBubbles();
        });
      }

      if (deleteRoundBtn) {
        deleteRoundBtn.addEventListener("click", function() {
          const active = findActiveRound();
          if (!active) return;
          if (!confirm("Delete this round and all its saved hole data?")) return;

          roundsState.rounds = roundsState.rounds.filter(r => r.id !== active.id);
          roundsState.activeRoundId = roundsState.rounds.length
            ? roundsState.rounds[0].id
            : null;
          saveRoundsState();
          rebuildRoundSelect();
          clearHoleControls();
          renderRoundSummary();
          renderHoleHistory();
          renderScoreBubbles();
        });
      }

      // Auto-save when stats / notes change
      const statFields = [
        fairwayResultEl,
        girResultEl,
        shotShapeEl,
        teeClubEl,
        approachClubEl,
        numPuttsEl,
        numChipsEl,
        numBunkersEl,
        holeScoreEl
      ];
      statFields.forEach(function(el) {
        if (!el) return;
        el.addEventListener("change", function() {
          saveCurrentHoleState();
          renderRoundSummary();
          renderHoleHistory();
          renderScoreBubbles();
        });
      });
      if (holeNotesEl) {
        holeNotesEl.addEventListener("input", function() {
          saveCurrentHoleState();
          renderRoundSummary();
          renderHoleHistory();
          renderScoreBubbles();
        });
      }

      // Clicking score bubbles to jump holes
      if (scoreBubblesEl) {
        scoreBubblesEl.addEventListener("click", function(evt) {
          const bubble = evt.target.closest(".score-bubble");
          if (!bubble) return;
          const holeAttr = bubble.getAttribute("data-hole-num");
          if (!holeAttr || holeAttr === "total") return;
          const num = parseInt(holeAttr, 10);
          if (!Number.isFinite(num) || !loadedHoles.length) return;
          if (num === currentHoleNum) return;
          saveCurrentHoleState();
          currentHoleNum = num;
          renderHoleView();
        });
      }

      // ===== COURSE / HOLE LOADING =====
      function loadCoursesIndex() {
        if (!courseSelect) return;

        courseSelect.innerHTML = "<option value=''>Loading…</option>";

        fetchJSON(COURSES_INDEX_PATH)
          .then(function(courses) {
            if (!Array.isArray(courses) || !courses.length) {
              courseSelect.innerHTML = "<option value=''>No courses found</option>";
              return;
            }

            let html = "<option value=''>Select course…</option>";
            courses.forEach(function(c) {
              html += "<option value='" + c.id + "'>" + (c.name || c.id) + "</option>";
            });
            courseSelect.innerHTML = html;

            if (urlCourse) {
              courseSelect.value = urlCourse;
            }
            if (!courseSelect.value) {
              courseSelect.value = courses[0].id;
            }

            if (courseSelect.value) {
              loadCourse(courseSelect.value);
            }
          })
          .catch(function(err) {
            console.error("[courses] Failed to load index", err);
            courseSelect.innerHTML = "<option value=''>Error loading courses</option>";
          });
      }

      function loadCourse(courseId) {
        const basePath = "data/courses/" + courseId;
        const coursePath = basePath + "/course.json";
        const holesPath = basePath + "/holes.json";

        if (yardageRowEl) {
          yardageRowEl.innerHTML = "<span class='muted'>Loading hole data…</span>";
        }

        if (holeImageEl) {
          holeImageEl.style.display = "none";
          holeImageEl.removeAttribute("src");
        }
        if (holeImageOverlay) {
          holeImageOverlay.style.display = "none";
        }
        if (holeImageCaption) {
          holeImageCaption.textContent = "No image set for this hole yet.";
        }

        fetchJSON(coursePath)
          .then(function(course) {
            loadedCourse = course;
            // update name of active round if it's still the default
            const active = findActiveRound();
            if (active && (!active.name || active.name.indexOf("Practice") === 0)) {
              active.name = createNewRoundName(course);
              saveRoundsState();
              rebuildRoundSelect();
            }
            return fetchJSON(holesPath);
          })
          .then(function(holes) {
            loadedHoles = Array.isArray(holes) ? holes : [];
            maxHole = 0;

            loadedHoles.forEach(function(h, idx) {
              const n = (typeof h.hole === "number") ? h.hole : (idx + 1);
              if (n > maxHole) maxHole = n;
            });
            if (!maxHole) maxHole = loadedHoles.length || 1;
            if (!Number.isFinite(currentHoleNum) || currentHoleNum < 1) currentHoleNum = 1;
            if (currentHoleNum > maxHole) currentHoleNum = maxHole;

            renderHoleOptions();
            renderHoleView();
          })
          .catch(function(err) {
            console.error("[course] Failed to load", courseId, err);
            loadedCourse = null;
            loadedHoles = [];
            maxHole = 0;

            if (courseNameEl) courseNameEl.textContent = "Error loading course";
            if (courseLocEl) courseLocEl.textContent = "";
            if (holeLabelEl) holeLabelEl.textContent = "Hole –";

            if (yardageRowEl) {
              yardageRowEl.innerHTML =
                "<span class='error'>Could not load course data. Check JSON paths.</span>";
            }

            if (scoreBubblesEl) {
              scoreBubblesEl.innerHTML =
                "<span class='muted'>Unable to load holes for this course.</span>";
            }
          });
      }

      function renderHoleOptions() {
        if (!holeSelect) return;
        if (!loadedHoles.length) {
          holeSelect.innerHTML = "<option value=''>No holes</option>";
          return;
        }

        let html = "";
        loadedHoles.forEach(function(h, idx) {
          const n = (typeof h.hole === "number") ? h.hole : (idx + 1);
          html += "<option value='" + n + "'>Hole " + n + "</option>";
        });
        holeSelect.innerHTML = html;

        if (currentHoleNum < 1) currentHoleNum = 1;
        if (currentHoleNum > maxHole) currentHoleNum = maxHole;

        holeSelect.value = String(currentHoleNum);
      }

      function renderHoleView() {
        if (!loadedCourse || !loadedHoles.length) {
          if (scoreBubblesEl) {
            scoreBubblesEl.innerHTML =
              "<span class='muted'>Select a course to see the scorecard.</span>";
          }
          return;
        }

        if (!Number.isFinite(currentHoleNum) || currentHoleNum < 1) currentHoleNum = 1;
        if (currentHoleNum > maxHole) currentHoleNum = maxHole;
        if (holeSelect) holeSelect.value = String(currentHoleNum);

        const hole = loadedHoles.find(function(h, idx) {
          const n = (typeof h.hole === "number") ? h.hole : (idx + 1);
          return n === currentHoleNum;
        }) || loadedHoles[0];

        const resolvedHoleNum = (typeof hole.hole === "number")
          ? hole.hole
          : loadedHoles.indexOf(hole) + 1;

        currentHoleNum = resolvedHoleNum;

        const media = hole.media || {};

        // Course header
        const loc = loadedCourse.location || {};
        let locLine = "";
        if (loc.city) locLine += loc.city;
        if (loc.city && loc.state) locLine += ", ";
        if (loc.state) locLine += loc.state;

        if (courseNameEl) courseNameEl.textContent = loadedCourse.name || "Unnamed Course";
        if (courseLocEl) courseLocEl.textContent = locLine || "";

        const par = (typeof hole.par === "number") ? hole.par : "–";
        const hdcpVal = (hole.handicap === 0 || typeof hole.handicap === "number")
          ? hole.handicap
          : "–";

        if (holeLabelEl) {
          holeLabelEl.textContent = "Hole " + resolvedHoleNum + " · Par " + par + " · Hdcp " + hdcpVal;
        }

        // Prev / Next buttons
        if (prevBtn) {
          prevBtn.disabled = (resolvedHoleNum <= 1);
        }
        if (nextBtn) {
          nextBtn.disabled = (resolvedHoleNum >= maxHole);
        }

        // Yardages
        const tees = Array.isArray(loadedCourse.tees) ? loadedCourse.tees : [];
        if (yardageRowEl) {
          if (!tees.length || !hole.yardages) {
            yardageRowEl.innerHTML = "<span class='muted'>No yardage data yet.</span>";
          } else {
            let html = "";
            tees.forEach(function(t) {
              const teeId = t.id;
              const name = t.name || teeId;
              const color = t.color || "#e5e7eb";
              const y = hole.yardages[teeId];
              const text = (typeof y === "number") ? (y + " yds") : "–";
              html +=
                "<span class='yardage-chip'>" +
                  "<span class='tee-dot' style='background:" + color + ";'></span>" +
                  "<span>" + name + " · " + text + "</span>" +
                "</span>";
            });
            yardageRowEl.innerHTML = html || "<span class='muted'>No yardage data yet.</span>";
          }
        }

        // Hole image (layout) + caption
        if (holeImageEl && holeImageCaption && holeImageOverlay) {
          const holeImgSrc = media.image || hole.image || null;
          if (holeImgSrc) {
            holeImageEl.src = holeImgSrc;
            holeImageEl.style.display = "block";
            holeImageCaption.textContent = media.caption || ("Layout for hole " + resolvedHoleNum);
            holeImageOverlay.style.display = "none";
          } else {
            holeImageEl.removeAttribute("src");
            holeImageEl.style.display = "none";
            holeImageCaption.textContent = "No image set for this hole yet.";
            holeImageOverlay.style.display = "none";
          }
        }

        // Flyover
        if (flyoverBody) {
          if (media.flyover) {
            const lower = media.flyover.toLowerCase();
            if (lower.endsWith(".mp4") || lower.endsWith(".webm") || lower.endsWith(".mov")) {
              flyoverBody.innerHTML =
                "<video controls style='max-width:100%;border-radius:8px;display:block;background:#000;'>" +
                  "<source src='" + media.flyover + "'>" +
                  "Your browser does not support the video tag." +
                "</video>";
            } else {
              flyoverBody.innerHTML =
                "<a href='" + media.flyover +
                "' target='_blank' rel='noopener'>Open flyover for hole " +
                resolvedHoleNum + "</a>";
            }
          } else {
            flyoverBody.textContent = "No flyover set for this hole yet.";
          }
        }

        // Caddy notes
        if (caddyBody) {
          const tips = hole.notes || hole.tips || null;
          let html =
            "<div>Par " + par + " · Hdcp " + hdcpVal + "</div>";

          if (tips) {
            if (Array.isArray(tips)) {
              html += "<ul class='caddy-list'>";
              tips.forEach(function(t) {
                html += "<li>" + t + "</li>";
              });
              html += "</ul>";
            } else if (typeof tips === "string") {
              html += "<ul class='caddy-list'><li>" + tips + "</li></ul>";
            }
          } else {
            html += "<div class='media-note'>No written notes yet. Add a <code>\"notes\"</code> or <code>\"tips\"</code> field for this hole in <code>holes.json</code>.</div>";
          }
          caddyBody.innerHTML = html;
        }

        // Apply saved stats/notes for this round + hole
        const courseId =
          (courseSelect && courseSelect.value) ||
          (loadedCourse && loadedCourse.id) ||
          "unknown";
        applyHoleStateFromRound(courseId, currentHoleNum);

        // GPS map for this hole (tee + green)
        initHoleMap(hole.gps || null);
        startGpsWatch(); // continuous GPS updates

        // Weather for this hole
        updateWeatherForHole(hole);

        // Update summary + history + score strip for this hole
        renderRoundSummary();
        renderHoleHistory();
        renderScoreBubbles();
      }

      // EVENT WIRING
      if (courseSelect) {
        courseSelect.addEventListener("change", function() {
          const newId = courseSelect.value;
          if (!newId) return;
          // save current hole for previous course if we had one
          if (loadedCourse && loadedCourse.id) {
            saveCurrentHoleState(loadedCourse.id);
          } else {
            saveCurrentHoleState();
          }
          currentHoleNum = 1;
          loadCourse(newId);
        });
      }

      if (holeSelect) {
        holeSelect.addEventListener("change", function() {
          // save current before switching hole
          saveCurrentHoleState();
          const val = parseInt(holeSelect.value || "1", 10);
          if (!Number.isFinite(val)) return;
          currentHoleNum = val;
          renderHoleView();
        });
      }

      if (prevBtn) {
        prevBtn.addEventListener("click", function() {
          if (currentHoleNum > 1) {
            saveCurrentHoleState();
            currentHoleNum -= 1;
            renderHoleView();
          }
        });
      }

      if (nextBtn) {
        nextBtn.addEventListener("click", function() {
          if (currentHoleNum < maxHole) {
            saveCurrentHoleState();
            currentHoleNum += 1;
            renderHoleView();
          }
        });
      }

      if (refreshGpsBtn) {
        refreshGpsBtn.addEventListener("click", function() {
          startGpsWatch();   // ensure watch is running
          updateGpsDistance(); // plus an immediate one-shot
        });
      }

            // === Club hint – uses calibration data ===
      const clubSelectEl = document.getElementById("shotClub");
      const clubHintEl = document.getElementById("clubHint");

      function updateClubHint() {
        if (!clubSelectEl || !clubHintEl) return;

        const clubId = clubSelectEl.value;
        if (!clubId) {
          clubHintEl.textContent =
            "Choose a club to see typical carry from your calibration.";
          return;
        }

        const info = CLUB_AVERAGES[clubId];
        if (!info || !info.avg) {
          clubHintEl.textContent =
            clubLabelFromId(clubId) +
            ": no calibration data yet. Record a few shots on the Calibration page.";
          return;
        }

        clubHintEl.textContent =
          `${info.label}: typical carry ~${info.avg.toFixed(1)} yd ` +
          `(${info.count} shot${info.count === 1 ? "" : "s"}, ` +
          `range ${info.min}–${info.max} yd)`;
      }

      if (clubSelectEl) {
        clubSelectEl.addEventListener("change", updateClubHint);
        // Kick once at load so if a value is preselected we show it:
        updateClubHint();
      }


      // INITIAL LOAD
      loadCoursesIndex();
    })();
  </script>
</body>
</html>
