<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hole View – Local Golf Scorebook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --green: #244f3c;
      --green-dark: #163023;
      --gold: #d1a14b;
      --cream: #f5f0e6;
      --bg: #fcfaf6;
      --text: #222;
      --radius: 14px;
      --shadow: 0 8px 20px rgba(0,0,0,0.08);
      --muted: #6b7280;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #fdf7eb 0, #f3efe7 40%, #e7e1d3 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    main {
      flex: 1;
      width: 100%;
      max-width: 1100px;
      margin: 10px auto 16px;
      padding: 0 10px;
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 10px;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: rgba(252,249,242,0.97);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.04);
      padding: 10px 12px;
      backdrop-filter: blur(6px);
    }

    .panel h2 {
      margin: 0 0 6px;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--green-dark);
    }

    .panel small {
      color: var(--muted);
      font-size: 0.78rem;
    }

    .muted {
      color: var(--muted);
      font-size: 0.85rem;
    }

    .error {
      color: #b91c1c;
      font-size: 0.85rem;
      margin-top: 6px;
    }

    .detail-section-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      margin: 8px 0 4px;
    }

    /* HEADER AREA INSIDE PANEL */
    .top-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 8px;
      border-bottom: 1px solid rgba(0,0,0,0.12);
      padding-bottom: 6px;
    }

    .course-meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      justify-content: space-between;
    }

    .course-meta-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .course-title {
      font-weight: 600;
      font-size: 1.05rem;
    }

    .course-location {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .course-controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
    }

    .course-controls label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .course-controls select {
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.2);
      background: #fffbf4;
      font-size: 0.8rem;
    }

    .hole-nav-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .hole-info-label {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .nav-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      align-items: center;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.18);
      padding: 4px 10px;
      font-size: 0.78rem;
      background: #fdf7ea;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-primary {
      background: #244f3c;
      color: #fefcf5;
      border-color: #1a3a2b;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .btn:hover:not(:disabled) {
      filter: brightness(0.98);
    }

    /* YARDAGES */
    .yardage-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .yardage-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(0,0,0,0.08);
      font-size: 0.78rem;
      white-space: nowrap;
    }

    .tee-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.15);
      background: #e5e7eb;
      flex-shrink: 0;
    }

    /* HOLE IMAGE + GPS OVERLAY */
    .hole-image-card {
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #fffdf6;
      padding: 8px 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
      margin-top: 4px;
      font-size: 0.8rem;
    }

    .hole-image-wrapper {
      position: relative;
      border-radius: 10px;
      overflow: hidden;
      max-height: 260px;
      background: #e5e7eb;
    }

    #holeImage {
      width: 100%;
      display: block;
      object-fit: cover;
    }

    .hole-image-overlay {
      position: absolute;
      left: 8px;
      bottom: 8px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.7);
      color: #f9fafb;
      font-size: 0.75rem;
      display: none;
    }

    .hole-image-caption {
      margin-top: 4px;
      font-size: 0.75rem;
      color: var(--muted);
    }

    /* SHOT STATS – ALL DROPDOWNS */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 6px;
      margin-top: 6px;
      font-size: 0.8rem;
    }

    .stats-grid .field {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .stats-grid label {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .stats-grid select {
      padding: 3px 6px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.2);
      background: #fffbf4;
      font-size: 0.8rem;
    }

    .hole-notes {
      width: 100%;
      margin-top: 6px;
      font-size: 0.8rem;
      font-family: inherit;
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.16);
      background: #fffbf4;
      resize: vertical;
      min-height: 52px;
    }

    /* MAP / GPS */
    .map-card {
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #fffdf6;
      padding: 8px 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
      margin-top: 4px;
    }

    .map-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 4px;
    }

    #holeMap {
      height: 300px;
      border-radius: 10px;
      overflow: hidden;
      background: #d1d5db;
    }

    #gpsReadout {
      margin-top: 4px;
      font-size: 0.78rem;
      color: var(--muted);
    }

    /* FLYOVER / CADDY NOTES */
    .media-card {
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #fffdf6;
      padding: 8px 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
      margin-top: 8px;
      font-size: 0.8rem;
    }

    .media-card h3 {
      margin: 0 0 4px;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--green-dark);
    }

    .media-note {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 3px;
    }

    .caddy-list {
      margin: 4px 0 0;
      padding-left: 18px;
      font-size: 0.8rem;
    }

    .caddy-list li {
      margin-bottom: 2px;
    }
  </style>

  <!-- Leaflet (for GPS map) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
</head>
<body>
  <!-- HEADER INJECTION -->
  <div id="header-placeholder"></div>
  <script>
    fetch("header.html")
      .then(res => res.text())
      .then(html => {
        const slot = document.getElementById("header-placeholder");
        if (slot) slot.innerHTML = html;
      })
      .catch(err => console.error("Failed to load header.html:", err));
  </script>

  <main>
    <!-- LEFT: course + hole + shot stats -->
    <section class="panel">
      <div class="top-row">
        <div class="course-meta-row">
          <div class="course-meta-left">
            <div id="courseName" class="course-title">Select a course</div>
            <div id="courseLocation" class="course-location"></div>
          </div>
          <div class="course-controls">
            <label>
              Course:
              <select id="courseSelect">
                <option value="">Loading…</option>
              </select>
            </label>
            <label>
              Hole:
              <select id="holeSelect">
                <option value="">–</option>
              </select>
            </label>
          </div>
        </div>

        <div class="hole-nav-row">
          <div class="hole-info-label" id="holeLabel">Hole –</div>
          <div class="nav-buttons">
            <button type="button" class="btn" id="btnPrevHole">◀ Prev</button>
            <button type="button" class="btn" id="btnNextHole">Next ▶</button>
          </div>
        </div>
      </div>

      <div class="detail-section-title">Yardages</div>
      <div id="yardageRow" class="yardage-row">
        <span class="muted">No course selected.</span>
      </div>

      <!-- HOLE IMAGE + GPS OVERLAY -->
      <div class="detail-section-title">Hole Image & GPS</div>
      <div class="hole-image-card">
        <div class="hole-image-wrapper">
          <img id="holeImage" src="" alt="Hole layout" style="display:none;" />
          <div id="holeImageOverlay" class="hole-image-overlay">
            Waiting for GPS…
          </div>
        </div>
        <div id="holeImageCaption" class="hole-image-caption">
          No image set for this hole yet.
        </div>
      </div>

      <div class="detail-section-title">Shot Stats</div>

      <div class="stats-grid">
        <div class="field">
          <label for="fairwayResult">Fairway</label>
          <select id="fairwayResult">
            <option value="">—</option>
            <option value="hit">Hit</option>
            <option value="miss-left">Miss left</option>
            <option value="miss-right">Miss right</option>
            <option value="na">N/A</option>
          </select>
        </div>

        <div class="field">
          <label for="girResult">GIR</label>
          <select id="girResult">
            <option value="">—</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
            <option value="na">N/A</option>
          </select>
        </div>

        <div class="field">
          <label for="shotShape">Shot shape</label>
          <select id="shotShape">
            <option value="">—</option>
            <option value="straight">Straight</option>
            <option value="draw">Draw</option>
            <option value="fade">Fade</option>
            <option value="hook">Hook</option>
            <option value="slice">Slice</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="field">
          <label for="numPutts">Putts</label>
          <select id="numPutts">
            <option value="">—</option>
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6+</option>
          </select>
        </div>

        <div class="field">
          <label for="numChips">Chips / pitches</label>
          <select id="numChips">
            <option value="">—</option>
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4+</option>
          </select>
        </div>

        <div class="field">
          <label for="numBunkers">Bunker shots</label>
          <select id="numBunkers">
            <option value="">—</option>
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3+</option>
          </select>
        </div>
      </div>

      <textarea
        id="holeNotes"
        class="hole-notes"
        placeholder="Notes specific to this hole today – wind, pin, club choice, etc."
      ></textarea>
    </section>

    <!-- RIGHT: GPS map + flyover + caddy notes -->
    <section class="panel">
      <h2>On-Course View</h2>
      <small id="onCourseSubtitle">Per-hole GPS, flyover, and notes.</small>

      <div class="map-card">
        <div class="map-header-row">
          <div class="detail-section-title" style="margin:0;">GPS Map</div>
          <button type="button" class="btn" id="btnRefreshGPS">Refresh GPS</button>
        </div>
        <div id="holeMap"></div>
        <div id="gpsReadout">
          Select a course and hole to see GPS info.
        </div>
      </div>

      <div class="media-card" id="flyoverCard">
        <h3>Flyover</h3>
        <div id="flyoverBody" class="media-note">
          No flyover set for this hole yet.
        </div>
      </div>

      <div class="media-card" id="caddyCard">
        <h3>Caddy Notes</h3>
        <div id="caddyBody" class="media-note">
          No notes for this hole yet. Add a <code>"notes"</code> or <code>"tips"</code> field for this hole in <code>holes.json</code>.
        </div>
      </div>
    </section>
  </main>

  <script>
    const COURSES_INDEX_PATH = "data/courses.json";

    function fetchJSON(path) {
      return fetch(path).then(function(res) {
        if (!res.ok) throw new Error("HTTP " + res.status + " for " + path);
        return res.json();
      });
    }

    function distanceInYards(lat1, lng1, lat2, lng2) {
      const R = 6371000; // meters
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLng / 2) * Math.sin(dLng / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      const meters = R * c;
      return Math.round(meters * 1.09361); // yards
    }

    // Leaflet map state
    let leafMap = null;
    let playerMarker = null;
    let targetMarker = null;
    let teeMarker = null;
    let teeToGreenLine = null;
    let clickMarker = null;
    let clickToGreenLine = null;

    let currentGpsTarget = null;   // green center
    let currentTeePoint = null;    // tee coordinate (if present)
    let gpsWatchId = null;

    // distance cache so we can build a single readout string
    const lastDistances = {
      teeToGreen: null,
      playerToGreen: null,
      clickToGreen: null
    };

    function updateDistanceReadout() {
      const readout = document.getElementById("gpsReadout");
      if (!readout) return;

      if (!currentGpsTarget) {
        readout.textContent = "No GPS data set for this hole yet.";
        return;
      }

      const parts = [];
      if (lastDistances.teeToGreen != null) {
        parts.push("Tee\u2192Green: " + lastDistances.teeToGreen + " yds");
      }
      if (lastDistances.playerToGreen != null) {
        parts.push("You\u2192Green: " + lastDistances.playerToGreen + " yds");
      }
      if (lastDistances.clickToGreen != null) {
        parts.push("Selected\u2192Green: " + lastDistances.clickToGreen + " yds");
      }

      if (parts.length) {
        readout.textContent = parts.join("  |  ");
      } else {
        readout.textContent =
          "Tap Refresh GPS or click the map to measure distances.";
      }
    }

    function onMapClick(e) {
      if (!leafMap || !currentGpsTarget) return;

      const latlng = e.latlng;

      if (clickMarker) {
        leafMap.removeLayer(clickMarker);
      }
      if (clickToGreenLine) {
        leafMap.removeLayer(clickToGreenLine);
      }

      clickMarker = L.marker(latlng)
        .addTo(leafMap)
        .bindPopup("Selected point");

      clickToGreenLine = L.polyline(
        [
          [latlng.lat, latlng.lng],
          [currentGpsTarget.lat, currentGpsTarget.lng]
        ],
        {
          color: "#d97706",
          weight: 3,
          dashArray: "4 4"
        }
      ).addTo(leafMap);

      const yards = distanceInYards(
        latlng.lat,
        latlng.lng,
        currentGpsTarget.lat,
        currentGpsTarget.lng
      );

      lastDistances.clickToGreen = yards;
      updateDistanceReadout();
    }

    function initHoleMap(gps) {
      const mapEl = document.getElementById("holeMap");
      if (!mapEl) return;

      // reset distance cache specific to this hole
      lastDistances.teeToGreen = null;
      lastDistances.clickToGreen = null;
      // keep playerToGreen; GPS watch will update it to the new target

      const readout = document.getElementById("gpsReadout");

      // Clear previous tee / lines / selected point
      if (leafMap) {
        if (teeMarker) {
          leafMap.removeLayer(teeMarker);
          teeMarker = null;
        }
        if (teeToGreenLine) {
          leafMap.removeLayer(teeToGreenLine);
          teeToGreenLine = null;
        }
        if (clickMarker) {
          leafMap.removeLayer(clickMarker);
          clickMarker = null;
        }
        if (clickToGreenLine) {
          leafMap.removeLayer(clickToGreenLine);
          clickToGreenLine = null;
        }
      }

      if (
        !gps ||
        !gps.greenCenter ||
        typeof gps.greenCenter.lat !== "number" ||
        typeof gps.greenCenter.lng !== "number"
      ) {
        currentGpsTarget = null;
        currentTeePoint = null;
        updateDistanceReadout();
        return;
      }

      const green = gps.greenCenter;
      const tee =
        gps.tee &&
        typeof gps.tee.lat === "number" &&
        typeof gps.tee.lng === "number"
          ? gps.tee
          : null;

      currentGpsTarget = green;
      currentTeePoint = tee;

      if (!leafMap) {
        leafMap = L.map("holeMap");
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap"
        }).addTo(leafMap);
        leafMap.on("click", onMapClick);
      }

      // Fit map to show tee + green if both exist, otherwise center on green
      if (tee) {
        const bounds = L.latLngBounds(
          [tee.lat, tee.lng],
          [green.lat, green.lng]
        );
        leafMap.fitBounds(bounds, { padding: [20, 20] });

        // tee marker
        teeMarker = L.marker([tee.lat, tee.lng])
          .addTo(leafMap)
          .bindPopup("Tee");

        // dashed line tee -> green
        teeToGreenLine = L.polyline(
          [
            [tee.lat, tee.lng],
            [green.lat, green.lng]
          ],
          {
            color: "#244f3c",
            weight: 3,
            dashArray: "6 4"
          }
        ).addTo(leafMap);

        const yards = distanceInYards(
          tee.lat,
          tee.lng,
          green.lat,
          green.lng
        );
        lastDistances.teeToGreen = yards;
      } else {
        leafMap.setView([green.lat, green.lng], 17);
      }

      // green marker
      if (targetMarker) {
        leafMap.removeLayer(targetMarker);
      }
      targetMarker = L.marker([green.lat, green.lng])
        .addTo(leafMap)
        .bindPopup("Green center");

      updateDistanceReadout();
    }

    function startGpsWatch() {
      if (!navigator.geolocation) return;
      if (gpsWatchId !== null) return; // already running

      gpsWatchId = navigator.geolocation.watchPosition(
        function(pos) {
          if (!currentGpsTarget) return;

          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          if (leafMap) {
            if (playerMarker) leafMap.removeLayer(playerMarker);
            playerMarker = L.marker([lat, lng])
              .addTo(leafMap)
              .bindPopup("You");
          }

          const yards = distanceInYards(
            lat,
            lng,
            currentGpsTarget.lat,
            currentGpsTarget.lng
          );
          lastDistances.playerToGreen = yards;
          updateDistanceReadout();

          const overlay = document.getElementById("holeImageOverlay");
          if (overlay) {
            overlay.style.display = "inline-flex";
            overlay.textContent = "You\u2192Green: " + yards + " yds";
          }
        },
        function(err) {
          console.warn("GPS watch error", err);
        },
        { enableHighAccuracy: true }
      );
    }

    // One-shot update (used by Refresh button)
    function updateGpsDistance() {
      if (!currentGpsTarget) {
        updateDistanceReadout();
        return;
      }
      if (!navigator.geolocation) {
        updateDistanceReadout();
        return;
      }

      navigator.geolocation.getCurrentPosition(
        function(pos) {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          if (leafMap) {
            if (playerMarker) leafMap.removeLayer(playerMarker);
            playerMarker = L.marker([lat, lng])
              .addTo(leafMap)
              .bindPopup("You");
          }

          const yards = distanceInYards(
            lat,
            lng,
            currentGpsTarget.lat,
            currentGpsTarget.lng
          );
          lastDistances.playerToGreen = yards;
          updateDistanceReadout();

          const overlay = document.getElementById("holeImageOverlay");
          if (overlay) {
            overlay.style.display = "inline-flex";
            overlay.textContent = "You\u2192Green: " + yards + " yds";
          }
        },
        function(err) {
          console.warn("GPS error", err);
        },
        { enableHighAccuracy: true }
      );
    }

    (function initPage() {
      const params = new URLSearchParams(window.location.search);
      const urlCourse = params.get("course") || "";
      const urlHole = parseInt(params.get("hole") || "1", 10);

      const courseSelect = document.getElementById("courseSelect");
      const holeSelect = document.getElementById("holeSelect");
      const courseNameEl = document.getElementById("courseName");
      const courseLocEl = document.getElementById("courseLocation");
      const holeLabelEl = document.getElementById("holeLabel");
      const yardageRowEl = document.getElementById("yardageRow");
      const flyoverBody = document.getElementById("flyoverBody");
      const caddyBody = document.getElementById("caddyBody");
      const prevBtn = document.getElementById("btnPrevHole");
      const nextBtn = document.getElementById("btnNextHole");
      const refreshGpsBtn = document.getElementById("btnRefreshGPS");

      const holeImageEl = document.getElementById("holeImage");
      const holeImageOverlay = document.getElementById("holeImageOverlay");
      const holeImageCaption = document.getElementById("holeImageCaption");

      let loadedCourse = null;
      let loadedHoles = [];
      let currentHoleNum = Number.isFinite(urlHole) && urlHole > 0 ? urlHole : 1;
      let maxHole = 0;

      function loadCoursesIndex() {
        if (!courseSelect) return;

        courseSelect.innerHTML = "<option value=''>Loading…</option>";

        fetchJSON(COURSES_INDEX_PATH)
          .then(function(courses) {
            if (!Array.isArray(courses) || !courses.length) {
              courseSelect.innerHTML = "<option value=''>No courses found</option>";
              return;
            }

            let html = "<option value=''>Select course…</option>";
            courses.forEach(function(c) {
              html += "<option value='" + c.id + "'>" + (c.name || c.id) + "</option>";
            });
            courseSelect.innerHTML = html;

            if (urlCourse) {
              courseSelect.value = urlCourse;
            }
            if (!courseSelect.value) {
              courseSelect.value = courses[0].id;
            }

            if (courseSelect.value) {
              loadCourse(courseSelect.value);
            }
          })
          .catch(function(err) {
            console.error("[courses] Failed to load index", err);
            courseSelect.innerHTML = "<option value=''>Error loading courses</option>";
          });
      }

      function loadCourse(courseId) {
        const basePath = "data/courses/" + courseId;
        const coursePath = basePath + "/course.json";
        const holesPath = basePath + "/holes.json";

        if (yardageRowEl) {
          yardageRowEl.innerHTML = "<span class='muted'>Loading hole data…</span>";
        }

        if (holeImageEl) {
          holeImageEl.style.display = "none";
          holeImageEl.removeAttribute("src");
        }
        if (holeImageOverlay) {
          holeImageOverlay.style.display = "none";
        }
        if (holeImageCaption) {
          holeImageCaption.textContent = "No image set for this hole yet.";
        }

        Promise.all([fetchJSON(coursePath), fetchJSON(holesPath)])
          .then(function(results) {
            loadedCourse = results[0];
            loadedHoles = Array.isArray(results[1]) ? results[1] : [];
            maxHole = 0;

            loadedHoles.forEach(function(h, idx) {
              const n = typeof h.hole === "number" ? h.hole : idx + 1;
              if (n > maxHole) maxHole = n;
            });

            if (!maxHole) maxHole = loadedHoles.length || 1;
            if (!Number.isFinite(currentHoleNum) || currentHoleNum < 1) currentHoleNum = 1;
            if (currentHoleNum > maxHole) currentHoleNum = maxHole;

            renderHoleOptions();
            renderHoleView();
          })
          .catch(function(err) {
            console.error("[course] Failed to load", courseId, err);
            loadedCourse = null;
            loadedHoles = [];
            maxHole = 0;

            if (courseNameEl) courseNameEl.textContent = "Error loading course";
            if (courseLocEl) courseLocEl.textContent = "";
            if (holeLabelEl) holeLabelEl.textContent = "Hole –";

            if (yardageRowEl) {
              yardageRowEl.innerHTML =
                "<span class='error'>Could not load course data. Check JSON paths.</span>";
            }
          });
      }

      function renderHoleOptions() {
        if (!holeSelect) return;
        if (!loadedHoles.length) {
          holeSelect.innerHTML = "<option value=''>No holes</option>";
          return;
        }

        let html = "";
        loadedHoles.forEach(function(h, idx) {
          const n = typeof h.hole === "number" ? h.hole : idx + 1;
          html += "<option value='" + n + "'>Hole " + n + "</option>";
        });
        holeSelect.innerHTML = html;

        if (currentHoleNum < 1) currentHoleNum = 1;
        if (currentHoleNum > maxHole) currentHoleNum = maxHole;
        holeSelect.value = String(currentHoleNum);
      }

      function renderHoleView() {
        if (!loadedCourse || !loadedHoles.length) return;

        if (!Number.isFinite(currentHoleNum) || currentHoleNum < 1) currentHoleNum = 1;
        if (currentHoleNum > maxHole) currentHoleNum = maxHole;
        if (holeSelect) holeSelect.value = String(currentHoleNum);

        const hole =
          loadedHoles.find(function(h, idx) {
            const n = typeof h.hole === "number" ? h.hole : idx + 1;
            return n === currentHoleNum;
          }) || loadedHoles[0];

        const resolvedHoleNum =
          typeof hole.hole === "number"
            ? hole.hole
            : loadedHoles.indexOf(hole) + 1;

        currentHoleNum = resolvedHoleNum;

        const media = hole.media || {};

        // Course header
        const loc = loadedCourse.location || {};
        let locLine = "";
        if (loc.city) locLine += loc.city;
        if (loc.city && loc.state) locLine += ", ";
        if (loc.state) locLine += loc.state;

        if (courseNameEl) courseNameEl.textContent = loadedCourse.name || "Unnamed Course";
        if (courseLocEl) courseLocEl.textContent = locLine || "";

        const par = typeof hole.par === "number" ? hole.par : "–";
        const hdcpVal =
          hole.handicap === 0 || typeof hole.handicap === "number"
            ? hole.handicap
            : "–";

        if (holeLabelEl) {
          holeLabelEl.textContent =
            "Hole " + resolvedHoleNum + " · Par " + par + " · Hdcp " + hdcpVal;
        }

        if (prevBtn) {
          prevBtn.disabled = resolvedHoleNum <= 1;
        }
        if (nextBtn) {
          nextBtn.disabled = resolvedHoleNum >= maxHole;
        }

        // Yardages
        const tees = Array.isArray(loadedCourse.tees) ? loadedCourse.tees : [];
        if (yardageRowEl) {
          if (!tees.length || !hole.yardages) {
            yardageRowEl.innerHTML =
              "<span class='muted'>No yardage data yet.</span>";
          } else {
            let html = "";
            tees.forEach(function(t) {
              const teeId = t.id;
              const name = t.name || teeId;
              const color = t.color || "#e5e7eb";
              const y = hole.yardages[teeId];
              const text = typeof y === "number" ? y + " yds" : "–";
              html +=
                "<span class='yardage-chip'>" +
                "<span class='tee-dot' style='background:" +
                color +
                ";'></span>" +
                "<span>" +
                name +
                " · " +
                text +
                "</span>" +
                "</span>";
            });
            yardageRowEl.innerHTML =
              html || "<span class='muted'>No yardage data yet.</span>";
          }
        }

        // Hole image + caption
        if (holeImageEl && holeImageCaption && holeImageOverlay) {
          const holeImgSrc = media.image || hole.image || null;
          if (holeImgSrc) {
            holeImageEl.src = holeImgSrc;
            holeImageEl.style.display = "block";
            holeImageCaption.textContent =
              media.caption || "Layout for hole " + resolvedHoleNum;
            holeImageOverlay.style.display = "none";
          } else {
            holeImageEl.removeAttribute("src");
            holeImageEl.style.display = "none";
            holeImageCaption.textContent = "No image set for this hole yet.";
            holeImageOverlay.style.display = "none";
          }
        }

        // Flyover
        if (flyoverBody) {
          if (media.flyover) {
            const lower = media.flyover.toLowerCase();
            if (
              lower.endsWith(".mp4") ||
              lower.endsWith(".webm") ||
              lower.endsWith(".mov")
            ) {
              flyoverBody.innerHTML =
                "<video controls style='max-width:100%;border-radius:8px;display:block;background:#000;'>" +
                "<source src='" +
                media.flyover +
                "'>" +
                "Your browser does not support the video tag." +
                "</video>";
            } else {
              flyoverBody.innerHTML =
                "<a href='" +
                media.flyover +
                "' target='_blank' rel='noopener'>Open flyover for hole " +
                resolvedHoleNum +
                "</a>";
            }
          } else {
            flyoverBody.textContent = "No flyover set for this hole yet.";
          }
        }

        // Caddy notes
        if (caddyBody) {
          const tips = hole.notes || hole.tips || null;
          let html = "<div>Par " + par + " · Hdcp " + hdcpVal + "</div>";

          if (tips) {
            if (Array.isArray(tips)) {
              html += "<ul class='caddy-list'>";
              tips.forEach(function(t) {
                html += "<li>" + t + "</li>";
              });
              html += "</ul>";
            } else if (typeof tips === "string") {
              html += "<ul class='caddy-list'><li>" + tips + "</li></ul>";
            }
          } else {
            html +=
              "<div class='media-note'>No written notes yet. Add a <code>\"notes\"</code> or <code>\"tips\"</code> field for this hole in <code>holes.json</code>.</div>";
          }
          caddyBody.innerHTML = html;
        }

        // GPS map for this hole (tee + green)
        initHoleMap(hole.gps || null);
        startGpsWatch(); // start/keep the continuous GPS updates running
      }

      // EVENT WIRING
      if (courseSelect) {
        courseSelect.addEventListener("change", function() {
          const id = courseSelect.value;
          if (!id) return;
          currentHoleNum = 1;
          loadCourse(id);
        });
      }

      if (holeSelect) {
        holeSelect.addEventListener("change", function() {
          const val = parseInt(holeSelect.value || "1", 10);
          if (!Number.isFinite(val)) return;
          currentHoleNum = val;
          renderHoleView();
        });
      }

      if (prevBtn) {
        prevBtn.addEventListener("click", function() {
          if (currentHoleNum > 1) {
            currentHoleNum -= 1;
            renderHoleView();
          }
        });
      }

      if (nextBtn) {
        nextBtn.addEventListener("click", function() {
          if (currentHoleNum < maxHole) {
            currentHoleNum += 1;
            renderHoleView();
          }
        });
      }

      if (refreshGpsBtn) {
        refreshGpsBtn.addEventListener("click", function() {
          startGpsWatch();   // ensure watch is started
          updateGpsDistance(); // and do an immediate one-shot
        });
      }

      // INITIAL LOAD
      loadCoursesIndex();
    })();
  </script>
</body>
</html>
