<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Course Information – Local Golf Scorebook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --green: #244f3c;
      --green-dark: #163023;
      --gold: #d1a14b;
      --cream: #f5f0e6;
      --bg: #fcfaf6;
      --text: #222;
      --radius: 14px;
      --shadow: 0 8px 20px rgba(0,0,0,0.08);
      --muted: #6b7280;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #fdf7eb 0, #f3efe7 40%, #e7e1d3 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Page header */
    header {
      padding: 12px 16px;
      background: linear-gradient(120deg, var(--green-dark), var(--green));
      color: #fefcf5;
      box-shadow: 0 4px 16px rgba(0,0,0,0.25);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
    }

    header h1 {
      margin: 0;
      font-size: 1.3rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    header p {
      margin: 2px 0 0;
      font-size: 0.85rem;
      opacity: 0.9;
    }

    /* Nav injected from header.html */
    .main-nav {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .main-nav a {
      color: #1b2620;
      background: #fefcf5;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.8rem;
      text-decoration: none;
      border: 1px solid rgba(0,0,0,0.15);
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }

    .main-nav a:hover {
      background: #fff1c2;
    }

    /* Layout for main panels */
    main {
      flex: 1;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 260px minmax(0,1fr);
      gap: 8px;
      padding: 8px 10px 16px;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: rgba(252,249,242,0.97);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.04);
      padding: 10px 12px;
      backdrop-filter: blur(6px);
    }

    .panel h2 {
      margin: 0 0 6px;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--green-dark);
    }

    .panel small {
      color: var(--muted);
      font-size: 0.78rem;
    }

    .muted {
      color: var(--muted);
      font-size: 0.85rem;
    }

    .error {
      color: #b91c1c;
      font-size: 0.85rem;
      margin-top: 6px;
    }

    /* COURSE LIST */
    #coursesList {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 8px;
    }

    .course-pill {
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #fdfaf3;
      display: flex;
      flex-direction: column;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease,
                  border-color 0.12s ease, background 0.12s ease;
      font-size: 0.85rem;
    }

    .course-pill:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      background: #fffaf0;
    }

    .course-pill.active {
      background: #183c2c;
      color: #fdf7eb;
      border-color: rgba(255,255,255,0.4);
    }

    .course-pill-title {
      font-weight: 600;
    }

    .course-pill-meta {
      font-size: 0.75rem;
      opacity: 0.85;
    }

    /* COURSE HEADER / BADGES */
    .course-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
      border-bottom: 1px solid rgba(0,0,0,0.12);
      padding-bottom: 6px;
    }

    .course-header-main h3 {
      margin: 0;
      font-size: 1rem;
    }

    .course-header-main p {
      margin: 2px 0 0;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .course-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .badge {
      padding: 3px 7px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid rgba(0,0,0,0.06);
      background: #f6f1e6;
      color: var(--green-dark);
      white-space: nowrap;
    }

    .badge-pill {
      background: #183c2c;
      color: #fefcf5;
      border-color: transparent;
    }

    .detail-section-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      margin: 8px 0 4px;
    }

    /* TEES INFO */
    #teesInfo {
      margin: 2px 0 8px;
      font-size: 0.8rem;
      color: var(--muted);
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 6px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.03);
    }

    #teesInfo span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(255,255,255,0.95);
      white-space: nowrap;
    }

    .tee-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.15);
      background: #e5e7eb;
      flex-shrink: 0;
    }

    .tee-name-cell {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .tee-name-swatch {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.15);
      flex-shrink: 0;
    }

    /* MAP CARD */
    .map-card {
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #fffdf6;
      padding: 6px 8px 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
      margin-bottom: 4px;
    }

    .map-embed-wrapper {
      border-radius: 8px;
      overflow: hidden;
      height: 280px;
      background: #d1d5db;
    }

    .map-embed-wrapper iframe {
      width: 100%;
      height: 100%;
      border: 0;
    }

    .map-meta {
      margin-top: 4px;
      font-size: 0.75rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .map-meta a {
      text-decoration: underline;
    }

    /* YARDAGE SCORECARD */
    .scorecard-wrapper {
      max-width: 100%;
      overflow-x: auto;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #fffdf6;
      margin-top: 4px;
    }

    table.scorecard {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
      table-layout: fixed;
    }

    .scorecard thead {
      background: #efe4d0;
    }

    .scorecard th,
    .scorecard td {
      padding: 4px 3px;
      text-align: center;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      border-right: 1px solid rgba(0,0,0,0.06);
      white-space: nowrap;
    }

    .scorecard th:first-child,
    .scorecard td:first-child {
      text-align: left;
      font-weight: 600;
      background: #f4ead7;
      position: sticky;
      left: 0;
      z-index: 1;
    }

    .scorecard tr:nth-child(even) td {
      background: rgba(0,0,0,0.01);
    }

    .scorecard tfoot td {
      font-weight: 600;
      background: #e8ddca;
    }

    .scorecard th.total-col,
    .scorecard td.total-col {
      background: #f0e5cf;
      font-weight: 600;
    }

    .scorecard th.out-in-col,
    .scorecard td.out-in-col {
      background: #f2e7d2;
      font-weight: 600;
    }

    /* SCORE ENTRY TABLE */
    .scorecard-wrapper-score {
      margin-top: 6px;
    }

    table.scorecard.scorecard-score {
      border-collapse: separate;
      border-spacing: 0;
    }

    table.scorecard.scorecard-score th,
    table.scorecard.scorecard-score td {
      padding: 0;
      height: 32px;
      text-align: center;
      vertical-align: middle;
    }

    table.scorecard.scorecard-score th:first-child {
      min-width: 70px;
    }

    .score-row-label {
      background: #e9deca;
    }

    table.scorecard.scorecard-score td {
      border-bottom: 1px solid rgba(0,0,0,0.06);
      border-right: 1px solid rgba(0,0,0,0.06);
      background: #fdf7ea;
    }

    table.scorecard.scorecard-score td.score-out,
    table.scorecard.scorecard-score td.score-in,
    table.scorecard.scorecard-score td.score-total {
      font-weight: 600;
    }

    .scorecard-score input.score-input {
      width: 100%;
      height: 100%;
      padding: 0 2px;
      border: none;
      border-radius: 0;
      font-size: 0.8rem;
      text-align: center;
      background: transparent;
      box-sizing: border-box;
    }

    /* ROUND META / NOTES / BUTTONS */
    .round-meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin: 6px 0 4px;
      font-size: 0.8rem;
    }

    .round-meta-row label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .round-meta-row select {
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.2);
      background: #fcfaf2;
      font-size: 0.8rem;
    }

    .round-notes {
      width: 100%;
      margin: 4px 0 6px;
      font-size: 0.8rem;
      font-family: inherit;
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.16);
      background: #fffbf4;
      resize: vertical;
      min-height: 46px;
    }

    .round-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 4px;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.18);
      padding: 4px 10px;
      font-size: 0.78rem;
      background: #fdf7ea;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-primary {
      background: #244f3c;
      color: #fefcf5;
      border-color: #1a3a2b;
    }

    .btn:hover {
      filter: brightness(0.98);
    }

    /* VIRTUAL CADDY */
    .media-stack {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .media-card {
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #fffdf6;
      padding: 8px 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    }

    .media-card h3 {
      margin: 0 0 4px;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--green-dark);
    }

    .media-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
      font-size: 0.75rem;
      flex-wrap: wrap;
    }

    .media-controls label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .media-controls select {
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.2);
      background: #fcfaf2;
      font-size: 0.75rem;
    }

    .media-body {
      font-size: 0.78rem;
      color: var(--muted);
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 4px;
    }

    .media-body img {
      max-width: 100%;
      max-height: 220px;
      border-radius: 8px;
      display: block;
      object-fit: cover;
    }

    .media-body video {
      max-width: 100%;
      max-height: 220px;
      border-radius: 8px;
      display: block;
      background: #000;
    }

    .media-note {
      font-size: 0.72rem;
      color: var(--muted);
      margin-top: 3px;
    }

    /* CADDY NOTES */
    .caddy-header {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 0.8rem;
    }

    .caddy-sub {
      font-size: 0.75rem;
      margin-bottom: 4px;
    }

    .caddy-tips {
      text-align: left;
      padding-left: 16px;
      margin: 4px 0 0;
      font-size: 0.78rem;
    }

    .caddy-tips li {
      margin-bottom: 2px;
    }

    /* SCOREBOOK */
    .scorebook-list {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.8rem;
    }

    .scorebook-empty {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .scorebook-round {
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #fffaf4;
      padding: 6px 8px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      cursor: pointer;
      transition: box-shadow 0.12s ease, transform 0.12s ease;
    }

    .scorebook-round:hover {
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
      transform: translateY(-1px);
    }

    .scorebook-round-header {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      font-weight: 600;
    }

    .scorebook-round-meta {
      color: var(--muted);
      font-size: 0.75rem;
    }

    .scorebook-round-notes {
      color: var(--muted);
      font-size: 0.75rem;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .scorebook-round-header-right {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .scorebook-round-delete {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 0 4px;
      color: var(--muted);
    }

    .scorebook-round-delete:hover {
      color: #b91c1c;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <h1>Local Course Information</h1>
      <p>A lightweight yardage &amp; score book. Data lives in /data; this page just reads it.</p>
      <nav id="header-nav" class="main-nav"></nav>
    </div>
  </header>

  <main>
    <section class="panel">
      <h2>Courses</h2>
      <small>Select a course to view its scorebook, yardages, and media.</small>
      <div id="coursesList"></div>
      <div id="coursesError" class="error" style="display:none;"></div>
    </section>

    <section class="panel">
      <h2>Course Detail</h2>
      <div id="courseDetail">
        <p class="muted">
          Choose a course on the left to see its map, yardage card, virtual caddy, and saved rounds.
        </p>
      </div>
    </section>
  </main>

  <script>
    // Load nav links from header.html into the header nav
    fetch("header.html")
      .then(function(res) {
        if (!res.ok) throw new Error("HTTP " + res.status);
        return res.text();
      })
      .then(function(html) {
        var slot = document.getElementById("header-nav");
        if (slot) slot.innerHTML = html;
      })
      .catch(function(err) {
        console.error("Failed to load header.html:", err);
      });

    // ==== Existing app logic ====

    var COURSES_INDEX_PATH = "data/courses.json";

    function fetchJSON(path) {
      return fetch(path).then(function(res) {
        if (!res.ok) throw new Error("HTTP " + res.status + " for " + path);
        return res.json();
      });
    }

    function loadCourses() {
      var listEl = document.getElementById("coursesList");
      var errorEl = document.getElementById("coursesError");
      listEl.innerHTML = "<p class='muted'>Loading courses…</p>";
      errorEl.style.display = "none";

      fetchJSON(COURSES_INDEX_PATH)
        .then(function(courses) {
          if (!Array.isArray(courses) || !courses.length) {
            listEl.innerHTML = "<p class='muted'>No courses found in data/courses.json.</p>";
            return;
          }
          renderCourseList(courses);
          var first = courses[0];
          if (first) {
            setActiveCoursePill(first.id);
            loadCourse(first.id);
          }
        })
        .catch(function(err) {
          console.error("[courses] Failed to load", err);
          listEl.innerHTML = "";
          errorEl.textContent = "Could not load " + COURSES_INDEX_PATH + " – " + err.message;
          errorEl.style.display = "block";
        });
    }

    function renderCourseList(courses) {
      var listEl = document.getElementById("coursesList");
      listEl.innerHTML = "";

      courses.forEach(function(course) {
        var pill = document.createElement("button");
        pill.type = "button";
        pill.className = "course-pill";
        pill.dataset.courseId = course.id;

        var title = document.createElement("span");
        title.className = "course-pill-title";
        title.textContent = course.name || "Unnamed Course";

        var meta = document.createElement("span");
        meta.className = "course-pill-meta";

        var city = course.city || "";
        var state = course.state || "";
        var holes = course.holes;
        var metaText = city;

        if (city && state) {
          metaText += ", " + state;
        } else if (state) {
          metaText = state;
        }
        if (holes) {
          if (metaText) metaText += " · ";
          metaText += holes + " holes";
        }

        meta.textContent = metaText;
        pill.appendChild(title);
        pill.appendChild(meta);

        pill.addEventListener("click", function() {
          setActiveCoursePill(course.id);
          loadCourse(course.id);
        });

        listEl.appendChild(pill);
      });
    }

    function setActiveCoursePill(courseId) {
      var pills = document.querySelectorAll(".course-pill");
      pills.forEach(function(pill) {
        pill.classList.toggle("active", pill.dataset.courseId === courseId);
      });
    }

    function loadCourse(courseId) {
      var container = document.getElementById("courseDetail");
      container.innerHTML = "<p class='muted'>Loading course data…</p>";

      var basePath = "data/courses/" + courseId;
      var coursePath = basePath + "/course.json";
      var holesPath = basePath + "/holes.json";

      Promise.all([fetchJSON(coursePath), fetchJSON(holesPath)])
        .then(function(results) {
          renderCourseDetail(results[0], results[1], courseId);
        })
        .catch(function(err) {
          console.error("[course] Failed to load", courseId, err);
          container.innerHTML =
            "<p class='error'>Could not load <code>" + courseId +
            "</code>. Check that <code>" + coursePath +
            "</code> and <code>" + holesPath + "</code> exist and are valid JSON.</p>";
        });
    }

    function renderCourseDetail(course, holes, courseId) {
      var container = document.getElementById("courseDetail");
      if (!course) {
        container.innerHTML = "<p class='error'>No course JSON loaded.</p>";
        return;
      }

      var tees = Array.isArray(course.tees) ? course.tees : [];
      var hasHoles = Array.isArray(holes) && holes.length > 0;

      var loc = course.location || {};
      var locLine = "";
      if (loc.city) locLine += loc.city;
      if (loc.city && loc.state) locLine += ", ";
      if (loc.state) locLine += loc.state;
      if (course.holes) {
        if (locLine) locLine += " · ";
        locLine += course.holes + " holes";
      }

      // allow lat/lng either at top-level or in location
      var lat = (typeof loc.lat === "number") ? loc.lat : course.lat;
      var lng = (typeof loc.lng === "number") ? loc.lng : course.lng;

      var notesBadge = course.notes
        ? "<span class='badge'>" + course.notes + "</span>"
        : "";

      var teesInfo = "";
      if (tees.length) {
        tees.forEach(function(t) {
          var color = t.color || "#e5e7eb";
          var name = t.name || t.id;
          teesInfo +=
            "<span>" +
              "<span class='tee-dot' style='background:" + color + ";'></span>" +
              name +
              (t.totalYardage ? " · " + t.totalYardage + " yds" : "") +
            "</span>";
        });
      } else {
        teesInfo = "<span>No tees defined yet in <code>course.json</code>.</span>";
      }

      var mapHtml = "";
      if (typeof lat === "number" && typeof lng === "number") {
        var coords = lat + "," + lng;
        var mapSrc = "https://www.google.com/maps?q=" +
          encodeURIComponent(coords) + "&t=k&output=embed";
        var mapLink = "https://www.google.com/maps?q=" +
          encodeURIComponent(coords) + "&t=k";

        mapHtml =
          "<div class='detail-section-title'>Location &amp; Map</div>" +
          "<div class='map-card'>" +
            "<div class='map-embed-wrapper'>" +
              "<iframe src='" + mapSrc +
              "' loading='lazy' referrerpolicy='no-referrer-when-downgrade'></iframe>" +
            "</div>" +
            "<div class='map-meta'>" +
              "<span>" + (locLine || "") + "</span>" +
              "<a href='" + mapLink +
              "' target='_blank' rel='noopener'>Open in Google Maps</a>" +
            "</div>" +
          "</div>";
      }

      if (!hasHoles) {
        container.innerHTML =
          "<div class='course-header'>" +
            "<div class='course-header-main'>" +
              "<h3>" + (course.name || "Unnamed Course") + "</h3>" +
              "<p>" + (locLine || "") + "</p>" +
            "</div>" +
            "<div class='course-badges'>" +
              "<span class='badge badge-pill'>Local DB</span>" +
              notesBadge +
            "</div>" +
          "</div>" +
          mapHtml +
          "<div class='detail-section-title'>Tees</div>" +
          "<div id='teesInfo'>" + teesInfo + "</div>" +
          "<p class='muted'>No holes.json data yet – once you start filling in hole info, the scorecards and virtual caddy panel will appear.</p>";
        return;
      }

      // ===== build per-hole data =====
      var maxHole = 0;
      holes.forEach(function(h, idx) {
        var num = h.hole || (idx + 1);
        if (num > maxHole) maxHole = num;
      });
      var frontEnd = Math.min(9, maxHole);
      var backStart = frontEnd + 1;
      var hasBack = maxHole > frontEnd;

      var parByHole = {};
      var hdcpByHole = {};
      var yardagesByTeeHole = {};
      var teeTotals = {};
      var mediaByHole = {};
      var caddyByHole = {};
      var parTotal = 0;

      holes.forEach(function(h, idx) {
        var holeNum = h.hole || (idx + 1);
        parByHole[holeNum] = h.par;
        hdcpByHole[holeNum] = h.handicap;

        if (typeof h.par === "number") parTotal += h.par;

        if (h.yardages && typeof h.yardages === "object") {
          tees.forEach(function(t) {
            var teeId = t.id;
            var y = h.yardages[teeId];
            if (typeof y === "number") {
              if (!yardagesByTeeHole[teeId]) yardagesByTeeHole[teeId] = {};
              yardagesByTeeHole[teeId][holeNum] = y;

              if (!teeTotals[teeId]) teeTotals[teeId] = { front: 0, back: 0, total: 0 };
              if (holeNum <= frontEnd) teeTotals[teeId].front += y;
              else teeTotals[teeId].back += y;
              teeTotals[teeId].total += y;
            }
          });
        }

        var m = h.media || {};
        mediaByHole[holeNum] = {
          image: m.imageTee || m.image || m.imageGreen || null,
          flyover: m.flyover || null
        };

        caddyByHole[holeNum] = {
          tips: h.notes || h.tips || null,
          layout: h.layout || null
        };
      });

      // ===== yardage scorecard HTML =====
      var distTable = "";
      var hNum, hb, ph, phb;

      distTable += "<thead><tr><th></th>";
      for (hNum = 1; hNum <= frontEnd; hNum++) {
        distTable += "<th>" + hNum + "</th>";
      }
      if (hasBack) distTable += "<th class='out-in-col'>OUT</th>";
      if (hasBack) {
        for (hb = backStart; hb <= maxHole; hb++) {
          distTable += "<th>" + hb + "</th>";
        }
        distTable += "<th class='out-in-col'>IN</th>";
      }
      distTable += "<th class='total-col'>TOTAL</th></tr></thead><tbody>";

      // Par row
      var parFrontOut = 0, parBackIn = 0;
      distTable += "<tr><th>Par</th>";
      for (hNum = 1; hNum <= frontEnd; hNum++) {
        ph = parByHole[hNum];
        if (typeof ph === "number") parFrontOut += ph;
        distTable += "<td>" + (typeof ph === "number" ? ph : "–") + "</td>";
      }
      if (hasBack) distTable += "<td class='out-in-col'>" + (parFrontOut || "–") + "</td>";
      if (hasBack) {
        for (hb = backStart; hb <= maxHole; hb++) {
          phb = parByHole[hb];
          if (typeof phb === "number") parBackIn += phb;
          distTable += "<td>" + (typeof phb === "number" ? phb : "–") + "</td>";
        }
        distTable += "<td class='out-in-col'>" + (parBackIn || "–") + "</td>";
      }
      distTable += "<td class='total-col'>" + (parTotal || "–") + "</td></tr>";

      // Handicap row
      distTable += "<tr><th>Hdcp</th>";
      var hd, hdb;
      for (hNum = 1; hNum <= frontEnd; hNum++) {
        hd = hdcpByHole[hNum];
        distTable += "<td>" + ((hd === 0 || hd) ? hd : "–") + "</td>";
      }
      if (hasBack) distTable += "<td class='out-in-col'></td>";
      if (hasBack) {
        for (hb = backStart; hb <= maxHole; hb++) {
          hdb = hdcpByHole[hb];
          distTable += "<td>" + ((hdb === 0 || hdb) ? hdb : "–") + "</td>";
        }
        distTable += "<td class='out-in-col'></td>";
      }
      distTable += "<td class='total-col'></td></tr>";

      // Tees rows
      tees.forEach(function(t) {
        var teeId = t.id;
        var teeName = t.name || teeId;
        var teeColor = t.color || "#e5e7eb";
        var totals = teeTotals[teeId] || { front: 0, back: 0, total: 0 };

        distTable += "<tr>";
        distTable += "<th><span class='tee-name-cell'>" +
          "<span class='tee-name-swatch' style='background:" + teeColor + ";'></span>" +
          "<span>" + teeName + "</span></span></th>";

        for (hNum = 1; hNum <= frontEnd; hNum++) {
          var y = yardagesByTeeHole[teeId] && yardagesByTeeHole[teeId][hNum];
          distTable += "<td>" + (typeof y === "number" ? y : "–") + "</td>";
        }

        if (hasBack) distTable += "<td class='out-in-col'>" + (totals.front || "–") + "</td>";

        if (hasBack) {
          for (hb = backStart; hb <= maxHole; hb++) {
            var yb = yardagesByTeeHole[teeId] && yardagesByTeeHole[teeId][hb];
            distTable += "<td>" + (typeof yb === "number" ? yb : "–") + "</td>";
          }
          distTable += "<td class='out-in-col'>" + (totals.back || "–") + "</td>";
        }

        distTable += "<td class='total-col'>" + (totals.total || "–") + "</td></tr>";
      });
      distTable += "</tbody><tfoot><tr><td></td>";
      for (hNum = 1; hNum <= frontEnd; hNum++) distTable += "<td></td>";
      if (hasBack) {
        distTable += "<td class='out-in-col'>Front 9</td>";
        for (hb = backStart; hb <= maxHole; hb++) distTable += "<td></td>";
        distTable += "<td class='out-in-col'>Back 9</td>";
      }
      distTable += "<td class='total-col'>Card</td></tr></tfoot>";

      // Score entry table
      var scoreTable = "<thead><tr><th>Hole</th>";
      for (hNum = 1; hNum <= frontEnd; hNum++) scoreTable += "<th>" + hNum + "</th>";
      if (hasBack) {
        scoreTable += "<th class='out-in-col'>OUT</th>";
        for (hb = backStart; hb <= maxHole; hb++) scoreTable += "<th>" + hb + "</th>";
        scoreTable += "<th class='out-in-col'>IN</th>";
      }
      scoreTable += "<th class='total-col'>TOTAL</th></tr></thead><tbody><tr>";
      scoreTable += "<th class='score-row-label'>Score</th>";

      for (hNum = 1; hNum <= frontEnd; hNum++) {
        scoreTable += "<td><input type='number' min='1' max='20' class='score-input' data-hole='" +
          hNum + "' /></td>";
      }
      if (hasBack) {
        scoreTable += "<td class='out-in-col score-out'></td>";
        for (hb = backStart; hb <= maxHole; hb++) {
          scoreTable += "<td><input type='number' min='1' max='20' class='score-input' data-hole='" +
            hb + "' /></td>";
        }
        scoreTable += "<td class='out-in-col score-in'></td>";
      }
      scoreTable += "<td class='total-col score-total'></td></tr></tbody>";

      // main HTML
      container.innerHTML =
        "<div class='course-header'>" +
          "<div class='course-header-main'>" +
            "<h3>" + (course.name || "Unnamed Course") + "</h3>" +
            "<p>" + (locLine || "") + "</p>" +
          "</div>" +
          "<div class='course-badges'>" +
            "<span class='badge badge-pill'>Local DB</span>" +
            notesBadge +
          "</div>" +
        "</div>" +
        mapHtml +
        "<div class='detail-section-title'>Tees</div>" +
        "<div id='teesInfo'>" + teesInfo + "</div>" +
        "<div class='detail-section-title'>Yardage Card</div>" +
        "<div class='scorecard-wrapper'><table class='scorecard'>" +
          distTable +
        "</table></div>" +
        "<div class='detail-section-title'>Round Score</div>" +
        "<div class='round-meta-row'>" +
          "<label>Tee played:" +
            "<select id='roundTeeSelect'><option value=''>—</option></select>" +
          "</label>" +
        "</div>" +
        "<textarea id='roundNotes' class='round-notes' placeholder='Notes for the day – wind, pin positions, how you played, etc.'></textarea>" +
        "<div class='round-buttons'>" +
          "<button type='button' class='btn' id='btnFinishRound'>Finish round (save to scorebook)</button>" +
          "<button type='button' class='btn' id='btnClearRound'>Clear current round</button>" +
        "</div>" +
        "<div class='scorecard-wrapper scorecard-wrapper-score'>" +
          "<table class='scorecard scorecard-score'>" +
            scoreTable +
          "</table>" +
        "</div>" +
        "<div class='detail-section-title'>Virtual Caddy</div>" +
        "<div class='media-stack'>" +
          "<div class='media-card'>" +
            "<div class='media-controls'>" +
              "<label>Hole <select id='mediaHoleSelect'></select></label>" +
              "<span class='muted' style='font-size:0.7rem;'>Images, flyovers, and notes come from holes.json</span>" +
            "</div>" +
            "<h3>Hole Image</h3>" +
            "<div id='mediaImageArea' class='media-body'>No image set for this hole yet.</div>" +
          "</div>" +
          "<div class='media-card'>" +
            "<h3>Flyover</h3>" +
            "<div id='mediaFlyoverArea' class='media-body'>No flyover set for this hole yet.</div>" +
            "<div class='media-note'>When you add a flyover file or link in <code>media.flyover</code>, it will appear here.</div>" +
          "</div>" +
          "<div class='media-card'>" +
            "<h3>Caddy Notes</h3>" +
            "<div id='caddyNotesArea' class='media-body'>No notes for this hole yet.</div>" +
          "</div>" +
        "</div>" +
        "<div class='detail-section-title'>Scorebook</div>" +
        "<div id='scorebookList' class='scorebook-list'></div>";

      // hook up UI references
      var scoreInputs = container.querySelectorAll(".scorecard-score .score-input");
      var outCell = container.querySelector(".scorecard-score .score-out");
      var inCell = container.querySelector(".scorecard-score .score-in");
      var totalCell = container.querySelector(".scorecard-score .score-total");
      var notesField = container.querySelector("#roundNotes");
      var teeSelect = container.querySelector("#roundTeeSelect");
      var finishBtn = container.querySelector("#btnFinishRound");
      var clearBtn = container.querySelector("#btnClearRound");
      var scorebookListEl = container.querySelector("#scorebookList");
      var holeSelect = container.querySelector("#mediaHoleSelect");

      // populate tee selector
      if (teeSelect && tees.length) {
        tees.forEach(function(t) {
          var opt = document.createElement("option");
          opt.value = t.id;
          opt.textContent = t.name || t.id;
          teeSelect.appendChild(opt);
        });
      }

      // keys for storage
      var baseId = course.id || courseId || "unknown";
      var DRAFT_KEY = "courseDraft_" + baseId;
      var ROUNDS_KEY = "courseRounds_" + baseId;

      function getCurrentSnapshot() {
        var scores = {};
        var outSum = 0, inSum = 0, total = 0;
        var hasAny = false;
        var allFilled = true;

        scoreInputs.forEach(function(input) {
          var hole = parseInt(input.getAttribute("data-hole"), 10);
          var vStr = (input.value || "").trim();
          if (vStr !== "") {
            hasAny = true;
            scores[hole] = vStr;
            var v = parseInt(vStr, 10);
            if (!isNaN(v)) {
              if (hole <= frontEnd) outSum += v;
              else inSum += v;
              total += v;
            }
          } else {
            allFilled = false;
          }
        });

        var notes = (notesField && notesField.value) ? notesField.value : "";
        var teeId = teeSelect ? teeSelect.value : "";

        return {
          scores: scores,
          out: outSum,
          in: inSum,
          total: total,
          hasAny: hasAny,
          allFilled: allFilled && maxHole > 0, // only true if every hole had something
          notes: notes,
          teeId: teeId
        };
      }

      function saveDraft() {
        try {
          var snap = getCurrentSnapshot();
          var payload = {
            scores: snap.scores,
            notes: snap.notes,
            teeId: snap.teeId
          };
          localStorage.setItem(DRAFT_KEY, JSON.stringify(payload));
        } catch (e) {
          console.warn("[draft] failed to save", DRAFT_KEY, e);
        }
      }

      function loadDraft() {
        try {
          var raw = localStorage.getItem(DRAFT_KEY);
          if (!raw) return;
          var obj = JSON.parse(raw);
          if (!obj || typeof obj !== "object") return;

          // scores
          scoreInputs.forEach(function(input) {
            var hole = input.getAttribute("data-hole");
            if (obj.scores && obj.scores.hasOwnProperty(hole)) {
              input.value = obj.scores[hole];
            }
          });

          // notes
          if (notesField && typeof obj.notes === "string") {
            notesField.value = obj.notes;
          }

          // tee
          if (teeSelect && obj.teeId) {
            teeSelect.value = obj.teeId;
          }

          recalcScores(true);
        } catch (e) {
          console.warn("[draft] failed to load", DRAFT_KEY, e);
        }
      }

      function updateFinishButtonState() {
        if (!finishBtn) return;
        var snap = getCurrentSnapshot();
        // always clickable, just highlight when all filled and at least one score
        if (snap.hasAny && snap.allFilled) {
          finishBtn.classList.add("btn-primary");
        } else {
          finishBtn.classList.remove("btn-primary");
        }
      }

      function recalcScores(skipSaveDraft) {
        var snap = getCurrentSnapshot();
        if (outCell) outCell.textContent = snap.out || "";
        if (inCell) inCell.textContent = (hasBack ? (snap.in || "") : "");
        if (totalCell) totalCell.textContent = snap.total || "";
        updateFinishButtonState();
        if (!skipSaveDraft) saveDraft();
      }

      function loadRoundsFromStorage() {
        try {
          var raw = localStorage.getItem(ROUNDS_KEY);
          if (!raw) return [];
          var arr = JSON.parse(raw);
          if (!Array.isArray(arr)) return [];
          return arr;
        } catch (e) {
          console.warn("[rounds] failed to load", ROUNDS_KEY, e);
          return [];
        }
      }

      function saveRoundsToStorage(rounds) {
        try {
          localStorage.setItem(ROUNDS_KEY, JSON.stringify(rounds));
        } catch (e) {
          console.warn("[rounds] failed to save", ROUNDS_KEY, e);
        }
      }

      function formatDate(iso) {
        try {
          var d = new Date(iso);
          if (isNaN(d.getTime())) return iso || "";
          return d.toLocaleDateString(undefined, {
            year: "numeric",
            month: "short",
            day: "numeric"
          });
        } catch {
          return iso || "";
        }
      }

      function teeNameById(id) {
        var t = tees.find(function(tt) { return tt.id === id; });
        return t ? (t.name || t.id) : "";
      }

      function renderScorebook() {
        var rounds = loadRoundsFromStorage();
        if (!rounds.length) {
          scorebookListEl.innerHTML =
            "<div class='scorebook-empty'>No saved rounds yet. Finish a round to add it here.</div>";
          return;
        }

        var html = "";
        rounds.forEach(function(r) {
          var teeName = r.teeName || teeNameById(r.teeId || "");
          var metaParts = [];
          if (teeName) metaParts.push(teeName);
          if (r.complete) metaParts.push("18 holes");
          else metaParts.push("Incomplete");
          if (typeof r.out === "number" && typeof r.in === "number") {
            metaParts.push("OUT " + r.out + " / IN " + r.in);
          }
          var metaText = metaParts.join(" · ");
          var preview = (r.notes || "").replace(/\s+/g," ").trim();
          if (preview.length > 80) preview = preview.slice(0,77) + "…";

          html +=
            "<div class='scorebook-round' data-round-id='" + r.id + "'>" +
              "<div class='scorebook-round-header'>" +
                "<span>" + formatDate(r.dateISO) + "</span>" +
                "<span class='scorebook-round-header-right'>" +
                  (typeof r.total === 'number' ? ("Total " + r.total) : "") +
                  "<button type='button' class='scorebook-round-delete' data-round-id='" + r.id + "' aria-label='Delete round'>&times;</button>" +
                "</span>" +
              "</div>" +
              "<div class='scorebook-round-meta'>" + metaText + "</div>" +
              (preview ? "<div class='scorebook-round-notes'>" + preview + "</div>" : "") +
            "</div>";
        });

        scorebookListEl.innerHTML = html;

        // clicking card loads round
        var items = scorebookListEl.querySelectorAll(".scorebook-round");
        items.forEach(function(item) {
          item.addEventListener("click", function() {
            var roundId = item.getAttribute("data-round-id");
            var rounds = loadRoundsFromStorage();
            var round = rounds.find(function(r) { return String(r.id) === String(roundId); });
            if (round) loadRoundIntoUI(round);
          });
        });

        // clicking × deletes round (with confirm)
        var deleteButtons = scorebookListEl.querySelectorAll(".scorebook-round-delete");
        deleteButtons.forEach(function(btn) {
          btn.addEventListener("click", function(e) {
            e.stopPropagation(); // don't trigger parent click
            var ok = confirm("Delete this round from the scorebook? This cannot be undone.");
            if (!ok) return;

            var roundId = btn.getAttribute("data-round-id");
            var rounds = loadRoundsFromStorage();
            var filtered = rounds.filter(function(r) {
              return String(r.id) !== String(roundId);
            });
            saveRoundsToStorage(filtered);
            renderScorebook();
          });
        });
      }

      function loadRoundIntoUI(round) {
        // scores
        scoreInputs.forEach(function(input) {
          var hole = input.getAttribute("data-hole");
          if (round.scores && round.scores.hasOwnProperty(hole)) {
            input.value = round.scores[hole];
          } else {
            input.value = "";
          }
        });

        // notes
        if (notesField) notesField.value = round.notes || "";

        // tee
        if (teeSelect && round.teeId) teeSelect.value = round.teeId;

        recalcScores(true);
        saveDraft(); // treat loading a round as current draft now
      }

      // event wiring
      scoreInputs.forEach(function(input) {
        input.addEventListener("input", function() {
          recalcScores(false);
        });
      });
      if (notesField) {
        notesField.addEventListener("input", function() {
          recalcScores(false);
        });
      }
      if (teeSelect) {
        teeSelect.addEventListener("change", function() {
          recalcScores(false);
        });
      }

      if (clearBtn) {
        clearBtn.addEventListener("click", function() {
          scoreInputs.forEach(function(input) { input.value = ""; });
          if (notesField) notesField.value = "";
          if (teeSelect) teeSelect.value = "";
          try { localStorage.removeItem(DRAFT_KEY); } catch {}
          recalcScores(true);
        });
      }

      if (finishBtn) {
        finishBtn.addEventListener("click", function() {
          var snap = getCurrentSnapshot();
          var teeId = teeSelect ? teeSelect.value : "";
          var teeName = teeNameById(teeId);

          if (!snap.hasAny && !snap.notes.trim()) {
            // nothing to save
            return;
          }

          var rounds = loadRoundsFromStorage();
          var round = {
            id: Date.now(),
            dateISO: new Date().toISOString(),
            teeId: teeId,
            teeName: teeName,
            scores: snap.scores,
            out: snap.out,
            in: snap.in,
            total: snap.total,
            notes: snap.notes,
            complete: snap.allFilled
          };
          rounds.unshift(round);
          saveRoundsToStorage(rounds);

          // clear draft + UI
          try { localStorage.removeItem(DRAFT_KEY); } catch {}
          scoreInputs.forEach(function(input) { input.value = ""; });
          if (notesField) notesField.value = "";
          if (teeSelect) teeSelect.value = "";

          recalcScores(true);
          renderScorebook();
        });
      }

      // virtual caddy setup
      if (holeSelect) {
        for (hNum = 1; hNum <= maxHole; hNum++) {
          var opt = document.createElement("option");
          opt.value = String(hNum);
          opt.textContent = String(hNum);
          holeSelect.appendChild(opt);
        }

        function updateMediaUI(holeStr) {
          var holeNum = parseInt(holeStr, 10);
          if (!holeNum) holeNum = 1;
          var media = mediaByHole[holeNum] || {};
          var caddy = caddyByHole[holeNum] || {};
          var imgArea = container.querySelector("#mediaImageArea");
          var flyArea = container.querySelector("#mediaFlyoverArea");
          var notesArea = container.querySelector("#caddyNotesArea");

          // image
          if (imgArea) {
            if (media.image) {
              imgArea.innerHTML =
                "<img src='" + media.image +
                "' alt='Hole " + holeNum + " image' />";
            } else {
              imgArea.innerHTML = "No image set for hole " + holeNum + " yet.";
            }
          }

          // flyover
          if (flyArea) {
            if (media.flyover) {
              var lower = media.flyover.toLowerCase();
              if (lower.endsWith(".mp4") || lower.endsWith(".webm") || lower.endsWith(".mov")) {
                flyArea.innerHTML = "<video controls src='" + media.flyover + "'></video>";
              } else {
                flyArea.innerHTML =
                  "<a href='" + media.flyover +
                  "' target='_blank' rel='noopener'>Open flyover for hole " +
                  holeNum + "</a>";
              }
            } else {
              flyArea.innerHTML = "No flyover set for hole " + holeNum + " yet.";
            }
          }

          // caddy notes
          if (notesArea) {
            var parVal = parByHole[holeNum];
            var hdVal = hdcpByHole[holeNum];

            var yardageLines = [];
            tees.forEach(function(t) {
              var teeId = t.id;
              var teeName = t.name || teeId;
              var y =
                yardagesByTeeHole[teeId] &&
                yardagesByTeeHole[teeId][holeNum];
              if (typeof y === "number") {
                yardageLines.push(teeName + ": " + y + " yds");
              }
            });

            var html =
              "<div class='caddy-header'>Hole " + holeNum +
              " · Par " + (typeof parVal === "number" ? parVal : "–") +
              " · Hdcp " + ((hdVal === 0 || hdVal) ? hdVal : "–") +
              "</div>";

            if (yardageLines.length) {
              html += "<div class='caddy-sub'>Yardages – " +
                yardageLines.join(" · ") + "</div>";
            }

            var tips = caddy.tips;
            if (Array.isArray(tips) && tips.length) {
              html += "<ul class='caddy-tips'>";
              tips.forEach(function(t) { html += "<li>" + t + "</li>"; });
              html += "</ul>";
            } else if (typeof tips === "string" && tips.trim().length) {
              html += "<ul class='caddy-tips'><li>" + tips + "</li></ul>";
            } else {
              html += "<p class='muted'>No written notes yet. Add a <code>\"notes\"</code> field for this hole in <code>holes.json</code>.</p>";
            }

            notesArea.innerHTML = html;
          }
        }

        holeSelect.addEventListener("change", function() {
          updateMediaUI(holeSelect.value);
        });
        updateMediaUI(holeSelect.value || "1");
      }

      // initial load: draft + scorebook
      loadDraft();
      renderScorebook();
    }

    loadCourses();
  </script>
</body>
</html>
