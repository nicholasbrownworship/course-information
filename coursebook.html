<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Course Book – Local Golf Scorebook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --green: #244f3c;
      --green-dark: #163023;
      --gold: #d1a14b;
      --cream: #f5f0e6;
      --bg: #fcfaf6;
      --text: #222;
      --radius: 14px;
      --shadow: 0 8px 20px rgba(0,0,0,0.08);
      --muted: #6b7280;
      --panel: #fdf7eb;
      --line: #e7dfcd;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #fdf7eb 0, #f3efe7 40%, #e7e1d3 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    main {
      flex: 1;
      width: 100%;
      margin: 10px auto 16px;
      padding: 0 10px;
      max-width: 1200px;
    }

    h1 {
      margin: 0 0 4px;
      font-size: 1.2rem;
      color: var(--green-dark);
    }

    h2 {
      margin: 0 0 4px;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--green-dark);
    }

    .muted {
      color: var(--muted);
      font-size: 0.85rem;
    }

    .detail-section-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      margin: 8px 0 4px;
    }

    .panel {
      background: transparent;
      border-radius: 0;
      box-shadow: none;
      border: none;
      padding: 10px 0;
      backdrop-filter: none;
    }

    /* Top header row */
    .top-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 8px;
      border-bottom: 1px solid rgba(0,0,0,0.12);
      padding-bottom: 6px;
    }

    .top-row-main {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 6px;
      align-items: flex-start;
    }

    .course-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .course-name {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .course-location {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .course-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      font-size: 0.85rem;
    }

    .course-controls label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .course-controls select {
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.18);
      background: #fffbf4;
      font-size: 0.85rem;
    }

    .course-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
      font-size: 0.75rem;
    }

    .badge {
      border-radius: 999px;
      padding: 2px 7px;
      border: 1px solid rgba(0,0,0,0.12);
      background: rgba(255,255,255,0.9);
      white-space: nowrap;
    }

    .badge-gold {
      border-color: #d97706;
      background: #fffbeb;
      color: #92400e;
    }

    /* Main layout: hole list on left, detail on right */
    .coursebook-layout {
      display: grid;
      grid-template-columns: 220px minmax(0, 1fr);
      gap: 10px;
      align-items: flex-start;
      margin-top: 8px;
    }

    @media (max-width: 800px) {
      .coursebook-layout {
        grid-template-columns: 1fr;
      }
    }

    /* Hole list */
    .hole-list {
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.97);
      padding: 8px 8px 6px;
    }

    .hole-list-header {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .hole-list-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .hole-pill {
      flex: 0 0 calc(25% - 4px);
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.12);
      background: #f3f4f6;
      font-size: 0.75rem;
      padding: 4px 0;
      text-align: center;
      cursor: pointer;
      user-select: none;
    }

    .hole-pill:hover {
      filter: brightness(0.97);
    }

    .hole-pill-active {
      background: var(--green-dark);
      color: #f9fafb;
      border-color: rgba(0,0,0,0.3);
      font-weight: 600;
    }

    .hole-pill span {
      display: block;
      line-height: 1.1;
    }

    /* Detail side */
    .hole-detail {
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.97);
      padding: 8px 10px;
    }

    .hole-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
      margin-bottom: 6px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      padding-bottom: 4px;
    }

    .hole-title {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .hole-sub {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .playing-tee {
      font-size: 0.8rem;
      color: var(--green-dark);
      font-weight: 600;
    }

    /* Yardages row in detail */
    .yardage-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 4px 0;
    }

    .tee-chip {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 2px 7px;
      border-radius: 999px;
      background: #f9fafb;
      border: 1px solid rgba(0,0,0,0.06);
      font-size: 0.75rem;
      white-space: nowrap;
    }

    .tee-chip-selected {
      background: var(--green);
      color: #f9fafb;
      border-color: rgba(0,0,0,0.35);
    }

    .tee-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.15);
      background: #e5e7eb;
      flex-shrink: 0;
    }

    /* Two-column detail body on desktop */
    .hole-detail-body {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 8px;
      margin-top: 4px;
    }

    @media (max-width: 900px) {
      .hole-detail-body {
        grid-template-columns: 1fr;
      }
    }

    .detail-card {
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.06);
      background: #fdfaf4;
      padding: 6px 7px;
      font-size: 0.8rem;
    }

    .detail-card h3 {
      margin: 0 0 4px;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--green-dark);
    }

    .detail-card p {
      margin: 2px 0;
      font-size: 0.8rem;
    }

    .detail-card ul {
      margin: 4px 0 0;
      padding-left: 16px;
      font-size: 0.8rem;
    }

    .detail-card li {
      margin-bottom: 2px;
    }

    /* Image block */
    .hole-image-wrap {
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.06);
      background: #e5e7eb;
    }

    .hole-image-wrap img {
      display: block;
      width: 100%;
      height: auto;
      object-fit: cover;
    }

    .hole-image-caption {
      padding: 3px 5px;
      font-size: 0.75rem;
      color: var(--muted);
      background: rgba(0,0,0,0.03);
    }

    .gps-grid {
      font-size: 0.78rem;
    }

    .gps-row {
      display: flex;
      justify-content: space-between;
      gap: 4px;
      align-items: baseline;
      margin-bottom: 2px;
    }

    .gps-label {
      font-weight: 600;
      color: var(--green-dark);
    }

    .gps-value {
      font-variant-numeric: tabular-nums;
      color: var(--muted);
    }

    .stats-list {
      list-style: none;
      margin: 4px 0 0;
      padding: 0;
      font-size: 0.8rem;
    }

    .stats-list li {
      margin-bottom: 2px;
    }

    .empty-state {
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px dashed rgba(0,0,0,0.16);
      background: rgba(255,255,255,0.96);
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 6px;
    }

    /* Overview under main layout */
    .overview-block {
      margin-top: 10px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.97);
      padding: 8px 10px;
      font-size: 0.8rem;
    }

    .overview-list {
      list-style: none;
      padding: 0;
      margin: 4px 0 0;
    }

    .overview-list li {
      margin-bottom: 3px;
    }

    .tee-totals {
      margin-top: 6px;
      border-top: 1px dashed rgba(0,0,0,0.08);
      padding-top: 4px;
    }

    .tee-total-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
      font-size: 0.78rem;
      margin-bottom: 2px;
    }

    .tee-total-row span {
      white-space: nowrap;
    }

    @media print {
      body {
        background: #ffffff;
      }
      #header-placeholder {
        display: none;
      }
      main {
        max-width: 100%;
        margin: 0;
        padding: 0 8px;
      }
      .panel {
        box-shadow: none;
        border-radius: 0;
        border: none;
        background: #ffffff;
        padding-top: 0;
      }
    }
  </style>
</head>
<body>
  <!-- HEADER INJECTION -->
  <div id="header-placeholder"></div>
  <script>
    fetch("header.html")
      .then(res => res.text())
      .then(html => {
        const slot = document.getElementById("header-placeholder");
        if (slot) slot.innerHTML = html;
      })
      .catch(err => console.error("Failed to load header.html:", err));
  </script>

  <main>
    <section class="panel">
      <div class="top-row">
        <div class="top-row-main">
          <div class="course-meta">
            <h1>Course Book</h1>
            <div id="cbCourseName" class="course-name">Select a course</div>
            <div id="cbCourseLocation" class="course-location"></div>
          </div>
          <div class="course-controls">
            <label>
              Course:
              <select id="cbCourseSelect">
                <option value="">Loading…</option>
              </select>
            </label>
            <label>
              Tee:
              <select id="cbTeeSelect">
                <option value="">Auto</option>
              </select>
            </label>
          </div>
        </div>
        <div class="course-badges" id="cbCourseBadges"></div>
        <div class="muted">
          Tap a hole on the left to see its yardages, notes, green image, GPS, and your typical scoring.
        </div>
      </div>

      <div id="cbMainContent">
        <div class="empty-state">
          Choose a course above to view its yardage book.
        </div>
      </div>
    </section>

    <!-- Course overview under the main layout -->
    <section class="panel">
      <h2>Course Overview</h2>
      <div id="cbOverview" class="overview-block">
        <div class="muted">
          Select a course to see total yardages by tee, total par, and a quick summary of your scoring.
        </div>
      </div>
    </section>
  </main>

  <script>
    const COURSES_INDEX_PATH = "data/courses.json";
    const ROUNDS_STORAGE_KEY = "localGolfScorebook_rounds_v1";
    const TEE_PREF_KEY = "localGolfScorebook_teePref_v1";

    function fetchJSON(path) {
      return fetch(path).then(res => {
        if (!res.ok) throw new Error("HTTP " + res.status + " for " + path);
        return res.json();
      });
    }

    // ===== distance helper for GPS summary =====
    function distanceInYards(lat1, lng1, lat2, lng2) {
      const R = 6371000;
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLng / 2) * Math.sin(dLng / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      const meters = R * c;
      return Math.round(meters * 1.09361);
    }

    // ===== ROUNDS / STATS LOADING =====
    let roundsState = { rounds: [], activeRoundId: null };

    function loadRoundsState() {
      try {
        const raw = localStorage.getItem(ROUNDS_STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== "object") return;
        if (!Array.isArray(parsed.rounds)) return;
        roundsState.rounds = parsed.rounds;
        roundsState.activeRoundId = parsed.activeRoundId || null;
      } catch (e) {
        console.warn("[coursebook] Failed to load rounds", e);
      }
    }

    function makeHoleKey(courseId, holeNum) {
      const cid = courseId || "unknown";
      return cid + ":H" + holeNum;
    }

    function computeHoleStatsForCourse(courseId, maxHole) {
      const stats = {};
      if (!courseId || !roundsState.rounds.length) return stats;

      for (let n = 1; n <= maxHole; n++) {
        stats[n] = {
          count: 0,
          scoreSum: 0,
          fairwayHit: 0,
          fairwayOpp: 0,
          girHit: 0,
          girOpp: 0,
          puttSum: 0,
          puttEntries: 0
        };
      }

      roundsState.rounds.forEach(round => {
        if (!round.holes) return;
        if (round.courseId && round.courseId !== courseId) return;

        for (let n = 1; n <= maxHole; n++) {
          const key = makeHoleKey(courseId, n);
          const data = round.holes[key];
          if (!data) continue;

          const s = stats[n];
          s.count++;

          if (data.score) {
            const val = parseInt(data.score, 10);
            if (!Number.isNaN(val)) s.scoreSum += val;
          }

          if (data.fairwayResult && data.fairwayResult !== "" && data.fairwayResult !== "na") {
            s.fairwayOpp++;
            if (data.fairwayResult === "hit") s.fairwayHit++;
          }

          if (data.girResult && data.girResult !== "" && data.girResult !== "na") {
            s.girOpp++;
            if (data.girResult === "yes") s.girHit++;
          }

          if (data.numPutts) {
            const p = parseInt(data.numPutts, 10);
            if (!Number.isNaN(p)) {
              s.puttSum += p;
              s.puttEntries++;
            }
          }
        }
      });

      return stats;
    }

    // ===== TEE PREFERENCES =====
    let teePrefs = {};

    function loadTeePrefs() {
      try {
        const raw = localStorage.getItem(TEE_PREF_KEY);
        if (!raw) {
          teePrefs = {};
          return;
        }
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === "object") {
          teePrefs = parsed;
        } else {
          teePrefs = {};
        }
      } catch (e) {
        console.warn("[coursebook] Failed to load tee prefs", e);
        teePrefs = {};
      }
    }

    function saveTeePrefs() {
      try {
        localStorage.setItem(TEE_PREF_KEY, JSON.stringify(teePrefs));
      } catch (e) {
        console.warn("[coursebook] Failed to save tee prefs", e);
      }
    }

    function getSelectedTeeIdForCourse(courseId, tees) {
      if (!tees || !tees.length) return null;
      const cid = courseId || "unknown";
      const stored = teePrefs[cid];
      if (stored && tees.some(t => t.id === stored)) return stored;
      return tees[0].id; // default to first tee
    }

    // ===== PAGE STATE =====
    let cbCourseSelect, cbTeeSelect, cbCourseNameEl, cbCourseLocationEl, cbCourseBadgesEl, cbMainContentEl, cbOverviewEl;
    let loadedCourse = null;
    let loadedHoles = [];
    let holeStats = {};
    let currentHoleNum = 1;

    document.addEventListener("DOMContentLoaded", function () {
      cbCourseSelect = document.getElementById("cbCourseSelect");
      cbTeeSelect = document.getElementById("cbTeeSelect");
      cbCourseNameEl = document.getElementById("cbCourseName");
      cbCourseLocationEl = document.getElementById("cbCourseLocation");
      cbCourseBadgesEl = document.getElementById("cbCourseBadges");
      cbMainContentEl = document.getElementById("cbMainContent");
      cbOverviewEl = document.getElementById("cbOverview");

      loadRoundsState();
      loadTeePrefs();
      loadCoursesIndex();
    });

    function loadCoursesIndex() {
      if (!cbCourseSelect) return;
      cbCourseSelect.innerHTML = "<option value=''>Loading…</option>";

      fetchJSON(COURSES_INDEX_PATH)
        .then(courses => {
          if (!Array.isArray(courses) || !courses.length) {
            cbCourseSelect.innerHTML = "<option value=''>No courses found</option>";
            if (cbCourseNameEl) cbCourseNameEl.textContent = "No courses available";
            return;
          }

          let html = "<option value=''>Select course…</option>";
          courses.forEach(c => {
            html += "<option value='" + c.id + "'>" + (c.name || c.id) + "</option>";
          });
          cbCourseSelect.innerHTML = html;

          const params = new URLSearchParams(window.location.search);
          const urlCourse = params.get("course") || "";
          if (urlCourse && courses.some(c => c.id === urlCourse)) {
            cbCourseSelect.value = urlCourse;
          }
          if (!cbCourseSelect.value) {
            cbCourseSelect.value = courses[0].id;
          }

          cbCourseSelect.addEventListener("change", () => {
            if (!cbCourseSelect.value) return;
            loadSingleCourse(cbCourseSelect.value);
          });

          if (cbCourseSelect.value) {
            loadSingleCourse(cbCourseSelect.value);
          }
        })
        .catch(err => {
          console.error("[coursebook] Failed to load courses index", err);
          cbCourseSelect.innerHTML = "<option value=''>Error loading courses</option>";
        });
    }

    function loadSingleCourse(courseId) {
      const basePath = "data/courses/" + courseId;
      const coursePath = basePath + "/course.json";
      const holesPath = basePath + "/holes.json";

      if (cbMainContentEl) {
        cbMainContentEl.innerHTML = "<div class='empty-state'>Loading course data…</div>";
      }
      if (cbCourseNameEl) cbCourseNameEl.textContent = "Loading…";
      if (cbCourseLocationEl) cbCourseLocationEl.textContent = "";
      if (cbCourseBadgesEl) cbCourseBadgesEl.innerHTML = "";

      Promise.all([
        fetchJSON(coursePath).catch(() => null),
        fetchJSON(holesPath).catch(() => [])
      ])
        .then(([course, holes]) => {
          loadedCourse = course || { id: courseId, name: courseId };
          loadedHoles = Array.isArray(holes) ? holes : [];

          // Determine max hole number
          let maxHole = 0;
          loadedHoles.forEach((h, idx) => {
            const n = (typeof h.hole === "number") ? h.hole : (idx + 1);
            if (n > maxHole) maxHole = n;
          });
          if (!maxHole) maxHole = loadedHoles.length || 1;
          holeStats = computeHoleStatsForCourse(loadedCourse.id || courseId, maxHole);

          currentHoleNum = 1;

          renderCourseHeader();
          renderMainLayout();
          renderOverview();
        })
        .catch(err => {
          console.error("[coursebook] Failed to load course bundle", err);
          loadedCourse = null;
          loadedHoles = [];
          holeStats = {};
          if (cbCourseNameEl) cbCourseNameEl.textContent = "Error loading course";
          if (cbCourseLocationEl) cbCourseLocationEl.textContent = "";
          if (cbMainContentEl) {
            cbMainContentEl.innerHTML = "<div class='empty-state'>Could not load course data. Check JSON paths.</div>";
          }
          if (cbOverviewEl) {
            cbOverviewEl.innerHTML =
              "<div class='muted'>No overview available – course data failed to load.</div>";
          }
        });
    }

    function renderCourseHeader() {
      if (!loadedCourse) return;
      const loc = loadedCourse.location || {};
      let locLine = "";
      if (loc.city) locLine += loc.city;
      if (loc.city && loc.state) locLine += ", ";
      if (loc.state) locLine += loc.state;

      if (cbCourseNameEl) cbCourseNameEl.textContent = loadedCourse.name || loadedCourse.id || "Unnamed course";
      if (cbCourseLocationEl) cbCourseLocationEl.textContent = locLine || "";

      const tees = Array.isArray(loadedCourse.tees) ? loadedCourse.tees : [];

      // badges
      if (cbCourseBadgesEl) {
        cbCourseBadgesEl.innerHTML = "";
        let parTotal = 0;
        let parKnown = 0;
        loadedHoles.forEach((h, idx) => {
          if (typeof h.par === "number") {
            parTotal += h.par;
            parKnown++;
          }
        });

        const badges = [];
        if (parKnown) {
          badges.push("Par " + parTotal + " (" + parKnown + " holes)");
        } else if (loadedHoles.length) {
          badges.push("Par not set");
        }
        if (tees.length) {
          badges.push(tees.length + " tee(s)");
        }

        badges.forEach((txt, i) => {
          const span = document.createElement("span");
          span.className = "badge" + (i === 0 ? " badge-gold" : "");
          span.textContent = txt;
          cbCourseBadgesEl.appendChild(span);
        });
      }

      // tee select
      if (cbTeeSelect) {
        cbTeeSelect.innerHTML = "";
        const tees = Array.isArray(loadedCourse.tees) ? loadedCourse.tees : [];
        if (!tees.length) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No tees";
          cbTeeSelect.appendChild(opt);
        } else {
          const selectedId = getSelectedTeeIdForCourse(loadedCourse.id || cbCourseSelect.value, tees);
          tees.forEach(t => {
            const opt = document.createElement("option");
            opt.value = t.id;
            opt.textContent = t.name || t.id;
            cbTeeSelect.appendChild(opt);
          });
          cbTeeSelect.value = selectedId || tees[0].id;

          cbTeeSelect.onchange = function () {
            const cid = loadedCourse.id || cbCourseSelect.value || "unknown";
            teePrefs[cid] = cbTeeSelect.value;
            saveTeePrefs();
            renderHoleDetail(); // re-highlight yardages / playing tee text
          };
        }
      }
    }

    function renderMainLayout() {
      if (!cbMainContentEl) return;

      if (!loadedCourse || !loadedHoles.length) {
        cbMainContentEl.innerHTML =
          "<div class='empty-state'>This course has no hole data yet. Add holes in <code>holes.json</code>.</div>";
        return;
      }

      const layout = document.createElement("div");
      layout.className = "coursebook-layout";

      // Hole list column
      const holeList = document.createElement("aside");
      holeList.className = "hole-list";

      const listHeader = document.createElement("div");
      listHeader.className = "hole-list-header";
      listHeader.textContent = "Holes";
      holeList.appendChild(listHeader);

      const grid = document.createElement("div");
      grid.className = "hole-list-grid";

      // Determine max hole
      let maxHole = 0;
      loadedHoles.forEach((h, idx) => {
        const n = (typeof h.hole === "number") ? h.hole : (idx + 1);
        if (n > maxHole) maxHole = n;
      });
      if (!maxHole) maxHole = loadedHoles.length || 1;

      for (let n = 1; n <= maxHole; n++) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "hole-pill" + (n === currentHoleNum ? " hole-pill-active" : "");
        btn.setAttribute("data-hole", String(n));
        btn.innerHTML = "<span>H" + n + "</span>";
        grid.appendChild(btn);
      }

      grid.addEventListener("click", function (evt) {
        const pill = evt.target.closest(".hole-pill");
        if (!pill) return;
        const n = parseInt(pill.getAttribute("data-hole") || "1", 10);
        if (!Number.isFinite(n) || n === currentHoleNum) return;
        currentHoleNum = n;
        updateHoleListActive();
        renderHoleDetail();
      });

      function updateHoleListActive() {
        const pills = grid.querySelectorAll(".hole-pill");
        pills.forEach(p => {
          const n = parseInt(p.getAttribute("data-hole") || "1", 10);
          if (n === currentHoleNum) {
            p.classList.add("hole-pill-active");
          } else {
            p.classList.remove("hole-pill-active");
          }
        });
      }

      // stash updater so detail render can call it if needed
      holeList._updateActive = updateHoleListActive;

      holeList.appendChild(grid);

      // Detail column
      const detail = document.createElement("section");
      detail.className = "hole-detail";
      detail.id = "holeDetail";

      layout.appendChild(holeList);
      layout.appendChild(detail);

      cbMainContentEl.innerHTML = "";
      cbMainContentEl.appendChild(layout);

      // initial detail render
      renderHoleDetail();
    }

    function getCurrentHoleObject() {
      if (!loadedHoles.length) return null;
      let hole = loadedHoles.find((h, idx) => {
        const n = (typeof h.hole === "number") ? h.hole : (idx + 1);
        return n === currentHoleNum;
      });
      if (!hole && loadedHoles[currentHoleNum - 1]) {
        hole = loadedHoles[currentHoleNum - 1];
      }
      return hole || null;
    }

    function renderHoleDetail() {
      const detail = document.getElementById("holeDetail");
      if (!detail) return;

      if (!loadedCourse || !loadedHoles.length) {
        detail.innerHTML =
          "<div class='empty-state'>No hole data to show.</div>";
        return;
      }

      const hole = getCurrentHoleObject();
      if (!hole) {
        detail.innerHTML =
          "<div class='empty-state'>Could not find data for this hole.</div>";
        return;
      }

      const tees = Array.isArray(loadedCourse.tees) ? loadedCourse.tees : [];
      const courseId = loadedCourse.id || cbCourseSelect.value || "unknown";
      const selectedTeeId = tees.length ? (cbTeeSelect && cbTeeSelect.value) || getSelectedTeeIdForCourse(courseId, tees) : null;

      const resolvedHoleNum = (typeof hole.hole === "number")
        ? hole.hole
        : loadedHoles.indexOf(hole) + 1;

      const par = (typeof hole.par === "number") ? hole.par : "–";
      const hdcpVal = (hole.handicap === 0 || typeof hole.handicap === "number")
        ? hole.handicap
        : "–";

      const yardages = hole.yardages || {};
      const media = hole.media || {};
      const gps = hole.gps || null;

      // My stats for this hole
      const s = holeStats[resolvedHoleNum] || null;

      let statsHtml = "<ul class='stats-list'><li>No stats for this hole yet.</li></ul>";
      if (s && s.count > 0) {
        const avgScore = s.scoreSum ? (s.scoreSum / s.count) : null;
        const fairwayPct = s.fairwayOpp ? Math.round((s.fairwayHit / s.fairwayOpp) * 100) : null;
        const girPct = s.girOpp ? Math.round((s.girHit / s.girOpp) * 100) : null;
        const puttsPerHole = s.puttEntries ? (s.puttSum / s.puttEntries) : null;

        statsHtml = "<ul class='stats-list'>";
        if (avgScore != null) {
          let vsParText = "";
          if (typeof par === "number") {
            const diff = avgScore - par;
            if (diff > 0) vsParText = " (+" + diff.toFixed(1) + ")";
            else if (diff < 0) vsParText = " (" + diff.toFixed(1) + ")";
            else vsParText = " (E)";
          }
          statsHtml += "<li><strong>Avg score:</strong> " + avgScore.toFixed(2) + vsParText + "</li>";
        } else {
          statsHtml += "<li><strong>Avg score:</strong> not enough data</li>";
        }

        if (fairwayPct != null) {
          statsHtml += "<li><strong>Fairways hit:</strong> " + fairwayPct + "% (" + s.fairwayHit + "/" + s.fairwayOpp + ")</li>";
        }
        if (girPct != null) {
          statsHtml += "<li><strong>GIR:</strong> " + girPct + "% (" + s.girHit + "/" + s.girOpp + ")</li>";
        }
        if (puttsPerHole != null) {
          statsHtml += "<li><strong>Putts per hole:</strong> " + puttsPerHole.toFixed(2) + "</li>";
        }

        statsHtml += "</ul>";
      }

      // Yardages row HTML
      let yardRowHtml = "";
      if (tees.length) {
        yardRowHtml += "<div class='yardage-row'>";
        tees.forEach(t => {
          const teeId = t.id;
          const color = t.color || "#e5e7eb";
          const y = (typeof yardages[teeId] === "number") ? yardages[teeId] : null;
          const isSelected = selectedTeeId === teeId;
          yardRowHtml +=
            "<div class='tee-chip" + (isSelected ? " tee-chip-selected" : "") + "'>" +
              "<span class='tee-dot' style='background:" + color + ";'></span>" +
              "<span>" + (t.name || teeId) + (y != null ? (" · " + y + " yds") : " · —") + "</span>" +
            "</div>";
        });
        yardRowHtml += "</div>";
      } else {
        yardRowHtml = "<div class='muted'>No tees defined for this course.</div>";
      }

      // Playing tee text
      let playingTeeText = "";
      if (tees.length && selectedTeeId) {
        const teeObj = tees.find(t => t.id === selectedTeeId) || tees[0];
        const y = (teeObj && typeof yardages[teeObj.id] === "number") ? yardages[teeObj.id] : null;
        playingTeeText =
          "Playing from " +
          (teeObj.name || teeObj.id) +
          (y != null ? " – " + y + " yds" : "");
      }

      // Caddy notes
      const tips = hole.notes || hole.tips || null;
      let notesHtml = "";
      if (Array.isArray(tips)) {
        if (!tips.length) {
          notesHtml =
            "<p class='muted'>No written notes yet. Add a <code>\"notes\"</code> or <code>\"tips\"</code> array for this hole in <code>holes.json</code>.</p>";
        } else {
          notesHtml = "<ul>";
          tips.forEach(t => {
            notesHtml += "<li>" + t + "</li>";
          });
          notesHtml += "</ul>";
        }
      } else if (typeof tips === "string") {
        notesHtml = "<p>" + tips + "</p>";
      } else {
        notesHtml =
          "<p class='muted'>No written notes yet. Add a <code>\"notes\"</code> or <code>\"tips\"</code> field for this hole in <code>holes.json</code>.</p>";
      }

      // GPS summary
      let gpsHtml = "<div class='gps-grid'>";
      if (!gps || (!gps.greenCenter && !gps.tee)) {
        gpsHtml += "<p class='muted'>No GPS data for this hole yet.</p>";
      } else {
        const tee = gps.tee;
        const green = gps.greenCenter;
        let lineDist = null;
        if (tee && green && typeof tee.lat === "number" && typeof tee.lng === "number" &&
            typeof green.lat === "number" && typeof green.lng === "number") {
          lineDist = distanceInYards(tee.lat, tee.lng, green.lat, green.lng);
        }

        if (tee && typeof tee.lat === "number" && typeof tee.lng === "number") {
          gpsHtml +=
            "<div class='gps-row'>" +
              "<span class='gps-label'>Tee:</span>" +
              "<span class='gps-value'>" +
                tee.lat.toFixed(6) + ", " + tee.lng.toFixed(6) +
              "</span>" +
            "</div>";
        }
        if (green && typeof green.lat === "number" && typeof green.lng === "number") {
          gpsHtml +=
            "<div class='gps-row'>" +
              "<span class='gps-label'>Green:</span>" +
              "<span class='gps-value'>" +
                green.lat.toFixed(6) + ", " + green.lng.toFixed(6) +
              "</span>" +
            "</div>";
        }
        if (lineDist != null) {
          gpsHtml +=
            "<div class='gps-row'>" +
              "<span class='gps-label'>Tee → Green:</span>" +
              "<span class='gps-value'>" + lineDist + " yds</span>" +
            "</div>";
        }
      }
      gpsHtml += "</div>";

      // Image
      const greenImg = media.greenImage || media.image || hole.image || null;
      let imgHtml = "";
      if (greenImg) {
        imgHtml =
          "<div class='hole-image-wrap'>" +
            "<img src='" + greenImg + "' alt='Hole " + resolvedHoleNum + " green / layout' />" +
            "<div class='hole-image-caption'>" +
              (media.caption || ("Image for hole " + resolvedHoleNum)) +
            "</div>" +
          "</div>";
      } else {
        imgHtml =
          "<div class='hole-image-wrap'>" +
            "<div class='hole-image-caption'>No image set for this hole yet.</div>" +
          "</div>";
      }

      // Build final HTML
      let html = "";

      html += "<div class='hole-header'>";
      html += "<div>";
      html += "<div class='hole-title'>Hole " + resolvedHoleNum + " · Par " + par + " · Hdcp " + hdcpVal + "</div>";
      html += "<div class='hole-sub'>From your local course data</div>";
      html += "</div>";
      if (playingTeeText) {
        html += "<div class='playing-tee'>" + playingTeeText + "</div>";
      }
      html += "</div>";

      html += yardRowHtml;

      html += "<div class='hole-detail-body'>";
      // Left side: notes + stats
      html += "<div>";
      html += "<div class='detail-card'>";
      html += "<h3>Caddy Notes</h3>";
      html += notesHtml;
      html += "</div>";

      html += "<div class='detail-card' style='margin-top:6px;'>";
      html += "<h3>My Stats on This Hole</h3>";
      html += statsHtml;
      html += "</div>";
      html += "</div>";

      // Right side: image + GPS
      html += "<div>";
      html += "<div class='detail-card'>";
      html += "<h3>Green / Hole Image</h3>";
      html += imgHtml;
      html += "</div>";

      html += "<div class='detail-card' style='margin-top:6px;'>";
      html += "<h3>GPS Summary</h3>";
      html += gpsHtml;
      html += "</div>";
      html += "</div>";

      html += "</div>"; // hole-detail-body

      detail.innerHTML = html;
    }

    function renderOverview() {
      if (!cbOverviewEl) return;

      if (!loadedCourse || !loadedHoles.length) {
        cbOverviewEl.innerHTML =
          "<div class='muted'>Select a course to see its overview.</div>";
        return;
      }

      const tees = Array.isArray(loadedCourse.tees) ? loadedCourse.tees : [];
      const teeTotals = {};
      let parTotal = 0;
      let parKnown = 0;

      loadedHoles.forEach((h, idx) => {
        if (typeof h.par === "number") {
          parTotal += h.par;
          parKnown++;
        }
        const yardages = h.yardages || {};
        tees.forEach(t => {
          const teeId = t.id;
          if (!teeTotals[teeId]) teeTotals[teeId] = 0;
          if (typeof yardages[teeId] === "number") {
            teeTotals[teeId] += yardages[teeId];
          }
        });
      });

      // Course-level scoring summary
      let roundsOnCourse = 0;
      let bestScore = null;
      let worstScore = null;
      let totalScoreAllRounds = 0;

      const courseId = loadedCourse.id || cbCourseSelect.value;

      roundsState.rounds.forEach(round => {
        if (!round.holes) return;
        if (round.courseId && round.courseId !== courseId) return;

        let scoreThisRound = 0;
        let holesThisRound = 0;

        for (const key in round.holes) {
          if (!Object.prototype.hasOwnProperty.call(round.holes, key)) continue;
          const prefix = courseId + ":H";
          if (!key.startsWith(prefix)) continue;
          const data = round.holes[key];
          if (!data || !data.score) continue;

          const s = parseInt(data.score, 10);
          if (Number.isNaN(s)) continue;
          scoreThisRound += s;
          holesThisRound++;
        }

        if (!holesThisRound) return;
        roundsOnCourse++;
        totalScoreAllRounds += scoreThisRound;

        if (bestScore == null || scoreThisRound < bestScore) bestScore = scoreThisRound;
        if (worstScore == null || scoreThisRound > worstScore) worstScore = scoreThisRound;
      });

      let avgScorePerRoundText = "No full-round scoring data yet.";
      if (roundsOnCourse) {
        const avgScore = totalScoreAllRounds / roundsOnCourse;
        let vsParText = "";
        if (parKnown && parTotal > 0) {
          const diff = avgScore - parTotal;
          if (diff > 0) vsParText = " (+" + diff.toFixed(1) + " vs par)";
          else if (diff < 0) vsParText = " (" + diff.toFixed(1) + " vs par)";
          else vsParText = " (even par)";
        }
        avgScorePerRoundText =
          "Average score (based on " + roundsOnCourse + " round" + (roundsOnCourse === 1 ? "" : "s") +
          " with hole scores): " + avgScore.toFixed(1) + vsParText;
      }

      let html = "<div class='overview-block'>";
      html += "<ul class='overview-list'>";

      if (parKnown) {
        html += "<li><strong>Par:</strong> " + parTotal + " (" + parKnown + " holes)</li>";
      } else {
        html += "<li><strong>Par:</strong> not fully set in holes.json</li>";
      }

      if (tees.length) {
        html += "<li><strong>Tees:</strong> " + tees.map(t => t.name || t.id).join(", ") + "</li>";
      } else {
        html += "<li><strong>Tees:</strong> none defined</li>";
      }

      if (roundsOnCourse) {
        html += "<li><strong>Rounds with scoring data:</strong> " + roundsOnCourse + "</li>";
        if (bestScore != null) {
          html += "<li><strong>Best / worst recorded:</strong> " + bestScore + " / " + worstScore + "</li>";
        }
      } else {
        html += "<li><strong>Rounds with scoring data:</strong> none yet</li>";
      }

      html += "<li>" + avgScorePerRoundText + "</li>";
      html += "</ul>";

      if (tees.length) {
        html += "<div class='tee-totals'>";
        html += "<div class='detail-section-title' style='margin:4px 0 3px;'>Total yardage by tee</div>";
        tees.forEach(t => {
          const teeId = t.id;
          const total = teeTotals[teeId] || 0;
          const label = t.name || teeId || "Tee";
          html +=
            "<div class='tee-total-row'>" +
              "<span>" + label + "</span>" +
              "<span>" + (total ? (total + " yds") : "—") + "</span>" +
            "</div>";
        });
        html += "</div>";
      }

      html += "</div>";
      cbOverviewEl.innerHTML = html;
    }
  </script>
</body>
</html>
